
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>The Future Is Now</title>
  <meta name="author" content="Misty De Meo">

  
  <meta name="description" content="My least favourite backtrace is a backtrace that doesn&rsquo;t include my own code. Tigerbrew on OS X 10.4 uses Ruby 1.8.2, which was shipped on &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://mistys-internet.website/blog/posts/2">
  <link href="/blog/favicon.png" rel="icon">
  <link href="/blog/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/blog/atom.xml" rel="alternate" title="The Future Is Now" type="application/atom+xml">
  <script src="/blog/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/blog/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/blog/">The Future Is Now</a></h1>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/blog/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:mistys-internet.website/blog" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/blog/">Blog</a></li>
  <li><a href="/blog/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2015/05/02/reevaluate/">Reevaluate</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-05-02T10:41:08-07:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>2</span><span class='date-suffix'>nd</span>, <span class='date-year'>2015</span></span> <span class='time'>10:41 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>My least favourite backtrace is a backtrace that doesn&rsquo;t include my own code.</p>

<p>Tigerbrew on OS X 10.4 uses <a href="/blog/blog/2013/04/02/adventures-with-ruby-1-8-2/">Ruby 1.8.2</a>, which was shipped on Christmas Day, 2004, and it has more than its fair share of interesting bugs. In today&rsquo;s lesson we break Ruby&rsquo;s stdlib class OpenStruct.</p>

<p>OpenStruct is a simple data structure that provides a JavaScript object-like interface to Ruby hashes. It&rsquo;s essentially a hash that provides getter and setter methods for each defined attribute. For example:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">os</span> <span class="o">=</span> <span class="no">OpenStruct</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'><span class="n">os</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;value&#39;</span>
</span><span class='line'><span class="n">os</span><span class="o">.</span><span class="n">key</span> <span class="c1">#=&gt; &#39;value&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Homebrew uses OpenStruct instances in place of hashes in code which only performs reading and writing of attributes, without using any other hash features. For example, in the <a href="https://github.com/Homebrew/homebrew/blob/8b35d842ec1d5e54418024e8afa4fa4ba4302eeb/Library/Homebrew/cmd/deps.rb#L6-L12"><code>deps</code> command</a>, OpenStruct is used for read-only access to a set of attributes read from ARGV:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">mode</span> <span class="o">=</span> <span class="no">OpenStruct</span><span class="o">.</span><span class="n">new</span><span class="p">(</span>
</span><span class='line'>  <span class="ss">:installed?</span>  <span class="o">=&gt;</span> <span class="no">ARGV</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="s1">&#39;--installed&#39;</span><span class="p">),</span>
</span><span class='line'>  <span class="ss">:tree?</span>       <span class="o">=&gt;</span> <span class="no">ARGV</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="s1">&#39;--tree&#39;</span><span class="p">),</span>
</span><span class='line'>  <span class="ss">:all?</span>        <span class="o">=&gt;</span> <span class="no">ARGV</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="s1">&#39;--all&#39;</span><span class="p">),</span>
</span><span class='line'>  <span class="ss">:topo_order?</span> <span class="o">=&gt;</span> <span class="no">ARGV</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="s1">&#39;-n&#39;</span><span class="p">),</span>
</span><span class='line'>  <span class="ss">:union?</span>      <span class="o">=&gt;</span> <span class="no">ARGV</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="s1">&#39;--union&#39;</span><span class="p">)</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="n">mode</span><span class="o">.</span><span class="n">installed?</span> <span class="o">&amp;&amp;</span> <span class="n">mode</span><span class="o">.</span><span class="n">tree?</span>
</span><span class='line'>  <span class="c1"># ...</span>
</span></code></pre></td></tr></table></div></figure>


<p>The first time I ran <code>brew deps</code> in Tigerbrew, however, I was greeted with this lovely backtrace:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>SyntaxError: (eval):3:in `instance_eval&#39;: compile error
</span><span class='line'>(eval):3: syntax error
</span><span class='line'>        def topo_order?=(x); @table[:topo_order?] = x; end
</span><span class='line'>                       ^
</span><span class='line'>(eval):3: syntax error
</span><span class='line'>    from /usr/lib/ruby/1.8/ostruct.rb:72:in `instance_eval&#39;
</span><span class='line'>    from /usr/lib/ruby/1.8/ostruct.rb:72:in `instance_eval&#39;
</span><span class='line'>    from /usr/lib/ruby/1.8/ostruct.rb:72:in `new_ostruct_member&#39;
</span><span class='line'>    from /usr/lib/ruby/1.8/ostruct.rb:51:in `initialize&#39;
</span><span class='line'>    from /usr/lib/ruby/1.8/ostruct.rb:49:in `each&#39;
</span><span class='line'>    from /usr/lib/ruby/1.8/ostruct.rb:49:in `initialize&#39;
</span></code></pre></td></tr></table></div></figure>


<p>Given that the backtrace includes only stdlib code and nothing I wrote, I wasn&rsquo;t sure how to interpret this until I saw &ldquo;(eval)&rdquo;. It couldn&rsquo;t be, could it&hellip;? Of course it was.</p>

<p>Accessors for attribute of OpenStruct instances are methods, and they are defined by OpenStruct a) whenever a new attribute is assigned, and b) when OpenStruct is initialized with a hash. This is achieved using the method <code>OpenStruct#new_ostruct_member</code><sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup>, which was <a href="https://github.com/ruby/ruby/blob/eed0809a08bf5d2c28349b12c23a33101b7d648e/lib/ostruct.rb#L70-L77">defined like this</a> in Ruby 1.8.2:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">new_ostruct_member</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
</span><span class='line'>  <span class="k">unless</span> <span class="nb">self</span><span class="o">.</span><span class="n">respond_to?</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
</span><span class='line'>    <span class="nb">self</span><span class="o">.</span><span class="n">instance_eval</span> <span class="sx">%{</span>
</span><span class='line'><span class="sx">      def </span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="sx">; @table[:</span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="sx">]; end</span>
</span><span class='line'><span class="sx">      def </span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="sx">=(x); @table[:</span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="sx">] = x; end</span>
</span><span class='line'><span class="sx">    }</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Yes: OpenStruct dynamically defines method names by interpolating the name of the variable into a string and evaluating the string in the context of the object. Unsurprisingly, this is very fragile. In our example, the attributes being defined end with a question mark; <code>#installed?</code> is a valid method name in Ruby, but <code>#installed?=</code> is not, and so a SyntaxError exception is raised inside <code>eval</code>.</p>

<p>This was eventually fixed<sup id="fnref:2"><a href="#fn:2" rel="footnote">2</a></sup>; in <a href="https://github.com/ruby/ruby/blob/a9721a259665149b1b9ff0beabcf5f8dc0136120/lib/ostruct.rb#L166-L174">Ruby 2.2.2&rsquo;s definition</a>, the <code>#define_singleton_method</code> method is used instead; metaprogramming is not limited to the normal naming restrictions, so the unusual setters are defined properly<sup id="fnref:3"><a href="#fn:3" rel="footnote">3</a></sup>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">new_ostruct_member</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
</span><span class='line'>  <span class="nb">name</span> <span class="o">=</span> <span class="nb">name</span><span class="o">.</span><span class="n">to_sym</span>
</span><span class='line'>  <span class="k">unless</span> <span class="nb">respond_to?</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
</span><span class='line'>    <span class="n">define_singleton_method</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span> <span class="p">{</span> <span class="vi">@table</span><span class="o">[</span><span class="nb">name</span><span class="o">]</span> <span class="p">}</span>
</span><span class='line'>    <span class="n">define_singleton_method</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">=&quot;</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">x</span><span class="o">|</span> <span class="n">modifiable</span><span class="o">[</span><span class="nb">name</span><span class="o">]</span> <span class="o">=</span> <span class="n">x</span> <span class="p">}</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="nb">name</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Thankfully, the definiton of the method from modern versions of Ruby is fully compatible with Ruby 1.8.2, so Tigerbrew ships with <a href="https://github.com/mistydemeo/tigerbrew/blob/b63d347ab995697fb54bcaa5bfc75d1865d5e573/Library/Homebrew/extend/tiger.rb#L37-L56">a backported version of <code>OpenStruct#new_ostruct_member</code></a>.</p>
<div class="footnotes">
<hr/>
<ol>
<li id="fn:1">
<p>This sounds like it should be a private method, and is <a href="http://ruby-doc.org/stdlib-1.9.3/libdoc/ostruct/rdoc/OpenStruct.html#method-i-new_ostruct_member">documented</a> as being &ldquo;used  internally&rdquo;, but for some reason this was a public instance method right up until <a href="https://github.com/ruby/ruby/commit/2dafb0f47a7ae70362aea7649b635e97bb33dcf2">Ruby 2.0</a>.<a href="#fnref:1" rev="footnote">&#8617;</a></p></li>
<li id="fn:2">
<p><a href="https://github.com/ruby/ruby/commit/48653d5ef0ed47469d64170d70c8c2a9f21f159e">Close to a year</a> after Ruby 1.8.2 was released.<a href="#fnref:2" rev="footnote">&#8617;</a></p></li>
<li id="fn:3">
<p>These illegal method names can&rsquo;t be called using the normal syntax, but they can be called via metaprogramming using the <a href="http://ruby-doc.org/core-2.2.2/Object.html#method-i-send"><code>#send</code></a> instance method, e.g. <code>os.send "foo?=", "baz"</code><a href="#fnref:3" rev="footnote">&#8617;</a></p></li>
</ol>
</div>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2015/01/02/widescreen-gaming-in-the-90s/">Widescreen Gaming in the 90s</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-01-02T14:02:49-08:00'><span class='date'><span class='date-month'>Jan</span> <span class='date-day'>2</span><span class='date-suffix'>nd</span>, <span class='date-year'>2015</span></span> <span class='time'>2:02 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Most people got their first taste of widescreen gaming with the Wii, Xbox 360, and PS3, but not a lot of people know that companies were experimenting with widescreen all the way back in the fifth console generation (PS1, Saturn, N64). A tiny number of games have full widescreen support, which looks great on modern widescreen TVs.</p>

<h2>Anamorphic widescreen</h2>

<p>(Skip to the next section if you just care about pretty pictures!)</p>

<p>Since there isn&rsquo;t a widescreen resolution in the SDTV standards, all widescreen games used a technique called <a href="https://en.wikipedia.org/wiki/Anamorphic_widescreen">anamorphic widescreen</a><sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup>. In anamorphic widescreen, the game squeezes down a 16:9 scene into 4:3; the TV then stretches the 4:3 image back out to 16:9 for display. For example, take a look at this image from Christmas Nights:</p>

<p><img src="/blog/images/widescreen/Nights_3_wide_unscaled.png"></p>

<p>You can see that the proportions on everything are too thin&mdash;it&rsquo;s very noticeable on Claris. Here&rsquo;s what it looks like stretched out:</p>

<p><img src="/blog/images/widescreen/Nights_2_wide.png"></p>

<p>This shows you a lot more of the game world than you&rsquo;d get in the standard 4:3 mode, but you can see that all of the 2D elements in the scene are displayed with the wrong aspect ratio. This lack of aspect ratio correction for 2D elements is common to most widescreen games of that era. In Nights, for example, you can see that the interface elements and all 2D in-game elements (the tree, the stars in the upper left corner) are displayed at the wrong aspect ratio when playing in widescreen. This hurts some games more than others.<sup id="fnref:2"><a href="#fn:2" rel="footnote">2</a></sup></p>

<h2>Examples</h2>

<h3>Christmas Nights</h3>

<p>Both Christmas Nights and Nights support native widescreen. This is probably one of the most famous widescreen games of the era.</p>

<p><img src="/blog/images/widescreen/Nights_1_narrow.png"></p>

<p><img src="/blog/images/widescreen/Nights_2_wide.png"></p>

<p>Nights benefits enormously from a wider field of view, even though it uses a lot of sprites. Being able to see more of where you&rsquo;re going makes for a much better game.</p>

<h3>Panzer Dragoon Zwei</h3>

<p><img src="/blog/images/widescreen/Panzer_1_narrow.png"></p>

<p><img src="/blog/images/widescreen/Panzer_2_wide.png"></p>

<p>Like Nights, Panzer Zwei has a similar field of view in either mode, with more content displayed on the sides.</p>

<h3>Baroque</h3>

<p>This is an obscure game, but Baroque&rsquo;s spare, gritty low-poly nightmarish landscapes are some of the most beautiful and haunting I&rsquo;ve ever seen. It reminds me a lot of <a href="http://cicadamarionette.com/">Lilith</a>&rsquo;s dreamscapes, like <a href="http://lilithzone.itch.io/oneiric-gardens">Oneiric Gardens</a> and <a href="http://cicadamarionette.com/Games/CryptWorlds/Main.html">Crypt Worlds</a>.</p>

<p><img src="/blog/images/widescreen/Baroque_1_narrow.png"></p>

<p><img src="/blog/images/widescreen/Baroque_2_wide.png"></p>

<p>Baroque makes heavy use of sprites; all of the game&rsquo;s NPCs and enemies are sprites in a 3D space. Unfortunately, that makes it look worse in widescreen than the other games I&rsquo;ve written about.</p>

<h3>Virtua Fighter (32X)</h3>

<p><img src="/blog/images/widescreen/Virtua_1_narrow.png"></p>

<p><img src="/blog/images/widescreen/Virtua_2_wide.png"></p>

<p>This game&rsquo;s almost entirely 3D, so it scales very well; the only major 2D element is the 2D background.</p>

<h2>More</h2>

<p>A more complete list of widescreen games of this generation is available on the <a href="http://www.sega-16.com/forum/showthread.php?25942-5th-Generation-Games-List-Playing-in-Widescreen">Sega-16 forums</a>.</p>
<div class="footnotes">
<hr/>
<ol>
<li id="fn:1">
<p>This is the same technique used by widescreen DVDs and Wii games.<a href="#fnref:1" rev="footnote">&#8617;</a></p></li>
<li id="fn:2">
<p>I&rsquo;ve focused on Sega games for this post; I haven&rsquo;t checked to see whether PS1 or N64 games have the same aspect ratio issues with sprites.<a href="#fnref:2" rev="footnote">&#8617;</a></p></li>
</ol>
</div>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2014/12/05/homebrew-gcc-changes-coming/">Homebrew GCC Changes Coming</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-12-05T18:57:06-08:00'><span class='date'><span class='date-month'>Dec</span> <span class='date-day'>5</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>6:57 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Big GCC changes are a-coming to <a href="http://brew.sh">Homebrew</a>, which will make building your own software against Homebrew-provided GCCs much more reliable. There&rsquo;s going to be a transition period, though, and any software built against GCC will need to be rebuilt against the new package to work. We&rsquo;ll be pushing the changes on <strong>December 12th, 2014</strong>, and this post is here to help you get ready for it!</p>

<p>(This only affects software built using Homebrew&rsquo;s GCC. Any software built using Clang, which is the compiler that Apple ships, will be unaffected. If you don&rsquo;t know what this means: you&rsquo;re probably fine.)</p>

<h2>The problem</h2>

<p>Since Apple provides many of the same libraries as GCC, Homebrew installs GCC to a nonstandard location in order to avoid shadowing those libraries. Homebrew currently installs GCC using the <code>--enable-version-specific-runtime-libs</code> option to sandbox its libraries and headers, which installs libraries into versioned locations like so:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/usr/local/lib/gcc/x86_64-apple-darwin13.4.0/4.9.2/libgfortran.3.dylib</span></code></pre></td></tr></table></div></figure>


<p>Since the full version of GCC is embedded&mdash;including the minor version&mdash;along with the OS version, every minor release is installed to a new location; this breaks any software which has dynamically linked against a previous GCC version&rsquo;s copies of these libraries.</p>

<h2>What&rsquo;s changing</h2>

<p>The new GCC package we are shipping will install GCC libraries to a path containing only the series version of GCC. For example, libgfortran will now be installed to:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/usr/local/lib/gcc/4.9/libgfortran.3.dylib</span></code></pre></td></tr></table></div></figure>


<p>This has several advantages:</p>

<ul>
<li>New releases of GCC 4.9 will be installed to the same path, so software built using GCC 4.9.2 will work with software built using GCC 4.9.3.</li>
<li>The same changes will be applied to the <code>gcc49</code> formula in the <a href="https://github.com/Homebrew/homebrew-versions/">homebrew/versions</a> repository, allowing <code>gcc49</code> to provide the 4.9 libraries when <code>gcc</code> is eventually upgraded to 5.0.</li>
</ul>


<h2>What you need to do</h2>

<h3>If you&rsquo;re a user</h3>

<p>If you have built any software using the Homebrew-installed GCC, you will need to reinstall that software once the package is updated on the 12th.</p>

<h3>If you provide binary packages built using the Homebrew-installed GCC</h3>

<p>If you provide binary packages that were built using the Homebrew-installed GCC, you should rebuild them using the <a href="https://github.com/Homebrew/homebrew/pull/34303">new formula</a> and have them ready for your users on the 12th.</p>

<h3>If you maintain Homebrew formulae that use GCC/GFortran</h3>

<p>If you maintain Homebrew formulae that build using GCC or GFortran, you should consider <a href="https://github.com/Homebrew/homebrew/blob/master/share/doc/homebrew/Formula-Cookbook.md#formulae-revisions">bumping their revisions</a> on the 12th to ensure that users rebuild them against the new GCC package.</p>

<h2>The tl;dr version</h2>

<p>On December 12, 2014, we will push a new GCC package that changes the install location of libraries. Any software you&rsquo;ve built using the old package (for instance, C++ or Fortran software) will no longer work and will need to be reinstalled. If you build packages for distribution using Homebrew&rsquo;s GCC package, make sure you&rsquo;ve built new versions using our new package and have them ready to distribute at that date.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2014/09/10/thank-you/">Thank You, Ada</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-09-10T08:46:54-07:00'><span class='date'><span class='date-month'>Sep</span> <span class='date-day'>10</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>8:46 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://www.ibiblio.org/bess/">Bess Sadler</a>, <a href="http://andromedayelton.com/">Andromeda Yelton</a>, <a href="http://chrisbourg.wordpress.com/">Chris Bourg</a> and <a href="http://matienzo.org/">Mark Matienzo</a> have stepped forward to pledge to <a href="https://adainitiative.org/donate/?campaign=libraries">match up to $5120 of donations</a> to the <a href="http://adainitiative.org/">Ada Initiative</a>, a non-profit organization that supports the participation of women in open source and culture. I completely support this very generous act; the Ada Initiative does <a href="http://adainitiative.org/what-we-do/">incredibly important</a> work, and I&rsquo;m extremely proud of my friends and of the library community for supporting them.</p>

<p>I&rsquo;ve <a href="http://modelviewculture.com/pieces/there-and-back-again">written before</a> about how I stopped pursuing a career in tech in my late teens. I saw few female (or trans) role models in the tech industry; at a time when my self-image and self-identity was its most fragile, I pivoted away from something I saw as too masculine, without room for me. The Ada Initiative&rsquo;s conferences and advocacy work have done a lot to help make the open tech world a more welcoming space.</p>

<p>There are a lot of reasons why women don&rsquo;t enter, or don&rsquo;t stay, in the tech industry. The last few weeks, when <a href="http://www.theguardian.com/technology/2014/sep/01/how-to-attack-a-woman-who-works-in-video-games">harassment campaigns</a> have <a href="http://www.themarysue.com/gamergate-harms-women/">targeted women to drive them out of the video game industry</a>, have made me reflect on how important it is to work to make online communities and conferences safe spaces.</p>

<p>The Ada Initiative&rsquo;s <a href="http://adainitiative.org/what-we-do/conference-policies/">conference policy advocacy work</a> and their <a href="http://geekfeminism.wikia.com/wiki/Conference_anti-harassment">example anti-harassment policy</a> have been instrumental in helping many organizations and projects adopt their own policies. Both the <a href="https://github.com/code4lib/antiharassment-policy">Code4lib anti-harassment policy</a> and the <a href="https://github.com/Homebrew/homebrew/blob/master/CODEOFCONDUCT.md">Homebrew code of conduct</a>, for example, were inspired by and partially based on the Ada Initiative&rsquo;s work. Seeing organizations adopt these policies has done a lot to make me feel comfortable, and given me confidence that both preventing and dealing with these forms of harassment is something that they see as important. My hope is that future generations of women will feel comfortable entering and interacting in these spaces in ways that others may not have in the past.</p>

<p>In just a few years, the Ada Initiative has helped make sure that these policies are becoming the norm and not the exception for conferences and online communities. I&rsquo;m so grateful we have their advocacy; please consider <a href="https://supportada.org/?campaign=libraries">donating</a> to help them do even more great things.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2014/09/10/mind-the-dust/">Mind the Dust</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-09-10T08:42:12-07:00'><span class='date'><span class='date-month'>Sep</span> <span class='date-day'>10</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>8:42 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Please excuse the sparseness! I&rsquo;m in the process of migrating from Wordpress to Octopress; I haven&rsquo;t had time to change the default team or migrate over my older posts.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2013/10/19/no-cpp-precomp-the-compiler-flag-that-time-forgot/">-no-cpp-precomp: The Compiler Flag That Time Forgot</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2013-10-19T22:58:00-07:00'><span class='date'><span class='date-month'>Oct</span> <span class='date-day'>19</span><span class='date-suffix'>th</span>, <span class='date-year'>2013</span></span> <span class='time'>10:58 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I’m often surprised how long software can keep trying to use compatibility features ages after their best-by date.</p>

<p>Now that GCC 4.8 builds on Tiger<sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup>, I’ve been testing as much software with it as I can. When building ncurses using GCC 4.8.1, though, I came across a strange error message:</p>

<blockquote><p>gcc-4.8: error: unrecognized command line option &lsquo;-no-cpp-precomp&rsquo;</p></blockquote>

<p>It built fine with the gcc-4.0 that came with the OS. GCC rarely removes support for flags like this, so I assumed it must be an Apple-only flag. Unfortunately, it wasn’t listed in the manpage at all, and the internet was no help either – the search results were full of users confused about the same build failures, or trying to figure out what it does. All I could find was <a href="http://trac.wxwidgets.org/ticket/14029">confirmation</a> that it’s an obsolete Apple-only flag.</p>

<p>Not finding anything, I decided to find out straight from the horse’s mouth and try source-diving. Luckily Apple publishes the source code for all obsolete versions of their tools at their <a href="http://opensource.apple.com/">Apple Open Source</a> site.</p>

<p>Recent versions of Apple GCC don’t include the flag anywhere in their source. The only place it’s still referenced is in a few configure scripts and changelogs, such as these:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="c"># The spiffy cpp-precomp chokes on some legitimate constructs in GCC</span>
</span><span class='line'><span class="c"># sources; use -no-cpp-precomp to get to GNU cpp.</span>
</span><span class='line'><span class="c"># Apple&#39;s GCC has bugs in designated initializer handling, so disable</span>
</span><span class='line'><span class="c"># that too.</span>
</span><span class='line'><span class="nv">stage1_cflags</span><span class="o">=</span><span class="s2">&quot;-g -no-cpp-precomp -DHAVE_DESIGNATED_INITIALIZERS=0&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>In several releases prior to that, for instance <a href="http://opensource.apple.com/source/gcc/gcc-5493/gcc/gcc.c">gcc-5493</a>, the flag is explicitly mentioned as being retained for compatibility and is a no-op:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>/* APPLE LOCAL cpp-precomp compatibility */
</span><span class='line'>%<span class="o">{</span>precomp:%ecpp-precomp not supported<span class="o">}</span>%<span class="o">{</span>no-cpp-precomp:<span class="o">}</span>%<span class="o">{</span>Wno-precomp:<span class="o">}</span><span class="se">\</span>
</span></code></pre></td></tr></table></div></figure>


<p>The last time it was actually documented was in <a href="http://opensource.apple.com/source/gcc/gcc-1765/gcc/doc/install.texi">gcc-1765</a>&rsquo;s install.texi, shipped as a part of the WWDC 2004 Developer Preview of Xcode, which also provides a hint as to what the flag actually did:</p>

<blockquote><p>It’s a good idea to use the GNU preprocessor instead of Apple’s @file{cpp-precomp} during the first stage of bootstrapping; this is automatic when doing @samp{make bootstrap}, but to do it from the toplevel objdir you will need to say @samp{make CC=’cc -no-cpp-precomp’ bootstrap}.</p></blockquote>

<p>So this partially answers our question: Apple shipped an alternate preprocessor, and -no-cpp-precomp triggers the use of the GCC cpp instead. I can only assume this was a leftover that had yet to be excised, because the flag itself was still a no-op at that time. To actually find a version where the flag does something, we have to go all the way back to the December 2002 developer tools, whose <a href="http://opensource.apple.com/source/gcc/gcc-937.2/gcc/gcc.c">gcc-937.2</a> actually has code that uses the flag. This particular build of GCC is Apple’s version of gcc-2.95, and it appears to be the very last where it had any effect. Interestingly, the #ifdef that guards this particular block of code is “#ifdef NEXT_CPP_PRECOMP” – suggesting that this dates back to NeXT, rather than Apple.</p>

<p>To actually find out what this means, O’Reilly’s <a href="http://shop.oreilly.com/product/9780596003562.do">Mac OS X for Unix Geeks</a>, from September 2002, has a nice explanation in chapter 5:</p>

<blockquote><p>Precompiled header files are binary files that have been generated from ordinary C header files and that have been preprocessed and parsed using cpp-precomp. When such a precompiled header is created, both macros and declarations present in the corresponding ordinary header file are sorted, resulting in a faster compile time, a reduced symbol table size, and consequently, faster lookup. Precompiled header files are given a .p extension and are produced from ordinary header files that end with a .h extension.</p></blockquote>

<p>Chapter 4 also provides a nice explanation of why -no-cpp-precomp was desirable:</p>

<blockquote><p>cpp-precomp is faster than cpp. However, some code may not compile with cpp-precomp. In that case, you should invoke cpp by instructing cc not to use cpp-precomp.</p></blockquote>

<p>So there we have it – -no-cpp-precomp became somewhat widely used in Unix software as a compatibility measure to prevent Apple’s cpp-precomp feature from breaking their headers, and has stuck around more than a decade since the last time it’s actually done anything.</p>
<div class="footnotes">
<hr/>
<ol>
<li id="fn:1">
<p>More on that in a future blog post.<a href="#fnref:1" rev="footnote">&#8617;</a></p></li>
</ol>
</div>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2013/04/09/software-archaeology-apples-cctools/">Software Archaeology: Apple’s Cctools</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2013-04-09T20:08:00-07:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>9</span><span class='date-suffix'>th</span>, <span class='date-year'>2013</span></span> <span class='time'>8:08 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>One of the things I’ve been working on in Tigerbrew is backporting modern Apple build tools. The latest official versions, bundled with Xcode 2.5, are simply too old to be able to build some software. (For example, the latest GCC version available is 4.0.)</p>

<p>In the process, I’ve found some pretty fascinating bits of history littered through the code and makefiles for Apple’s build tools. Here are some findings from Apple’s cctools<sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup> package:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='make'><span class='line'><span class="c"># MacOS X (the default)</span>
</span><span class='line'><span class="c">#  RC_OS is set to macos (the top level makefile does this)</span>
</span><span class='line'><span class="c">#  RC_CFLAGS needs -D\__KODIAK__ when RC_RELEASE is Kodiak (Public Beta),</span>
</span><span class='line'><span class="c">#      to get the Public Beta directory layout.</span>
</span><span class='line'><span class="c">#  RC_CFLAGS needs -D\__GONZO_BUNSEN_BEAKER__ when RC_RELEASE is Gonzo, </span>
</span><span class='line'><span class="c">#      Bunsen or Beaker to get the old directory layout. </span>
</span><span class='line'><span class="c">#  The code is #ifdef&#39;ed with \__Mach30__ is picked up from &lt;mach/mach.h&gt; </span>
</span><span class='line'><span class="c"># Rhapsody </span>
</span><span class='line'><span class="c">#  RC_OS is set to teflon </span>
</span><span class='line'><span class="c">#  RC_CFLAGS needs the additional flag -D__HERA__ </span>
</span><span class='line'><span class="c"># Openstep</span>
</span><span class='line'><span class="c">#  RC_OS is set to nextstep </span>
</span><span class='line'><span class="c">#  RC_CFLAGS needs the additional flag -D__OPENSTEP__ </span>
</span></code></pre></td></tr></table></div></figure>


<p>This comment from near the top of cctools’s Makefile lists some of the valid build targets, which includes:</p>

<ul>
<li>Kodiak, which was the Mac OS X public beta from September, 2000</li>
<li>Gonzo (Developer Preview 4), Bunsen (Developer Preview 3), and Beaker (PR2)</li>
<li>Rhapsody (internal name for the OS X project as a whole), Hera (Mac OS X Server 1.0, released 1999), and teflon (unknown to me)</li>
<li>OPENSTEP, NeXT’s implementation of their own OpenStep API</li>
</ul>


<p>From further down in the same Makefile:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='make'><span class='line'><span class="cp">ifeq &quot;macos&quot; &quot;$(RC_OS)&quot;</span>
</span><span class='line'>  TRIE :<span class="o">=</span> <span class="k">$(</span>shell <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$(RC_MAJOR_RELEASE_TRAIN)&quot;</span> <span class="o">=</span> <span class="s2">&quot;Tiger&quot;</span> <span class="o">]</span> <span class="o">||</span> <span class="se">\</span>
</span><span class='line'>             <span class="o">[</span> <span class="s2">&quot;$(RC_MAJOR_RELEASE_TRAIN)&quot;</span> <span class="o">=</span> <span class="s2">&quot;Leopard&quot;</span> <span class="o">]</span> <span class="o">||</span> <span class="se">\</span>
</span><span class='line'>             <span class="o">[</span> <span class="s2">&quot;$(RC_RELEASE)&quot;</span> <span class="o">=</span> <span class="s2">&quot;Puma&quot;</span>      <span class="o">]</span>  <span class="o">||</span> <span class="se">\</span>
</span><span class='line'>             <span class="o">[</span> <span class="s2">&quot;$(RC_RELEASE)&quot;</span> <span class="o">=</span> <span class="s2">&quot;Jaguar&quot;</span>    <span class="o">]</span>  <span class="o">||</span> <span class="se">\</span>
</span><span class='line'>             <span class="o">[</span> <span class="s2">&quot;$(RC_RELEASE)&quot;</span> <span class="o">=</span> <span class="s2">&quot;Panther&quot;</span>   <span class="o">]</span>  <span class="o">||</span> <span class="se">\</span>
</span><span class='line'>             <span class="o">[</span> <span class="s2">&quot;$(RC_RELEASE)&quot;</span> <span class="o">=</span> <span class="s2">&quot;MuonPrime&quot;</span> <span class="o">]</span>  <span class="o">||</span> <span class="se">\</span>
</span><span class='line'>             <span class="o">[</span> <span class="s2">&quot;$(RC_RELEASE)&quot;</span> <span class="o">=</span> <span class="s2">&quot;MuonSeed&quot;</span>  <span class="o">]</span>  <span class="o">||</span> <span class="se">\</span>
</span><span class='line'>             <span class="o">[</span> <span class="s2">&quot;$(RC_RELEASE)&quot;</span> <span class="o">=</span> <span class="s2">&quot;SUPanWheat&quot;</span> <span class="o">]</span> <span class="o">||</span> <span class="se">\</span>
</span><span class='line'>             <span class="o">[</span> <span class="s2">&quot;$(RC_RELEASE)&quot;</span> <span class="o">=</span> <span class="s2">&quot;Tiger&quot;</span> <span class="o">]</span>      <span class="o">||</span> <span class="se">\</span>
</span><span class='line'>             <span class="o">[</span> <span class="s2">&quot;$(RC_RELEASE)&quot;</span> <span class="o">=</span> <span class="s2">&quot;SUTiSoho&quot;</span> <span class="o">]</span>   <span class="o">||</span> <span class="se">\</span>
</span><span class='line'>             <span class="o">[</span> <span class="s2">&quot;$(RC_RELEASE)&quot;</span> <span class="o">=</span> <span class="s2">&quot;Leopard&quot;</span> <span class="o">]</span>    <span class="o">||</span> <span class="se">\</span>
</span><span class='line'>             <span class="o">[</span> <span class="s2">&quot;$(RC_RELEASE)&quot;</span> <span class="o">=</span> <span class="s2">&quot;Vail&quot;</span> <span class="o">]</span>       <span class="o">||</span> <span class="se">\</span>
</span><span class='line'>             <span class="o">[</span> <span class="s2">&quot;$(RC_RELEASE)&quot;</span> <span class="o">=</span> <span class="s2">&quot;SugarBowl&quot;</span> <span class="o">]</span>  <span class="o">||</span> <span class="se">\</span>
</span><span class='line'>             <span class="o">[</span> <span class="s2">&quot;$(RC_RELEASE)&quot;</span> <span class="o">=</span> <span class="s2">&quot;BigBear&quot;</span> <span class="o">]</span>    <span class="o">||</span> <span class="se">\</span>
</span><span class='line'>             <span class="o">[</span> <span class="s2">&quot;$(RC_RELEASE)&quot;</span> <span class="o">=</span> <span class="s2">&quot;Homewood&quot;</span> <span class="o">]</span>   <span class="o">||</span> <span class="se">\</span>
</span><span class='line'>             <span class="o">[</span> <span class="s2">&quot;$(RC_RELEASE)&quot;</span> <span class="o">=</span> <span class="s2">&quot;Kirkwood&quot;</span> <span class="o">]</span>   <span class="o">||</span> <span class="se">\</span>
</span><span class='line'>             <span class="o">[</span> <span class="s2">&quot;$(RC_RELEASE)&quot;</span> <span class="o">=</span> <span class="s2">&quot;Northstar&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span> <span class="se">\</span>
</span><span class='line'>                <span class="nb">echo</span> <span class="s2">&quot;&quot;</span> <span class="p">;</span> <span class="se">\ </span>
</span></code></pre></td></tr></table></div></figure>


<p>A lot of familiar cats here, along with a couple of early iOS versions (SugarBowl, BigBear) and a lot of names I’m not familiar with. (Please leave a comment if you have any insight!) As far as I know “Vail” was the Mac LC III from 1993 with no NeXT connection, but I’m sure it must be referring to something else.</p>

<p>From elsewhere in the tree, there’s code to support various CPU architectures. Aside from the usual suspects (PPC, i386), there are some other interesting finds:</p>

<ul>
<li>HP/PA, aka PA-RISC, a CPU family from HP; some versions of NeXTSTEP were shipped for this</li>
<li>i860, an Intel CPU used in the NeXTdimension graphics board for NeXT’s computers</li>
<li>M680000, the classic Motorola CPU family, used in the original NeXT computers</li>
<li>M880000, a Motorola CPU family; NeXT considered using this in their original hardware but never shipped a product using it</li>
<li>SPARC, a CPU family from Sun; some versions of NeXTSTEP were shipped for this</li>
</ul>


<p>I find it fascinating that, even now, cctools still carries the (presumably unmaintained) code for all of these architectures Apple no longer uses.</p>
<div class="footnotes">
<hr/>
<ol>
<li id="fn:1">
<p>Apple’s equivalent of binutils.<a href="#fnref:1" rev="footnote">&#8617;</a></p></li>
</ol>
</div>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2013/04/04/tigers-which-is-terrible/">Tiger’s `which` Is Terrible; or, Necessity Is the Mother of Invention</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2013-04-04T07:11:00-07:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>4</span><span class='date-suffix'>th</span>, <span class='date-year'>2013</span></span> <span class='time'>7:11 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>One of the most useful things about running software in unusual configurations is that sometimes it exposes unexpected flaws you never knew you had.</p>

<p>The <code>which</code> utility is one of those commandline niceties you never really think about until it’s not there anymore. While sometimes implemented as a shell builtin<sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup>, it’s also frequently shipped as a standalone utility. Apple’s modern version, which is part of the shell_utils package and crystallized around Snow Leopard, works like this:</p>

<ul>
<li>If the specified tool is found on the path, prints the path to the first version found (e.g., the one the shell would execute), and exits 0.</li>
<li>If the specified tool isn’t found, prints a newline and exits 1.</li>
</ul>


<p>This version of the tool is really useful in shell scripts to determine a) if a program is present, and b) where it’s located, and until fairly recently Homebrew used it extensively. Unfortunately, early on in my work on Tigerbrew, I discovered that Tiger’s version was… deficient. It works like this:</p>

<ul>
<li>If the specified tool is found on the path, prints the path to the first version found, and exits 0.</li>
<li>If the specified tool isn’t found, prints a verbose message to stdout, and exits 0.</li>
</ul>


<p>The lack of a meaningful exit status and the error message on stdout are both pretty poor behaviour for a CLI app, and broke Homebrew’s assumptions about how it should work.</p>

<p>To work around this, I replaced Homebrew’s wrapper function with a two-line native Ruby method for Tigerbrew, like so:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">which</span> <span class="n">cmd</span>
</span><span class='line'>  <span class="n">dir</span> <span class="o">=</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;PATH&#39;</span><span class="o">].</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">find</span> <span class="p">{</span><span class="o">|</span><span class="nb">p</span><span class="o">|</span> <span class="no">File</span><span class="o">.</span><span class="n">executable?</span> <span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">p</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)}</span>
</span><span class='line'>  <span class="no">Pathname</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span> <span class="n">cmd</span><span class="p">))</span> <span class="k">unless</span> <span class="n">dir</span><span class="o">.</span><span class="n">nil?</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>As it turns out, not only does it work better on Tiger, but this method is actually faster<sup id="fnref:2"><a href="#fn:2" rel="footnote">2</a></sup> than shelling out like Homebrew did; process spawning is relatively expensive. As a result, I ended up using the new helper in Homebrew even though it wasn’t strictly necessary.</p>

<p>(And as for the commandline utility, Tigerbrew has a formula for the <a href="https://github.com/mistydemeo/tigerbrew/blob/master/Library/Formula/shell_cmds.rb">shell_cmds</a> collection of utilities.)</p>
<div class="footnotes">
<hr/>
<ol>
<li id="fn:1">
<p>zsh does; bash doesn’t.<a href="#fnref:1" rev="footnote">&#8617;</a></p></li>
<li id="fn:2">
<p>On the millisecond scale, at least.<a href="#fnref:2" rev="footnote">&#8617;</a></p></li>
</ol>
</div>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2013/04/02/adventures-with-ruby-1-8-2/">Adventures With Ruby 1.8.2</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2013-04-02T21:59:00-07:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>2</span><span class='date-suffix'>nd</span>, <span class='date-year'>2013</span></span> <span class='time'>9:59 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Homebrew has always used the version of Ruby which comes with OS X,<sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup> a design decision I decided to keep with Tigerbrew. Tiger comes with Ruby 1.8.2, built on Christmas Day, 2004, and with a version of Ruby that old I went in steeling myself for the inevitable ton of compatibility issues.</p>

<p>On the whole I was pleasantly surprised. Most of what Homebrew uses is provided in exactly the same form, and while there are differences that range from puzzling<sup id="fnref:2"><a href="#fn:2" rel="footnote">2</a></sup> to major<sup id="fnref:3"><a href="#fn:3" rel="footnote">3</a></sup>, pretty much everything Just Works.</p>

<p>Except, at first, for Pathname. Ruby’s Pathname class, which is an object-oriented wrapper around the File and Dir classes, is at the heart of Homebrew’s file management. The first time I tried to install something with the newborn Tigerbrew, I was quickly treated to a strange exception with an equally mysterious backtrace: <code>Errno::ENOTDIR: Not a directory</code>.</p>

<p>Curious, I dug in. I soon discovered that the bug occurred while Homebrew was unlinking an existing version of a package before beginning to install an upgrade. (For those not in the know, Homebrew installs software into isolated versioned prefixes. The active version of a given package is symlinked into the standard <code>/usr/local</code> locations.) Most of the files were linked and unlinked just fine, but a few files caused the method Pathname#unlink to throw an exception every time. Eventually I noticed a pattern — every symlink that Pathname choked on represented a directory. Once I noticed that, it clicked.</p>

<p>For those who don’t know, symlinks are actually treated on the filesystem level as special files containing their target as text. For most operations, symlinks transparently act as their targets. However, applications which hit the filesystem directly will see them as files — even when they point to directories. Since Pathname handles files and directories differently, handing its instance methods off to File or Dir as appropriate, the bug happened something like this:</p>

<ul>
<li>The #unlink method is called on a Pathname object representing a symlink to a directory.</li>
<li>Pathname examines the object to see if it represents a file or directory, in order to determine whether to call File.unlink or Dir.unlink.</li>
<li>In doing so, Pathname follows the symlink to its target and examines the properties <em>of the target</em>.</li>
<li>Seeing that the target is a directory, Pathname calls Dir.unlink <em>on the original symlink</em>.</li>
<li>Dir.unlink raises <code>Errno::ENOTDIR</code> because, of course, the symlink isn’t a directory.</li>
</ul>


<p>The overridden version of the method can be <a href="https://github.com/mistydemeo/tigerbrew/blob/992ec641652097bb619e9a8de153e436f7dbed16/Library/Homebrew/extend/pathname.rb#L476-L490">found here</a>. The rest of Tigerbrew’s current backports are in Tigerbrew’s file <a href="https://github.com/mistydemeo/tigerbrew/blob/master/Library/Homebrew/extend/tiger.rb">extend/tiger.rb</a>, for the curious.</p>
<div class="footnotes">
<hr/>
<ol>
<li id="fn:1">
<p>For predictability, and so the user doesn’t have to install Ruby before installing Homebrew.<a href="#fnref:1" rev="footnote">&#8617;</a></p></li>
<li id="fn:2">
<p>String’s <code>[]</code> operator always returns the sliced character’s ASCII ordinal, not a string.<a href="#fnref:2" rev="footnote">&#8617;</a></p></li>
<li id="fn:3">
<p>File#flock doesn’t exist in any form.<a href="#fnref:3" rev="footnote">&#8617;</a></p></li>
</ol>
</div>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2013/04/01/introducing-tigerbrew/">Introducing Tigerbrew</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2013-04-01T19:21:00-07:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>1</span><span class='date-suffix'>st</span>, <span class='date-year'>2013</span></span> <span class='time'>7:21 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Some of you may know that my other gig is <a href="http://brew.sh/">Homebrew</a>, the package manager for Mac OS X. Over the last few months, I’ve been spending some time on a fork of Homebrew that’s starting to become usable enough that I think it’s ready to be announced.</p>

<p>When I was attending the AMIA<sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup> conference in December, my partner and I were travelling together; while I was at the conference during the day, she worked from various places in Seattle on her laptop. Since it’s practically impossible to attend a modern conference without a laptop, and she uses a desktop at home, I dug out my 2005-era PowerBook G4 to take notes. It may be eight years old, but as soon as I opened it up I remembered why I loved that laptop so much. It’s still in great shape, and it feels like a crime to leave it sitting unused so much of the time.</p>

<p>It’s slow by modern standards, of course, but the thing really keeping it from being usable all the time is software. Apple’s left PowerPC behind as of Mac OS X Leopard<sup id="fnref:2"><a href="#fn:2" rel="footnote">2</a></sup>, and so have nearly all developers at this point. There are still a few developers carrying the torch (shoutouts to <a href="http://www.floodgap.com/software/tenfourfox">TenFourFox</a>), but as a commandline junkie what I really need is an up-to-date shell[^2] and CLI software<sup id="fnref:3"><a href="#fn:3" rel="footnote">3</a></sup>. And as big Homebrew fan, as well as a developer, MacPorts just wasn’t going to cut it. <a href="https://github.com/mistydemeo/tigerbrew/">Tigerbrew</a> was born.</p>

<p>The first version of Tigerbrew was pulled together over an evening at the hotel after the first day of the conference, and I’ve been plugging away at it regularly since. At this point I’m proud to say that a significant number of packages build flawlessly,<sup id="fnref:4"><a href="#fn:4" rel="footnote">4</a></sup> and thanks to <a href="https://github.com/mistydemeo/tigerbrew/wiki/New-formulae-in-Tigerbrew">some backports</a> from newer versions of OS X<sup id="fnref:5"><a href="#fn:5" rel="footnote">5</a></sup> Tigerbrew can supply a much more modern set of essential development tools than Apple provides.</p>

<p>Tigerbrew’s still very much an alpha, and there’s some more work needed until it’s mature, but at this point I consider it ready enough to announce to the world.<sup id="fnref:6"><a href="#fn:6" rel="footnote">6</a></sup> If you have a PowerPC Mac yearning to be used again, why not <a href="https://github.com/mistydemeo/tigerbrew/">give it a go</a>?</p>
<div class="footnotes">
<hr/>
<ol>
<li id="fn:1">
<p>Association of Moving Image Archivists<a href="#fnref:1" rev="footnote">&#8617;</a></p></li>
<li id="fn:2">
<p>And many hardcore PowerPC users stick with their old Macs for OS 9 compatibility, which was last supported in Tiger.<a href="#fnref:2" rev="footnote">&#8617;</a></p></li>
<li id="fn:3">
<p>bash 2.5 doesn’t cut it.<a href="#fnref:3" rev="footnote">&#8617;</a></p></li>
<li id="fn:4">
<p>Even complex software with a lot of moving parts, like FFmpeg.<a href="#fnref:4" rev="footnote">&#8617;</a></p></li>
<li id="fn:5">
<p>I’m very indebted to the MacPorts developers, whose portfiles served as a reference for the buildsystems for several of these.<a href="#fnref:5" rev="footnote">&#8617;</a></p></li>
<li id="fn:6">
<p>Development’s been happening in the public for months, of course, and there are already a few other users out there.<a href="#fnref:6" rev="footnote">&#8617;</a></p></li>
</ol>
</div>

</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/posts/3">&larr; Older</a>
    
    <a href="/blog/blog/archives">Blog Archives</a>
    
    <a class="next" href="/blog/index.html">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/blog/2022/01/06/do-you-speak-the-lingo/">Do You Speak the Lingo?</a>
      </li>
    
      <li class="post">
        <a href="/blog/blog/2021/08/14/exploring-jvs/">Exploring JVS</a>
      </li>
    
      <li class="post">
        <a href="/blog/blog/2020/11/23/bundle-install-with-homebrew-magic-using-brew-bundle-exec/">Bundle Install With Homebrew Magic Using Brew Bundle Exec</a>
      </li>
    
      <li class="post">
        <a href="/blog/blog/2019/02/20/the-hunt-for-the-lost-phoenix-games/">The Hunt for the Lost Phoenix Games</a>
      </li>
    
      <li class="post">
        <a href="/blog/blog/2018/10/18/recover-from-filevault-doom/">Recover From FileVault Doom</a>
      </li>
    
  </ul>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2022 - Misty De Meo -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
