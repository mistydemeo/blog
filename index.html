
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>The Future Is Now</title>
  <meta name="author" content="Misty De Meo">

  
  <meta name="description" content="Awhile back, I had the chance to dump a game for MAME. I told myself that if the chance ever came up again, I&rsquo;d contribute again. Luckily, it &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://mistys-internet.website/blog">
  <link href="/blog/favicon.png" rel="icon">
  <link href="/blog/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/blog/atom.xml" rel="alternate" title="The Future Is Now" type="application/atom+xml">
  <script src="/blog/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/blog/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/blog/">The Future Is Now</a></h1>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/blog/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:mistys-internet.website/blog" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/blog/">Blog</a></li>
  <li><a href="/blog/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2024/03/01/that-time-i-accidentally-deleted-a-game-from-mame/">That Time I Accidentally Deleted a Game From MAME</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2024-03-01T03:25:45-08:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>1</span><span class='date-suffix'>st</span>, <span class='date-year'>2024</span></span> <span class='time'>3:25 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Awhile back, I had the chance to <a href="https://www.mistys-internet.website/blog/blog/2022/10/27/how-i-dumped-an-arcade-game-for-mame/">dump a game for MAME</a>. I told myself that if the chance ever came up again, I&rsquo;d contribute again. Luckily, it turns out I didn&rsquo;t have to wait too long&mdash;but the story didn&rsquo;t end like I expected it to.</p>

<p><img src="/blog/images/martmasttw/0013.big.png" alt="In-game screenshot of Martial Masters" /></p>

<p>When I bought my PGM arcade motherboard, the #1 game I wanted to own was a one-on-one fighting game called <a href="https://wiki.supercombo.gg/w/Martial_Masters">Martial Masters</a>. It&rsquo;s a deeply underrated, gorgeous game&mdash;and judging from the price it goes for these days, I&rsquo;m not the only one after it. It took quite a bit of hunting until I found a copy within my price range but my usual PGM game dealer in China finally tracked down a copy to sell me a few months ago. I was excited to finally play it on the original hardware, but also to see if I had another chance to contribute a game to MAME.</p>

<p>When it arrived, even before I had the chance to check the version number, I was surprised to see it was a Taiwanese region game. All    of IGS&rsquo;s games have simplified Chinese region variants for sale in China; it&rsquo;s unusual to see a traditional Chinese version from Taiwan show up over there. It could just be a sign that the game was so popular they brought over extra cartridges from Taiwan when there weren&rsquo;t enough for local arcades. Once I booted the game and made note of its version numbers, I checked MAME and saw that there was a matching game in its database: <code>martmasttw</code>, or a special Taiwanese version of revision 1.02. That also surprised me&mdash;IGS typically didn&rsquo;t produce entirely separate builds for different regions. Instead, each of their games contains the data for every language and region in its ROMs, and the region code in its copy protection chip determines what region it boots up as.</p>

<p><img src="/blog/images/martmasttw/0000.big.png" alt="Screenshot of Martial Masters crashing" /></p>

<p>The other thing I noticed about MAME&rsquo;s <code>martmasttw</code> was a comment in the source code noting that it might be a bad dump&mdash;that is, an invalid read that produced corrupted data. This isn&rsquo;t that uncommon when dumping these sorts of games. Whether it&rsquo;s due to dying chips or hardware issues with the reading process, sometimes a read just goes wrong and it gets missed. Once I booted it up in MAME, I confirmed it looked like a bad dump. It instantly crashes with an illegal instruction error, a clear sign of corrupted program code. Now that I owned the game, I had a chance to dump the correct ROMs and fix MAME&rsquo;s database.</p>

<p><img src="/blog/images/martmasttw/gamechip.jpeg" alt="Photo of a game chip being held" /></p>

<p>As soon as I opened the cartridge, I noticed something interesting: these weren&rsquo;t the chips I was expected. Like with The Gladiator, I only needed to remove and dump two socketed chips, but these were a completely different model. Other PGM games using the same hardware typically use 27C322 (4MB) and 27C160 (2MB) chips, which were common EPROMs in their time period. Here, though, I saw something much more exotic: an OKI 27C3202 soldered into a custom adapter. The game board itself is essentially the same one that&rsquo;s in The Gladiator, so it was clear that the adapter was presenting them as 4MB 27C322 chips.</p>

<p>I haven&rsquo;t been able to figure out why it was designed this way. It can&rsquo;t have been cheap to design and manufacture these custom adapters, and other PGM games that were made both before and after this one all use the more common chips without any adapters. I&rsquo;ve only seen a single other game built this way. Was there a 27C322 shortage at the time this specific game was being made? Were they experimenting with new designs and ended up abandoning this approach? It&rsquo;s hard to tell.</p>

<p><img src="/blog/images/martmasttw/reader.jpeg" alt="Photo of a game chip being dumped in an EPROM reader" /></p>

<p>I only have an EPROM reader adapter for chips in the 27C322 family, so I hoped it would would be able to handle reading them just fine. On my first attempt, it rejected it; as far as I can tell, it was trying to perform &ldquo;smart&rdquo; verification of the chip, which failed since the underlying chip underneath IGS&rsquo;s adapter isn&rsquo;t actually the chip it&rsquo;s trying to query. I ultimately tricked it by inserting a real 27C322 first and reading that before swapping over to the chip I actually wanted to read. Once the reader&rsquo;s recognized at least one chip, it seems happy to stick in 27C322 mode persistently.</p>

<p>My first read seemed fine, and the dumped data did have a different hash from what MAME recognized. Success! &hellip;or so I thought, until I tried actually booting the game, where it crashed again. I went back to the EPROM reader to make sure the chip was seated correctly before doing a new test read. From the physical design of the adapters, I knew that getting it seated might be a challenge.</p>

<p>The reader uses a <a href="https://en.wikipedia.org/wiki/Zero_insertion_force">ZIF socket</a> which usually makes it easy to insert and remove chips. This time, though, there was an interesting complication. Because of how it&rsquo;s constructed, the socket has a &ldquo;lip&rdquo; at the end past the final set of pins. With a normal 27C322, that&rsquo;s not a problem; the chip ends right at the final set of pins, so nothing hangs over the end of the chip. This adapter has a very different shape from a real 27C322 chip, however&mdash;there&rsquo;s a dangling &ldquo;head&rdquo; that contains the actual chip, as seen in the photo above showing the underside of the adapter. On the real board it hangs harmlessly over the end of the socket, but on a ZIF socket it ends up actually making contact with the end of the socket and keeps the pins from being able to sit as deeply as it would normally sit. I haven&rsquo;t spoken to the person who originally dumped this revision, but I suspect that this is the issue behind the bad dump.</p>

<p>I ended up holding the apdater with one hand to stabilize it and keep all of the pins as even as I could while I locked the ZIF socket&rsquo;s lever a second time; this time, it seemed as though I&rsquo;d been able to get it sitting as even as possible. I then performed several more reads and, before trying to boot it again, compared them against each other. This time, I saw that these new reads were different from the first attempt&mdash;<em>and</em> that they were byte-for-byte identical to each other.</p>

<p><img src="/blog/images/martmasttw/0003.big.png" alt="Screenshot of Martial Masters's title screen" /></p>

<p>Once I had what seemed like good dump of both chips, I booted them up in MAME to see if it would work. Unlike MAME&rsquo;s ROMs, it booted right away without issues and worked perfectly. After I played a few rounds without a single crash or unexpected behaviour, I was satisfied that my new dumps were fine. As I was getting ready to submit a pull request to MAME to update the hashes in its database, however, I happened to grep the source for them and noticed something funny&mdash;they were already there. In another version of Martial Masters.</p>

<p>I mentioned earlier that I was surprised that MAME had labelled the Taiwanese 1.02 version of Martial Masters as a separate revision from the Chinese 1.02. Well, as it turns out, once the ROMs are dumped correctly it&rsquo;s <em>not</em> a separate revision. The ROMs are actually byte-for-byte identical; it&rsquo;s only the bad dump that had made MAME consider <code>martmasttw</code> a separate revision this whole time.</p>

<p>This is the point where I&rsquo;d intended to open a pull request to MAME just updating a few hashes for the correct dump, but with everything I&rsquo;d learned the <a href="https://github.com/mamedev/mame/pull/11883">final pull request</a> deleted <code>martmasttw</code> entirely. I had set out to fix a revision of the game in MAME, and make one more verison of it playable. Instead, I&rsquo;d proven <em>it didn&rsquo;t exist in the first place</em>. This wasn&rsquo;t where I expected to end up, but it does teach an important lesson: corrupted data can go unnoticed for years if it&rsquo;s not double and triple checked.</p>

<p>And, more than that, it&rsquo;s a reminder that <em>databases are an eternal work in progress</em>. MAME&rsquo;s list of ROMs is also as close as there is to a global catalogue of arcade games and their revisions, but it&rsquo;s still fallible. Databases grow and, sometimes, they shrink; proving a work <em>doesn&rsquo;t</em> exist can be just as important as uncovering new works.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2023/12/10/fixing-classical-cats-or/">Fixing Classical Cats; or, How I Got Tricked by 28-year-old Defensive Programming</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2023-12-10T21:49:36-08:00'><span class='date'><span class='date-month'>Dec</span> <span class='date-day'>10</span><span class='date-suffix'>th</span>, <span class='date-year'>2023</span></span> <span class='time'>9:49 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Every now and then, when working on ScummVM&rsquo;s Director engine, I run across a disc that charms me so much I just have to get it working right away. That happened when I ran into Classical Cats, a digital art gallery focused on the work of Japanese artist and classical musician Mitsuhiro Amada. I <a href="https://cdrom.ca/games/2023/12/06/classical-cats.html">wrote about the disc&rsquo;s contents</a> in more detail at my <a href="https://cdrom.ca">CD-ROM blog</a>, but needless to say I was charmed&mdash;I wanted to share this with more people.</p>

<p><img src="/blog/images/classicalcats/scummvm-classicalcats-mac-ja-00004.png" alt="Screenshot of a cat playing piano next to a cat playing a violin and a cat playing cello" /></p>

<p>I first found out about Classical Cats when fellow ScummVM developer einstein95 pointed me at it because its music wasn&rsquo;t working. Like a lot of early Director discs, Classical Cats <em>mostly</em> just worked on the first try. At this point in ScummVM&rsquo;s development, I&rsquo;m often more surprised if a disc made in Director 3 or 4 fails to boot right away. The one thing that didn&rsquo;t work was the music.</p>

<p>Classical Cats uses CD audio for its music, and I&rsquo;d already written code to support this in early releases of <a href="https://www.mobygames.com/game/2059/alice-an-interactive-museum/">Alice: An Interactive Museum</a> for Mac. I&rsquo;d optimistically hoped that Classical Cats might be as easy, but it turned out to present some extra technical complexity. Regardless, for a disc called &ldquo;Classical&rdquo; Cats, I knew that getting music working would be important. I could tell that I wasn&rsquo;t having the full experience.</p>

<p>While many CD-ROMs streamed their music from files on the disc, some discs used CD audio tracks for music instead. (If you&rsquo;re already familiar with CD audio and mixed-mode CDs, you can skip to the next paragraph.) CD audio is the same format used in audio CDs; these tracks aren&rsquo;t files in a directory and don&rsquo;t have names, but are simply numbered tracks like you&rsquo;d see in a CD player. Data on a CD is actually contained within a track on the disc, just like audio; data tracks are just skipped over by CD players. A <em>mixed mode</em> CD is one that contains a mixture of one or more data tracks and one or more audio tracks on the same disc. This was often used by games and multimedia discs as a simple and convenient way to store their audio.</p>

<p>Director software is written in its own programming language called Lingo; I&rsquo;ve written about it <a href="https://www.mistys-internet.website/blog/blog/2022/01/06/do-you-speak-the-lingo/">a few</a> <a href="https://www.mistys-internet.website/blog/blog/2023/05/29/untangling-another-lingo-parser-edge-case/">times</a> before. In addition to writing logic in Lingo, developers are able to write modules called XObjects; these can be implemented in another language like C, but expose an interface to Lingo code. It works very similarly to C extensions in languages like Ruby or Python.</p>

<p>While ScummVM is able to run Lingo code directly, it doesn&rsquo;t emulate the original XObjects. Instead, it contains new clean-room reimplementations embedded into ScummVM that expose the same interfaces as the originals. If a disc tries to call an unimplemented XObject, ScummVM just logs a warning and is able to continue. I&rsquo;d already implemented one of Director&rsquo;s builtin audio CD XObjects earlier, which was how I fixed Alice&rsquo;s music earlier.</p>

<p>ScummVM has builtin support for playing emulated audio CDs by replacing the audio tracks with MP3 or FLAC files. For Alice, I <a href="https://github.com/scummvm/scummvm/pull/4231">wrote</a> an implementation of Director&rsquo;s builtin Apple Audio CD XObject. That version was straightforward and easy to implement; it has a minimal API that allows an app to request playback of a CD via track number, which maps perfectly onto ScummVM&rsquo;s virtual CD backend.</p>

<p>I already knew Classical Cats uses a different XObject, and so I&rsquo;d have to write a new implementation for it, it turns out the API was very different from Alice&rsquo;s. Alice, along with many other Director games I&rsquo;ve looked at, uses a fairly high-level, track-oriented API that was simple to implement. ScummVM&rsquo;s builtin CD audio infrastructure is great at handling requests like &ldquo;play track 5&rdquo;, or &ldquo;play the first 30 seconds of track 7&rdquo;. What it&rsquo;s not at all prepared for is requests like &ldquo;play from position 12:00:42 on the disc&rdquo;.</p>

<p>You can probably guess what Classical Cats does! Instead of working with tracks, it starts and stops playback based on absolute positions on a disc. This may sound strange, but it&rsquo;s how the disc itself is set up. On a real CD, tracks themselves are just indices into where tracks start and stop on a disc, and a regular CD player looks up those indices to decide where to seek to when you ask it to play a particular track. In theory, it&rsquo;s pretty similar to dropping a record player needle on a specific spot on the disc.</p>

<p>This might not sound too complex to manage, but there&rsquo;s actually something that makes it a lot harder: translating requests to play an absolute timecode to an audio file on disc. ScummVM isn&rsquo;t (usually) playing games from a real CD, but emulating a drive using the game data and FLAC or MP3 files replacing the CD audio tracks. ScummVM generally plays games using the data extracted from the CD into a folder on the hard drive, which causes a problem: the data track on a mixed mode CD is usually the first track, which means that the timing of every other track on the disc is offset by the length of the data track. We can&rsquo;t guess where anything else is stored without knowing exactly how long the data track is. If we&rsquo;ve extracted the data from the CD, we no longer know how big that track is, and we can&rsquo;t guess at the layout of the rest of the disc.</p>

<p>&ldquo;Knowing the disc layout&rdquo; is a common problem with CD ripping and authoring, and a number of standards exist already. Single-disc data CDs can easily be represented as an ISO file, but anything more complex requires an actual table of contents. When thinking about how to solve this problem for ScummVM, I immediately thought of <a href="https://en.wikipedia.org/wiki/Cue_sheet_(computing)">cuesheets</a>&mdash;one of the most popular table of contents formats for CD ripping, and one that&rsquo;s probably familiar to gamers who have used BIN/CUE rips of 32-bit era video games. Among all the formats available for documenting a disc&rsquo;s table of contents, cuesheets were attractive for a few reasons: I&rsquo;ve worked with it before, so I&rsquo;m already familiar with it; it&rsquo;s human-readable, so it&rsquo;s easy to validate that it&rsquo;s being used properly; and it provides a simple, high-level interface that abstracts away irrelevant details that I wouldn&rsquo;t need to implement this feature. A sample cuesheet for a mixed mode CD looks something like this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>FILE "CLSSCATS.BIN" BINARY
</span><span class='line'>  TRACK 01 MODE1/2352
</span><span class='line'>    INDEX 01 00:00:00
</span><span class='line'>  TRACK 02 AUDIO
</span><span class='line'>    PREGAP 00:02:00
</span><span class='line'>    INDEX 01 17:41:36
</span><span class='line'>  TRACK 03 AUDIO
</span><span class='line'>    INDEX 01 19:20:46
</span><span class='line'>  TRACK 04 AUDIO
</span><span class='line'>    INDEX 01 22:09:17</span></code></pre></td></tr></table></div></figure>


<p>Once you understand the format, it&rsquo;s straightforward to read and makes it clear exactly where every track is located on the disc.</p>

<p>The main blocker here was simply that ScummVM didn&rsquo;t have a cuesheet parser yet, and I wasn&rsquo;t eager to write one myself. Just when I was on the verge of switching to another solution, however, ScummVM project lead Eugene Sandulenko offered to write a new one integrated into ScummVM itself. As soon as that was ready, I was able to get to work.</p>

<p>The XObject Classical Cats uses has a fairly complicated interface that&rsquo;s meant to support not just CDs, but also media like video cassettes. To keep things simple, I decided to limit myself to implementing just the API that this disc uses and ignore methods it never calls. It&rsquo;s hard to make sure my implementation&rsquo;s compatible if I don&rsquo;t actually see parts of it in use, after all. By watching to see which method stubs are called, I could see that I mainly had to deal with a limit set of methods. Aside from being able to see which methods are called and the arguments passed to them, I was able to consult the official documentation in the Director 4.0 manual.<sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup></p>

<p>Two of the most fundamental methods I began with were <code>mSetInPoint</code> and <code>mSetOutPoint</code>, whose names were pretty self-explanatory. Rather than have a single method to begin playback with start/stop positions, this library uses a cue system. Callers first call <code>mSetInPoint</code> to define the start playback position and <code>mSetOutPoint</code> to set a stop position. These positions are tracked in <em>frames</em>, a unit representing 1/75th of a second.</p>

<p>On a real drive, they can then call <code>mPlayCue</code> to seek to the start of the position so that the drive is ready. Given the slow seek times of early CD-ROM drives, this separation forced developers to consider that the device might not actually be able to start playback as soon as they request it and take that into account with their app&rsquo;s interactive features. After starting the seek operation, the developer was meant to repeatedly call <code>mService</code> to retrieve a status code and find out whether the drive was still seeking, had finished seeking, or encountered an error. Since ScummVM is usually acting on an emulated drive without actual seek times, I simplified this. <code>mSetInPoint</code> and <code>mSetOutPoint</code> simply assign instance variables with the appropriate values, and <code>mService</code> always immediately returns the &ldquo;drive ready&rdquo; code.</p>

<p>At this point, I did what I should have done in the first place and checked the source code. As I mentioned in a <a href="https://www.mistys-internet.website/blog/blog/2022/01/06/do-you-speak-the-lingo/">previous post</a>, early Director software includes the source code as a part of the binary, and luckily that&rsquo;s true for Classical Cats. As I checked its CD-ROM helper library, I stumbled on the method that made me realize exactly where I&rsquo;d gone wrong:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>on mGetFirstFrame me, aTrack
</span><span class='line'>  put the pXObj of me into myXObj
</span><span class='line'>  if myXObj(mRespondsTo, "mGetFirstFrame") = 0 then
</span><span class='line'>    return 0
</span><span class='line'>  else
</span><span class='line'>    return  myXObj(mGetFirstFrame, aTrack)
</span><span class='line'>  end if
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p>This code might be familiar to Rubyists, since Ruby has a very similar construct. This class wraps the AppleCD SC XObject, instantiated in the instance variable <code>myXObj</code>, and calls methods on it. But it&rsquo;s written defensively: before calling a number of methods, it calls <code>mRespondsTo</code> first to see if <code>myXObj</code> has the requested method. If it doesn&rsquo;t, it just stubs it out instead of erroring. Since ScummVM implements <code>mRespondsTo</code> correctly, it means this code was doing what the original authors intended: seeing that my implementation of AppleCD SC didn&rsquo;t have an <code>mGetFirstFrame</code> method, and just returning a stub value. Unfortunately for me, I was being lazy and had chosen which methods to implement based on seeing the disc try to use them&mdash;so I let myself be tricked into thinking those methods were never used.</p>

<p>As it turns out, they were actually key to getting the right timing data. Classical Cats was trying to ask the CD drive about timing information for tracks, and storing that to use to actually play the songs. With these methods missing, it was stuck without knowing where the songs were and how to play them.</p>

<p>And here I realized the great irony of what I was doing. Internally, Classical Cats thinks about its audio in terms of tracks, and asks the XObject for absolute timing data for each track. It then passes that data back into the XObject to play the songs, where ScummVM intercepts it and translates it back into track-oriented timing so its CD drive emulation knows how to play them. It&rsquo;s a lot of engineering work just to take it all full circle.</p>

<p>At the end of the day, though, what&rsquo;s important is it <em>does</em> work. Before I finished writing this, it was difficult to play Classical Cats on any modern computer; now, anyone with version 2.8.0 or later of ScummVM can give it a try. Now that it&rsquo;s more accessible, I hope other people are able to discover it too.</p>

<p>Note: CD audio support for this disc is available in nightly builds of ScummVM, and will be available in a future stable release.</p>
<div class="footnotes">
<hr/>
<ol>
<li id="fn:1">
<p>Schmitz, J., &amp; Essex, J. (1994). Basic device control. In <em>Using Lingo: Director Version 4</em> (pp. 300–307). Macromedia, Inc.<a href="#fnref:1" rev="footnote">&#8617;</a></p></li>
</ol>
</div>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2023/10/25/cargo-dist-system-dependencies-are-hard-so-we-made-them-easier/">Cargo-dist: System Dependencies Are Hard (So We Made Them Easier)</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2023-10-25T14:26:42-07:00'><span class='date'><span class='date-month'>Oct</span> <span class='date-day'>25</span><span class='date-suffix'>th</span>, <span class='date-year'>2023</span></span> <span class='time'>2:26 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>My latest blog post is over at my employer&rsquo;s blog post and talks about the work I&rsquo;ve done to get system dependency management integrated into <a href="https://opensource.axo.dev/cargo-dist/"><code>cargo-dist</code></a>, an open source release management tool for Rust. The new release lets users specify non-Rust dependencies in <code>Cargo.toml</code> using a Cargo-like syntax and also provides a detailed report on the resulting binary&rsquo;s dynamic linkage. Here&rsquo;s a sample of the dependency syntax:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[workspace.metadata.dist.dependencies.homebrew]
</span><span class='line'>cmake = { targets = ["x86_64-apple-darwin"] }
</span><span class='line'>libcue = { version = "2.2.1", targets = ["x86_64-apple-darwin"] }
</span><span class='line'>
</span><span class='line'>[workspace.metadata.dist.dependencies.apt]
</span><span class='line'>cmake = '*'
</span><span class='line'>libcue-dev = { version = "2.2.1-2" }
</span><span class='line'>
</span><span class='line'>[workspace.metadata.dist.dependencies.chocolatey]
</span><span class='line'>lftp = '*'
</span><span class='line'>cmake = '3.27.6'</span></code></pre></td></tr></table></div></figure>


<p>Go <a href="https://blog.axo.dev/2023/10/dependencies">read the blog post</a> to find out more!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2023/05/29/untangling-another-lingo-parser-edge-case/">Untangling Another Lingo Parser Edge Case</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2023-05-29T15:53:18-07:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>29</span><span class='date-suffix'>th</span>, <span class='date-year'>2023</span></span> <span class='time'>3:53 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I was testing out a new Macromedia Director CD in ScummVM, and I noticed a non-fatal error at startup:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>WARNING: ######################  LINGO: syntax error, unexpected tSTRING: expected ')' at line 2 col 70 in ScoreScript id: 2!
</span><span class='line'>WARNING: #   2: set DiskChk = FileIO(mnew,"read"¬"The Source:Put Contents on Hard Drive:Journey to the Source:YZ.DATA")!
</span><span class='line'>WARNING: #                                                                            ^ about here!</span></code></pre></td></tr></table></div></figure>


<p>It may have been non-fatal, but seeing an error like that makes me uneasy anyway&mdash;I&rsquo;m never sure when it&rsquo;ll turn out to have ramifications down the line. This comes from the parser for Director&rsquo;s custom programming language, Lingo, so I opened up the code in question<sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup> to take a look. The whole script turned out to be only three straightforward lines. The part ScummVM complained about came right at the start of the file, and at first glance it looked pretty innocuous.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>set DiskChk = FileIO(mnew,"read"¬
</span><span class='line'>"The Source:Put Contents on Hard Drive:Journey to the Source:YZ.DATA")
</span><span class='line'>IF DiskChk = -35 THEN GO TO "No CD"</span></code></pre></td></tr></table></div></figure>


<p>The symbol at the end of that first line is a continuation marker, which you might remember from a <a href="https://www.mistys-internet.website/blog/blog/2022/01/06/do-you-speak-the-lingo/">previous blog post</a> where I debugged a different issue with them. The continuation marker is a special kind of escape character with one specific purpose: it escapes newlines to allow statements to extend across more than one line of code, and nothing else.</p>

<p>At first I thought maybe the issue was with the continuation marker itself being misparsed, like in the error I documented in that older blog post; maybe it was failing to be recognized and wasn&rsquo;t being replaced with whitespace? To figure that out, I started digging around in ScummVM&rsquo;s Lingo preprocessor. Spoiler: it turned out <em>not</em> to be an issue with the continuation marker, but it pointed me in the right direction anyway.</p>

<p>ScummVM handles the continuation marker in two phases. In a preprocessor phase, it <a href="https://github.com/scummvm/scummvm/blob/6823514318a29fe9ec34956a97085117514a60dc/engines/director/lingo/lingo-preprocessor.cpp#L69-L73">removes the newline after the marker</a> in order to simplify parsing later. Afterwards, in the lexer, it <a href="https://github.com/scummvm/scummvm/blob/6823514318a29fe9ec34956a97085117514a60dc/engines/director/lingo/lingo-lex.l#L92">replaces the marker with a space</a> to produce a single normal line of code. The error message above contains a version of the line between those two steps: the preprocessor has combined the two lines of code into one, but the continuation marker hasn&rsquo;t been replaced with a space yet.</p>

<p>If we do the work of the preprocessor/lexer ourselves, we get this copy of the line:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>set DiskChk = FileIO(mnew,"read" "The Source:Put Contents on Hard Drive:Journey to the Source:YZ.DATA")</span></code></pre></td></tr></table></div></figure>


<p>In this form, the error is a bit more obvious than when it was spread across multiple lines. The problem is with how the arguments are passed to <code>FileIO</code>: the first two arguments are separated by a comma, but the second and third aren&rsquo;t. The newline between the second and third arguments makes it easy to miss, but as soon as we put it all together it becomes obvious.</p>

<p>In the last case I looked at, described in the previous blog post, this was an ambiguous parse case: the same line of code was valid if you added the missing comma or not, but it was interpreted two totally different ways. This time is different. If you add the missing comma, this is a normal, valid line of code; if you don&rsquo;t, it&rsquo;s invalid syntax and you get the error we&rsquo;re seeing at the top.</p>

<p>As far as I can tell, the original Director runtime actually accepts this without throwing an error even though this isn&rsquo;t documented as correct syntax. The official Director programming manual tells the user to use commas to separate arguments, but it&rsquo;s tolerant enough to support when they&rsquo;re forgotten like they are here<sup id="fnref:2"><a href="#fn:2" rel="footnote">2</a></sup>. ScummVM doesn&rsquo;t get that same luxury. As I mentioned in the previous blog post, later Director versions tightened up these ambiguous parse cases, and supporting the weird case in Director 3 would significantly complicate the parser. Since this is only the second case of this issue, though, it&rsquo;s not really <em>necessary</em> to support it either. ScummVM has builtin support for patching a specific disc&rsquo;s Lingo source code, so I was able to simply fix this by patching the code to the properly-formatted version.</p>

<p>The disc in question still doesn&rsquo;t fully work, but I&rsquo;m putting some time into it. I&rsquo;m planning on writing a followup on the other fixes necessary to get it running as expected. And for today&rsquo;s lesson? Old software is weird. Just like new software.</p>
<div class="footnotes">
<hr/>
<ol>
<li id="fn:1">
<p>Before version 4, Director software was interpreted from source code at runtime&mdash;so, conveniently, that means that you can peek at the source code to any early Director software.<a href="#fnref:1" rev="footnote">&#8617;</a></p></li>
<li id="fn:2">
<p><em>MacroMind Director Version 3.0: Interactivity Manual</em>. (1991). MacroMind, Inc. Page 64.<a href="#fnref:2" rev="footnote">&#8617;</a></p></li>
</ol>
</div>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2022/10/27/how-i-dumped-an-arcade-game-for-mame/">How I Dumped an Arcade Game for MAME</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2022-10-27T21:06:52-07:00'><span class='date'><span class='date-month'>Oct</span> <span class='date-day'>27</span><span class='date-suffix'>th</span>, <span class='date-year'>2022</span></span> <span class='time'>9:06 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I recently had the chance to do something that I&rsquo;ve wanted to do for years: dump an arcade game to add it to MAME.</p>

<p><img src="/blog/images/theglad104/0005.big.png" alt="Screenshot of The Gladiator's title screen" /></p>

<p>MAME is a massive emulator that covers thousands of arcade games across the history of gaming. It&rsquo;s one of those projects I&rsquo;ve used and loved for decades. I&rsquo;ve always wanted to give back, but it never felt like I had something to contribute&mdash;until recently.</p>

<p>You might remember from <a href="https://www.mistys-internet.website/blog/blog/2021/08/14/exploring-jvs/">one of my other posts</a> that I recently got into collecting arcade games. This year I&rsquo;ve been collecting games for a Taiwanese system called the PolyGame Master (PGM), a cartridge-based system with interchangeable games sold by International Games System (IGS) between 1997 and 2005. It has a lot of great games that aren&rsquo;t very well-known, in particular some incredibly well-designed beat-em-ups.</p>

<p>A couple months ago, I bought a copy of <em>The Gladiator</em>, a wuxia-themed beat em up set in the Song dynasty. My specific copy turns out to be an otherwise-undumped game revison. Many arcade games were released in many different versions, including regional variations and bugfix updates, and it can take collectors and MAME developers years to track them all down. In the case of <em>The Gladiator</em>, MAME has the final release, 1.07, and the first few revisions, but it&rsquo;s missing most of the versions in between. When my copy came here, I booted it up and found out it was one of those versions MAME was missing: 1.04.</p>

<p>Luckily, I already had the hardware on hand to dump it. I own an EPROM burner that I&rsquo;d bought to <em>write</em> chips so that I could mod games I&rsquo;d bought, but EPROM burners can read chips as well. I own an adapter that supports several common chips that, luckily, can handle exactly the chips I needed for this game.</p>

<div style="text-align: center; width: 33%; margin: 1em auto;"><img alt="Photo of an EPROM burner with a 27C160 chip in it" src="/blog/images/theglad104/IMG_5291.jpeg"></div>


<p>It&rsquo;s easy to think of game cartridges as just being a single thing, but arcade game boards typically have a large number of chips. Why&rsquo;s that? It&rsquo;s partly technical; specific chips can be connected directly to particular regions of the system&rsquo;s hardware, like graphics or sound, which means that even though it&rsquo;s less flexible than an all-in-one ROM, it has some performance advantages too. The two chips I dumped here are program code for two different CPUs: one for the 68000 CPU in the system itself, and one for the ARM7 CPU in the game cartridge.</p>

<p>The other advantage is that using a large number of chips can make it easier to update a game down the line. Making an overseas release? It would be much cheaper to update just a couple of your chips instead of producing new revisions of everything on your board. Releasing a bugfix update? It&rsquo;s much more quick and painless to update existing games if all your program code is on a single chip.</p>

<p>From looking at MAME, I could tell that every other revision of <em>The Gladiator</em> used a single set of chips for almost everything. Only the two program ROM chips are different between versions, which made my life a lot easier. I was also lucky that these chips were easy to get to. Depending on the kind of game, chips might be attached straight to the board, or they might be in sockets where they can be easily removed and reattached. <em>The Gladiator</em> has two game boards, one of which uses two socketed chips. And, thankfully, those were the only two chips I had to remove and dump.</p>

<p>To remove the chips, I used an EPROM removal tool&mdash;basically just a little set of pliers on a spring, with pair of needle noses that get in under the edge of the chip in the socket so you can pull it out. The two chips were both common types that my EPROM burner supports, so once I got them out they weren&rsquo;t difficult to read. The most important chip, which has the game&rsquo;s program code, is an EPROM chip known as the 27C160&mdash;a 2MB chip in a specific form factor. I already own a reader that supports that and the 4MB version of the same chip, which you can see in the above photo. The second chip is a 27C4096DC which has a much smaller 512KB capacity.</p>

<div style="text-align: center; width: 33%; margin: 1em auto;"><img alt="Photo of an open game cartridge showing the boards and ROM chips" src="/blog/images/theglad104/IMG_5293.jpeg"></div>


<p>Why are there two program ROMs? Many games for the PGM use a fascinating and pretty intense form of copy protection. As I mentioned earlier, the PGM motherboard has a 20MHz 68000 processor, a 16-bit CPU that was very widely used in the 90s. The game cartridge, meanwhile, has a 20MHz ARM7 coprocessor. For early games, that ARM7 was there just for copy protection. Game cartridges would feature an unencrypted 68000 ROM and an encrypted ARM7 ROM; the ARM7 must successfully decrypt and execute code from the encrypted ROM for the main program code to be allowed to boot and run. By the end of the PGM&rsquo;s life, they&rsquo;d clearly realized it was silly to be devoting the ARM7 just to copy protection when it was faster than the CPU on the motherboard, so they put it to use for actual game logic. On games like <em>The Gladiator</em>, the unencrypted 68000 ROM and the main CPU are only doing very basic bootstrapping work and then hand off the rest of the work to the ARM7, which runs the game using code on the encrypted ARM7 chip.</p>

<p>I spent awhile fumbling around trying to get the dumped ARM7 ROM to work, but it turns out that&rsquo;s because I read it as the wrong kind. Oops. My reader has a switch that switches between the 2MB and 4MB versions of the chip&hellip; and I had it set to 4MB, even though the chip helpfully told me right on the package it&rsquo;s a 2MB chip. So, after I spent a half hour fumbling, I realize what I&rsquo;d done and went back to redump it&mdash;and <em>that</em> version worked first try. Phew.</p>

<p><img src="/blog/images/theglad104/0004.big.png" alt="Screenshot of The Gladiator's boot screen with the program ROM versions" /></p>

<p>Once I dumped it, I was able to figure out that one of the two program ROMs is identical to one that&rsquo;s already in MAME; only the ARM ROM is unique. That meant adding it to MAME was very easy; I could mostly copy and paste existing code defining the game cartridge, changing just one line with the new ROM and a few lines with some different metadata, and I was good to go. I submitted a <a href="https://github.com/mamedev/mame/pull/10306">pull request</a> and, after some discussion, it was merged. For something I&rsquo;ve wanted to be able to contribute to for <em>years</em>, feels good and, honestly pretty painless. And now, as of <a href="https://www.mamedev.org/?p=518">MAME 0.249</a>, <em>The Gladiator</em> 1.04 can finally be emulated!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2022/01/06/do-you-speak-the-lingo/">Do You Speak the Lingo?</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2022-01-06T14:58:00-08:00'><span class='date'><span class='date-month'>Jan</span> <span class='date-day'>6</span><span class='date-suffix'>th</span>, <span class='date-year'>2022</span></span> <span class='time'>2:58 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I&rsquo;ve been spending some time lately contributing to <a href="https://www.scummvm.org">ScummVM</a>, an open-source reimplementation of many different game engines that makes it possible to play those games on countless modern platforms. They&rsquo;ve recently added support for Macromedia Director, an engine used by a ton of 90s computer games and multimedia software that I&rsquo;m really passionate about, so I wanted to get involved and help out.</p>

<p><img class="crisp" src="/blog/images/scummvm-henachoco03/scummvm-henachoco03-mac-ja-00003.png"></p>

<p>One of the first games I tried out is <em>Difficult Book Game</em> (<em>Muzukashii Hon wo Yomu to Nemukunaru</em>, or <em>Reading a Difficult Book Makes You Sleepy</em>), a small puzzle game for the Mac by a one-person indie studio called Itachoco Systems that specialized in strange, interesting art games. Players take on the role of a woman named Miss Linli who, after falling asleep reading a complicated book, finds herself in a strange lucid dream where gnomes are crawling all over her table. Players can entice them to climb on her or scoop them up with her hands. If two gnomes walk into each other, they turn into a strange seed that, in turn, grows into other strange things if it comes into contact with another gnome. Players guide her using what feels like an early ancestor to <a href="http://www.foddy.net/Athletics.html">QWOP</a>, with separate keys controlling the joints on each of Linli&rsquo;s arms. It&rsquo;s bizarre, difficult to control, and compelling.</p>

<p>A lot of early Director games play fine in ScummVM without any special work, so I was hoping that would be true here too. Unfortunately, it didn&rsquo;t turn out to be quite that simple. I ended up taking a dive into ScummVM&rsquo;s implementation of Director to fix it.</p>

<p>Director uses its own programming language, Lingo, which is inspired by languages like <a href="https://en.wikipedia.org/wiki/Smalltalk">Smalltalk</a> and <a href="https://en.wikipedia.org/wiki/HyperCard">HyperCard</a>. HyperCard was Apple&rsquo;s hypermedia development environment, released for Macs in 1987, and was known for its simple, English-like, non-programmer friendly programming language. Smalltalk, meanwhile, is a programming language developed in the 70s and 80s known for its simple syntax and powerful object oriented features, very new at the time; it&rsquo;s also influenced other modern languages such as Python and Ruby. Lingo uses a HyperCard-style English-like way of programming and Smalltalk-style object oriented features.</p>

<p>Early versions of Director are unusual for having the engine interpret the game logic straight from source code<sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup>&mdash;which means if you&rsquo;ve got any copy of the game, you&rsquo;ve got the source code too. It&rsquo;s great for debugging and learning how it works, but there&rsquo;s a downside too. If you&rsquo;re writing a new interpreter, like ScummVM, it means you have to deal with writing a parser for arbitrary source code. As it turns out, every issue I&rsquo;d have to deal with to get this game working involved the parser.</p>

<p>I&rsquo;ll get into the details later, but first some background. To give a simplified view, ScummVM processes Lingo source in a few steps. First, it translates the text from its source encoding to Unicode; since Lingo dates to before Unicode was widely used, each script is stored in a language-specific encoding and needs to be translated in order for modern Unicode-native software to interpret it correctly. Next, there&rsquo;s a preprocessing stage in which a few transformations are made in order to make the later stages simpler. The output of this stage is still text which carries the same technical meaning, it&rsquo;s just text that&rsquo;s easier for the next stages to process. This is followed by the two stages of the actual parser itself: the lexer, in which source code text is converted into a series of tokens, and the parser, which has a definition of the grammar for the language and interprets the tokens from the previous stage in the context of that grammar.</p>

<p>This all sounds complicated, but my changes ended up being pretty small. They did, however, end up getting spread across several of these layers.</p>

<h3>1. The fun never ends!</h3>

<p>The very first thing I got after launching the game was this parse error:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>WARNING: ######################  LINGO: syntax error, unexpected tMETHOD: expected end of file at line 83 col 6 in MovieScript id: 0!</span></code></pre></td></tr></table></div></figure>


<p>Taking a look at the code in question, there&rsquo;s nothing that really looks too out of the ordinary:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>factory lady
</span><span class='line'>method mNew
</span><span class='line'>    instance rspri,rx,ry,rhenka,rkihoncala,rflag,rhoko,rkasoku
</span><span class='line'>end method
</span><span class='line'>method mInit1 spri
</span><span class='line'># etc</span></code></pre></td></tr></table></div></figure>


<p>This is the start of the definition of the game&rsquo;s first factory. Lingo supports object-oriented features, something that was still pretty new when it was introduced, and allows for user-defined classes called &ldquo;factories&rdquo;<sup id="fnref:2"><a href="#fn:2" rel="footnote">2</a></sup>. Following the <code>factory lady</code> definition are a number of methods, defined in a block-like format: <code>method NAME</code>, an indented set of one or more lines of method definitions, and an <code>end method</code> line.</p>

<p>That last line, it turns out, was the problem. To my surprise, it turns out those <code>end method</code> blocks are totally optional even though it&rsquo;s the documented syntax in the official Director manual. Not only can it have any text there instead of <code>method</code>, but it turns out you don&rsquo;t need any form of <code>end</code> statement at all. If ScummVM didn&rsquo;t recognize it, it seems that many games must have just skipped it.</p>

<p>Luckily, this was a very easy fix: I <a href="https://github.com/scummvm/scummvm/pull/3547">added a single line</a> to ScummVM&rsquo;s <a href="https://en.wikipedia.org/wiki/GNU_Bison">Bison</a>-based parser and it was able to handle <code>end</code> statements without breaking support for methods defined without them. I hoped that was all it was going to take for Difficult Book Game to run, but I wasn&rsquo;t quite so lucky.</p>

<h3>2. Language-dependent syntax</h3>

<p>Unlike most modern languages, Lingo doesn&rsquo;t have a general-purpose escape character like <code>\</code> that can be use to extend a line of code across multiple lines. Instead, it uses a special character called the &ldquo;continuation marker&rdquo;, <code>¬</code><sup id="fnref:3"><a href="#fn:3" rel="footnote">3</a></sup>, which serves that purpose and is used for nothing else in the language<sup id="fnref:4"><a href="#fn:4" rel="footnote">4</a></sup>. (Hope you like holding down keys to type special characters!) Here&rsquo;s an example of how that looks with a couple lines of code from a real application:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>global theObjects,retdata1,retdata2,ladytime,selif,daiido,Xzahyo,Yzahyo,StageNum, ¬
</span><span class='line'>           daihoko</span></code></pre></td></tr></table></div></figure>


<p>Since Lingo was originally written for the Mac, whose default MacRoman character set supported a number of &ldquo;special&rdquo; characters and accents outside the normal ASCII range, they were able to get away with characters that might not be safe in other programming languages. But there&rsquo;s a problem there, and not just that it was annoying to type: what happens if you&rsquo;re programming in a language that doesn&rsquo;t use MacRoman? This is before Unicode, so each language was using a different encoding, and there&rsquo;s no guarantee that a given language would have <code>¬</code> in its character set.</p>

<p>Which takes me back to Difficult Book Game. I tried running it again after the fix above, only to run into a new parse error. After checking the lines of code it was talking about, I ran into something that looks almost like the code above&hellip; <em>almost</em>.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>global theObjects,retdata1,retdata2,ladytime,selif,daiido,Xzahyo,Yzahyo,StageNum, ﾂ
</span><span class='line'>           daihoko</span></code></pre></td></tr></table></div></figure>


<p>Spot the difference? In the place where the continuation marker should be, there&rsquo;s something else: <code>ﾂ</code>, or the halfwidth katakana character &ldquo;tsu&rdquo;. As it turns out, that&rsquo;s not random. In MacRoman, <code>¬</code> takes up the character position <code>0xC2</code>, and <code>ﾂ</code> is at the same location in MacJapanese. That, it turns out, seems to be the answer of how the continuation marker is handled in different languages. It&rsquo;s not really <code>¬</code>, it&rsquo;s whatever character happens to be at <code>0xC2</code> in a given text encoding.</p>

<p>Complicating things a bit, ScummVM handles lexing Lingo <em>after</em> translating the code from its source encoding to UTF-8. If it lexed the raw bytes, it would be one thing: whatever the character is at <code>0xC2</code> is the continuation marker, regardless of what character it &ldquo;means&rdquo;. Handling it after it&rsquo;s been turned into Unicode is a lot harder. Since ScummVM already has a Lingo preprocessor, though, it could get fixed up there: just look for instances of <code>ﾂ</code> followed by a newline, and treat that as though it&rsquo;s a &ldquo;real&rdquo; continuation marker<sup id="fnref:5"><a href="#fn:5" rel="footnote">5</a></sup>. A little crude, but it works, and suddenly ScummVM could parse Difficult Book Game&rsquo;s code<sup id="fnref:6"><a href="#fn:6" rel="footnote">6</a></sup>. Or, almost&hellip;</p>

<h3>3. What&rsquo;s in a space?</h3>

<p>Now that I could finally get in-game, I could start messing around with the controls and see how it ran. Characters were moving, controls were responding&mdash;it was looking good! At least until I pressed a certain key&hellip;</p>

<p><img class="crisp" src="/blog/images/scummvm-henachoco03/scummvm-henachoco03-mac-ja-00000.png"></p>

<p>Her arms detached&mdash;that doesn&rsquo;t look comfortable. In the console, ScummVM flagged an error that looked relevant:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Incorrect number of arguments for handler mLHizikaraHand (1, expected 3 to 3). Adding extra 2 voids!</span></code></pre></td></tr></table></div></figure>


<p>This sounded relevant, since &ldquo;hiji&rdquo; means elbow. I figured it was probably the handler called when rotating her arm around her elbow, which is exactly what visually broke. I took a look at where <code>mLHizikaraHand</code> and the similar handlers were being called, and noticed something weird. In some places, it looks like this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>locaobject(mLHizikaraHand,(rhenka + 1),dotti)</span></code></pre></td></tr></table></div></figure>


<p>And in other places, it looked slightly different:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>locaobject(mLHizikaraHand (rhenka + 1),dotti)</span></code></pre></td></tr></table></div></figure>


<p>Can you find the difference? It&rsquo;s the character immediately after the handler name: instead of a comma, it&rsquo;s followed by a space. Now that I looked at it, the ScummVM error actually sounded right. It <em>does</em> look like it&rsquo;s calling <code>mLHizikaraHand</code> with a single argument (<code>rhenka + 1</code>). After talking it over with ScummVM dev djsrv, it sounds like this is just a Lingo parsing oddity. Lingo was designed to be a user-friendly language, and there are plenty of cases where its permissive parser accepts things that most languages would reject. This seems to be one of them.</p>

<p>Unfortunately, this parse case also seems to be different between Lingo versions. Fixing how it interprets it might have knock-on effects for parsing things created for later Director releases. Time to get hacky instead. The good news is that ScummVM has a mechanism for exactly this: it bundles patches for various games, making it possible to fix up weird and ambiguous syntax that its parser can&rsquo;t handle yet. I added patches to change the ambiguous cases to the syntax used elsewhere, and suddenly Miss Linli&rsquo;s posture is looking a lot healthier.</p>

<p><img class="crisp" src="/blog/images/scummvm-henachoco03/scummvm-henachoco03-mac-ja-00001.png"></p>

<p>This whole thing ended up being much more of a journey than I expected. So much for having it just run! In the end, though, I learned quite a bit&mdash;and I was able to get a cool game to run on modern OSs. I&rsquo;m continuing to work on ScummVM&rsquo;s Director support and should have more to write about later.</p>

<p>Thanks to ScummVM developers djsrv and sev for their help working on this.</p>
<div class="footnotes">
<hr/>
<ol>
<li id="fn:1">
<p>Later versions switched to using a bytecode format, similar to Java or C#. This makes processing a lot easier, since bytecode produced by Director&rsquo;s own compiler is far more standardized than human-written source code.<a href="#fnref:1" rev="footnote">&#8617;</a></p></li>
<li id="fn:2">
<p>Despite the name, it isn&rsquo;t really implementing the <a href="https://en.wikipedia.org/wiki/Factory_method_pattern">factory pattern</a>.<a href="#fnref:2" rev="footnote">&#8617;</a></p></li>
<li id="fn:3">
<p>The mathematical <a href="https://en.wikipedia.org/wiki/Negation">negation operator</a>.<a href="#fnref:3" rev="footnote">&#8617;</a></p></li>
<li id="fn:4">
<p>It&rsquo;s a bit of a weird choice, but Lingo didn&rsquo;t do it first. It showed up first in Apple&rsquo;s HyperCard and AppleScript languages.<a href="#fnref:4" rev="footnote">&#8617;</a></p></li>
<li id="fn:5">
<p>Tempting as it is to refactor the lexer, I had other things to do, and I really wasn&rsquo;t familiar enough with its innards to take that on.<a href="#fnref:5" rev="footnote">&#8617;</a></p></li>
<li id="fn:6">
<p>As it turns out, this wasn&rsquo;t the only game with the same issue. Fixing this also fixed several other Japanese games, including <em>The Seven Colors: Legend of Psy・S City</em> and <em>Eriko Tamura&rsquo;s Oz</em>.<a href="#fnref:6" rev="footnote">&#8617;</a></p></li>
</ol>
</div>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2021/08/14/exploring-jvs/">Exploring JVS</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2021-08-14T13:54:08-07:00'><span class='date'><span class='date-month'>Aug</span> <span class='date-day'>14</span><span class='date-suffix'>th</span>, <span class='date-year'>2021</span></span> <span class='time'>1:54 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Everyone had their weird pandemic hobby, right? Well, mine is that I bought an arcade video game. Not the whole cabinet - just a board, to hook up to a TV and a game controller. If I can&rsquo;t go to the arcade, at least I can bring a favourite game home, right?</p>

<p>As you might imagine, an arcade board isn&rsquo;t just plug and play; you can&rsquo;t just plug in a USB gamepad and call it a day. Finding out how to actually use it took some research. I looked up the different methods, and found I had more or less two options: a more expensive one involving repurposed arcade hardware, and an open-source one using off-the-shelf parts. While I was figuring out if the more expensive options were worth it, I decided I&rsquo;d try out the open source one, <a href="https://github.com/openjvs/openjvs">OpenJVS</a>. I started out as just a user, but ended up getting involved in development. Over the past few months, I&rsquo;ve contributed a bunch of new features and bugfixes. In the process I learned a lot about the specification&hellip; and quashed my fair share of weird bugs.</p>

<h2>So what is JVS anyway?</h2>

<p>Imagine this: you&rsquo;re an arcade machine manufacturer, and you need to make it easy for a machine operator to swap a new board into one of their cabinets. How do you make sure they don&rsquo;t have to run dozens of wires to get the controls hooked up? Video is easy; you can just use VGA, DVI, or HDMI. Power is easy too. What else is left? Well, there&rsquo;s many different kinds of input so players can actually play the game; coin inputs and money bookkeeping; smart cards to communicate information to a game; in other words, all kinds of input from the player.</p>

<p>The solution? JAMMA Video Standard, or JVS, the standard used by most arcade games since the late 90s.<sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup> It&rsquo;s a serial protocol that makes arcade hardware close to plug and play: connect a single cable from your cabinet&rsquo;s I/O board to your new arcade board, and you get all of your controls and coin slots connected at once.</p>

<p>If you want to use a JVS game at home, you could always put something together using an official I/O board, but - as it happens, the JVS spec is available<sup id="fnref:2"><a href="#fn:2" rel="footnote">2</a></sup>. There&rsquo;s nothing stopping you from making your own I/O board, and it turns out a few different people have. There are a few different open source options intended to work in a few different ways. I use OpenJVS, written by Bobby Dilley, which transforms a Raspberry Pi running Linux into a JVS I/O board.</p>

<h2>How does JVS work?</h2>

<p>So that&rsquo;s JVS, but how does it work? I won&rsquo;t go into deep detail, but here&rsquo;s the 10,000 meter view.</p>

<p>JVS defines communication between an I/O board and a video game board. It uses the <a href="https://en.wikipedia.org/wiki/RS-485">RS-485</a> serial standard to communicate data, meaning that it&rsquo;s possible to use a standard USB RS-485 device to send and receive commands.<sup id="fnref:3"><a href="#fn:3" rel="footnote">3</a></sup> The I/O board handles tracking the state of all of the cabinet&rsquo;s inputs, and it&rsquo;s also responsible for all the coin management: it has its own count of how much money players have spent, and the game just reads that number instead of keeping track of it itself.</p>

<p>The game board communicates with the I/O board by sending commands, then receiving packets of information in return. The game board tells the I/O board how many bytes of data to expect, then sends one or more messages as a set of raw bytes. The I/O board reads those bytes, interprets them, then sends a set of responses for each command.</p>

<p>Open source JVS implementations don&rsquo;t just emulate the things a player would normally touch in the arcade, either. They also simulate features like the service and test buttons, which are tucked away inside a cabinet where only arcade employees can normally use them. The service button allows access to the operator menu, where employees can change hardware and software settings, while the test button does exactly what it sounds like. Arcade players will never get to use these, but for home players it&rsquo;s useful to be able to do things like change how many coins a play costs, turn on free play, or change the game language. OpenJVS supports both of these, and they seemed to work when I tested them. The test button did cause OpenJVS to log a message about an &ldquo;unsupported command&rdquo;, which seemed suspicious, but Bobby and I suspected this was just the board playing fast and loose with the spec so we ignored it. (This will come up again later.)</p>

<p>OpenJVS was already basically complete and implemented all of the common parts of the protocol, so I started out as just a user. As I ran into a few bugs, I started contributing bugfixes and then implementations of more parts of the protocol.</p>

<h2>Let&rsquo;s talk money</h2>

<p>I mentioned coin management earlier. Obviously, in arcades, games are pay-to-play. Most game boards have a free play option so you can play as much as you want without paying, and a lot of home players will just switch their boards into the free play mode. There&rsquo;s nothing stopping you from emulating a coin slot though. OpenJVS lets you map a button on your controller to inserting a coin for something closer to the authentic arcade feeling. It seems like this might not be a common usecase, but the option is always there.</p>

<p><img src="/blog/images/jvs/coins-253.png" title="Screenshot of the arcade board's coin counter with 253 coins" ></p>

<p>Before long, I noticed a really strange bug. I&rsquo;d be playing games, and then notice that somehow I had over 200 credits in the machine. I definitely wasn&rsquo;t mashing the coin button that much, so I knew something had to be wrong. After some experimentation, I eventually figured out it only happened if you did a few specific things in exactly the right order:</p>

<ul>
<li>Insert one or more coins</li>
<li>Enter the service menu and then the input test menu</li>
<li>Exit the service menu</li>
</ul>


<p>At this point, I realized something suspicious was happening. I was always getting 200+ coins&hellip; but it was more specific than that. I was ending up with exactly 256 minus the number of coins I had when entering the service menu. For example, if I started with 3 coins, I&rsquo;d always have 253 coins after leaving the service menu. That was a pretty good sign I was seeing something in particular: integer underflow.</p>

<p><img src="/blog/images/jvs/io_test.png" title="Screenshot of the IO test from the service menu" ></p>

<p>Experienced programmers, feel free to skip this paragraph. But for those who aren&rsquo;t familiar: languages like C, which OpenJVS is written in, feature something called integer overflow and underflow. Number types have a maximum size which affects how many numbers it can represent. A 16-bit (or 2-byte) integer that can store only positive numbers, for example, can only represent numbers between 0 and 65535. Picture, for a moment, what happens if you ask a program to subtract 1 from a 16-bit integer that&rsquo;s already at 0, or add 1 to a number that&rsquo;s already at 65535. In C, and many other languages, it will underflow or underflow: subtract 1 from 0, and you get 65535; add 1 to 65535, and you get 0.</p>

<p>Having figured out that I was probably seeing underflow, I took a look at the protocol. Since the JVS I/O board keeps track of the money balance, the protocol provides commands for dealing with that and it seemed like the most likely place I&rsquo;d find the bug. When I dug into OpenJVS&rsquo;s implementation of the &ldquo;decrease number of coins&rdquo; command, it wasn&rsquo;t too hard to find the culprit. It was right here:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cm">/* Prevent underflow of coins */</span>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="n">coin_decrement</span> <span class="o">&gt;</span> <span class="n">jvsIO</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">coinCount</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span class='line'>    <span class="n">coin_decrement</span> <span class="o">=</span> <span class="n">jvsIO</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">coinCount</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'><span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">jvsIO</span><span class="o">-&gt;</span><span class="n">capabilities</span><span class="p">.</span><span class="n">coins</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span><span class='line'>    <span class="n">jvsIO</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">coinCount</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="n">coin_decrement</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>When OpenJVS received the command to decrement the number of coins by a certain amount, it tried to prevent underflows. Unfortunately, the underflow protection itself was buggy: it checked the number of coins in the first coin slot, but then decremented the number of coins in <em>every</em> slot. If slot 2 has fewer coins than slot 1, then slot 2 will end up underflowing by whatever the difference is. I still wasn&rsquo;t sure why it was trying to remove <em>256</em> coins, which seemed weird. I figured it must just be trying to clear the slot of all coins and trusting the I/O board to prevent underflows, and moved on.</p>

<p>With that bug fixed, I decided to keep working at improving coin support. While I was working on that command, I noticed that OpenJVS was ignoring a similar command. While the board usually only needs to send commands to reduce the number of coins in the balance, like when the player starts a game, it can also send a command to increase the number of coins. I&rsquo;d noticed that my game board was trying to send that command, but OpenJVS had only implemented a placeholder that logged the request and then moved on without doing anything. The quickest way to figure out what was going on was just to implement the command myself. The actual command in the spec is pretty simple:</p>

<table>
<thead>
<tr>
<th> Purpose </th>
<th> Sample </th>
</tr>
</thead>
<tbody>
<tr>
<td> Command code (always 35) </td>
<td> <code>0x35</code> </td>
</tr>
<tr>
<td> Coin slot index </td>
<td> <code>0x01</code> </td>
</tr>
<tr>
<td> Amount (first half) </td>
<td> <code>0x00</code> </td>
</tr>
<tr>
<td> Amount (second half) </td>
<td> <code>0x01</code> </td>
</tr>
</tbody>
</table>


<p>Easy enough: you can identify that it&rsquo;s the command to increase coins by the first byte, <code>35</code>, and then it tells you which coin slot to act on and how many coins to add to it. But when I was replacing the old placeholder command, I noticed something funny:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">case</span> <span class="nl">CMD_WRITE_COINS</span><span class="p">:</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">debug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;CMD_WRITE_COINS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">size</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
</span><span class='line'>    <span class="n">outputPacket</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">outputPacket</span><span class="p">.</span><span class="n">length</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">REPORT_SUCCESS</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="k">break</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>The placeholder command just reported success without doing anything, then jumped ahead in the stream by the command&rsquo;s length. But it jumped ahead <em>3</em> bytes, and according to the spec this command should be <em>4</em> bytes long. I tested OpenJVS with the command fully implemented, and noticed two things: pressing the test button now inserted 256 coins into the second coin slot, instead of doing nothing; and the &ldquo;unsupported command&rdquo; error I used to see went away. Why? When the buggy placeholder skipped ahead by three bytes, that left one byte in the buffer for OpenJVS to find and mistake for being a command. That byte, <code>0x01</code>, was actually the last byte of the &ldquo;insert coin&rdquo; command that was being sent when the test button was activated. I hadn&rsquo;t even set out to fix the &ldquo;unsupported command&rdquo; bug, but I fixed it anyway.</p>

<p>At this point I&rsquo;d fixed all the bugs I set out to, but I was still seeing something that just didn&rsquo;t feel right. When exiting the service menu, the game board now withdrew coins from the balance; when pressing the test button, the board now added coins. But the number of coins looked wrong: it was happening in increments of 256, instead of 1, and even for test commands that seemed unlikely. So I took another look at the spec, and realized the answer had been staring me in the face the entire time. Let&rsquo;s take another look at the last part of that table from earlier:</p>

<table>
<thead>
<tr>
<th> Purpose </th>
<th> Sample </th>
</tr>
</thead>
<tbody>
<tr>
<td> Amount (first half) </td>
<td> <code>0x00</code> </td>
</tr>
<tr>
<td> Amount (second half) </td>
<td> <code>0x01</code> </td>
</tr>
</tbody>
</table>


<p>The number of coins to add or remove is a two-byte, or 16-bit, value. Since JVS is communicating through single bytes, any multi-byte values have to be split up into single bytes for transmission. The spec helpfully tells us how to decode that: the numbers are stored in the big-endian, or most-significant byte first, format. But taking a look at OpenJVS&rsquo;s code shows that anywhere it was decoding these values, it was decoding them in little-endian format - in other words, it was reading the bytes backwards. What&rsquo;s 256 in little-endian format? It&rsquo;s the bytes &ldquo;0&rdquo; and &ldquo;1&rdquo;, in that order. What&rsquo;s 1 in big-endian format? It&rsquo;s those same two bytes in that same order. In other words, the game board hadn&rsquo;t been trying to add or subtract 256 coins all this time: it was just trying to add and remove single coins.</p>

<p>Putting it all together, what exactly was happening when I saw coins being added and removed? It actually turns out to be pretty simple. Pressing the test button inserts a coin in the second coin slot. When the operator menu is activated, it can be used to test the coin counter. When the operator leaves the menu, the unit sends commands to remove all of the coins that were added by the test button; this should leave it with the same number of coins as it had when they started. The strange behaviour was a combination of all the bugs working together: the test button didn&rsquo;t do anything because the command wasn&rsquo;t implemented, and the buggy bounds checking and incomplete &ldquo;remove coins&rdquo; command meant it could underflow and leave the player with hundreds of coins.</p>

<p>I originally set out to fix some pretty simple bugs, but every new bug I uncovered revealed a new one. The experience was quite a fun one. I can&rsquo;t say I ever thought I&rsquo;d be writing software for arcade machines, but not only did I fix my own problems, but I had the chance to learn more about how things work in a domain I might never otherwise have gotten the chance to touch.</p>
<div class="footnotes">
<hr/>
<ol>
<li id="fn:1">
<p>This was actually the second JAMMA standard, following a simpler standard that was used internationally between 1985 and the late 90s.<a href="#fnref:1" rev="footnote">&#8617;</a></p></li>
<li id="fn:2">
<p>Including an excellent <a href="http://daifukkat.su/files/jvs_wip.pdf">English translation</a> by Alex Marshall!<a href="#fnref:2" rev="footnote">&#8617;</a></p></li>
<li id="fn:3">
<p>Mostly. JVS actually introduces an extra wire, known as the sync line, but I&rsquo;m going to ignore that here to keep the explanation simple.<a href="#fnref:3" rev="footnote">&#8617;</a></p></li>
</ol>
</div>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2020/11/23/bundle-install-with-homebrew-magic-using-brew-bundle-exec/">Bundle Install With Homebrew Magic Using Brew Bundle Exec</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2020-11-23T20:30:00-08:00'><span class='date'><span class='date-month'>Nov</span> <span class='date-day'>23</span><span class='date-suffix'>rd</span>, <span class='date-year'>2020</span></span> <span class='time'>8:30 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Has this ever happened to you? You&rsquo;re writing a project in Ruby, JavaScript, Go, etc., and you have to build a dependency that uses a system library. So you <code>bundle install</code> and then, a few minutes later, your terminal spits up an ugly set of C compiler errors you don&rsquo;t know how to deal with. After dealing with this enough times I decided to do something about it.</p>

<p><a href="https://brew.sh">Homebrew</a> already has a great tool in its arsenal for dealing with these problems. Homebrew needs to be able to build software reliably and robustly, after all - even if the user&rsquo;s system has weird software installed on it or strange misconfigurations. The <a href="https://docs.brew.sh/Formula-Cookbook#superenv-notes">&ldquo;superenv&rdquo; build environment</a> features intelligent automatic setup of build-related environment variables and <code>PATH</code>s based on just the requested dependencies, which filters out unrequested software and prevents a lot of common build failures that come from interfering software. It also uses shims for many common build tools to enforce just the right arguments passing through to the real tools.</p>

<p>So I thought to myself - we solved that problem for Homebrew builds already, right? Wouldn&rsquo;t it be nice if I could just reuse that work for other things? So that&rsquo;s what I did. Homebrew already provides the <code>Brewfile</code> dependency declaration format and the <code>brew bundle</code> tool to library dependencies with Homebrew, and as a result there&rsquo;s already a great way to get the dependency information we&rsquo;d need to produce a reliable build environment. Since <code>brew bundle</code> is a Homebrew plugin, it has access to Homebrew&rsquo;s core code - including build environment setup. Putting these together, I wrote a feature called <code>brew bundle exec</code>. It takes the software you specify in your Brewfile and builds a dependency tree out of that, then sets up just the right build flags to let anything you want use them.</p>

<p>For example, say I want to <code>gem install mysql2</code>. Often, you get something like this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ gem install mysql2
</span><span class='line'>Building native extensions. This could take a while...
</span><span class='line'># several dozen lines later...
</span><span class='line'>linking shared-object mysql2/mysql2.bundle
</span><span class='line'>ld: library not found for -lssl
</span><span class='line'>clang: error: linker command failed with exit code 1 (use -v to see invocation)
</span><span class='line'>make: *** [mysql2.bundle] Error 1</span></code></pre></td></tr></table></div></figure>


<p>Ew, right? Let&rsquo;s make that better.</p>

<p>By creating a <code>Brewfile</code> with the line <code>brew "mysql"</code>, we can specify that we want to build against a Homebrew-installed MySQL <em>and</em> all of its dependencies. Just by running our command prefixed with <code>brew bundle exec --</code>, for example, <code>brew bundle exec -- gem install mysql2</code>, we can run that command in a build environment that knows exactly how to use its dependencies. Suddenly, everything works&mdash;no messing around with flags, no special options passed to <code>gem install</code>, and no fragile <code>bundle config</code> trickery.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ brew bundle exec -- gem install mysql2
</span><span class='line'>Building native extensions. This could take a while...
</span><span class='line'>Successfully installed mysql2-0.5.3
</span><span class='line'>Parsing documentation for mysql2-0.5.3
</span><span class='line'>Installing ri documentation for mysql2-0.5.3
</span><span class='line'>Done installing documentation for mysql2 after 0 seconds
</span><span class='line'>1 gem installed</span></code></pre></td></tr></table></div></figure>


<p>What exactly does <code>brew bundle exec</code> set? There&rsquo;s a variety of flags set which are useful for a variety of different compilers and buildsystems.</p>

<ul>
<li><code>CC</code> and <code>CXX</code>, the compiler specification flags, point to Homebrew&rsquo;s compiler shims which help ensure that the right flags are passed to the real compiler being used.</li>
<li><code>CFLAGS</code>, <code>CXXFLAGS</code>, and <code>CPPFLAGS</code> ensure that C and C++ compilers know about the header and library lookup paths for all of the <code>Brewfile</code> dependencies.</li>
<li><code>PATH</code> ensures that all of the executables installed by <code>Brewfile</code> dependencies will be found first, before any tools of the same name that may be installed elsewhere on your system.</li>
<li><code>PKG_CONFIG_LIBDIR</code> and <code>PKG_CONFIG_LIBDIR</code> ensure that the <code>pkg-config</code> tool finds <code>Brewfile</code> dependencies.</li>
<li>Buildsystem-specific flags, such as <code>CMAKE_PREFIX_PATH</code>, ensure that buildsystems can make use of the <code>Brewfile</code> dependencies.</li>
</ul>


<p>So the next time you&rsquo;re bashing your head against build failures in your project, give <code>brew bundle exec</code> a try. It might just solve your problems for you!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2019/02/20/the-hunt-for-the-lost-phoenix-games/">The Hunt for the Lost Phoenix Games</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2019-02-20T20:22:52-08:00'><span class='date'><span class='date-month'>Feb</span> <span class='date-day'>20</span><span class='date-suffix'>th</span>, <span class='date-year'>2019</span></span> <span class='time'>8:22 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Among trashgame fans, Phoenix Games are one of the most infamous game publishers of all time. They&rsquo;re famous for making games of the lowest possible quality for the lowest possible price; their most infamous &ldquo;games&rdquo; <a href="https://youtu.be/j4sMwSWoSJY">were just poorly-animated movies on a PS2 disc</a>. They&rsquo;re the kind of fascinating bad you just can&rsquo;t help but love for their own sake.</p>

<p>In their last year of life, Phoenix started publishing Nintendo DS games. They had an aggressive release schedule; in 2008 they announced plans to release 20 games inside of a year, most of which never came out. <em>Which</em> games did or didn&rsquo;t come out is still hard to figure out. Many online release lists take Phoenix Games&rsquo;s estimated release dates at face value, including many games that probably never came out. I&rsquo;ve put together a list of what I&rsquo;ve been able to confirm in the hopes that anyone with more information can help out.</p>

<p>Out of the 20 games Phoenix announced, only five definitely came out under Phoenix themselves. There are confirmed physical copies of these games and ROM dumps on the internet. Three more were licensed to other publishers after Phoenix&rsquo;s bankruptcy. The other twelve are less certain; I&rsquo;ve divided these into three categories with explanations below. Phoenix declared bankruptcy in early 2009, and I haven&rsquo;t been able to confirm that any games were released after the end of 2008. If you have any information, please contact me via email or <a href="https://twitter.com/mistydemeo">on Twitter</a>!</p>

<p>Definitely released:</p>

<ul>
<li><em>12</em> - NorthPole Studio, 2008</li>
<li><em>Adventures of Pinocchio</em> - Unknown, 2008</li>
<li><em>Peter Pan&rsquo;s Playground</em> - Unknown, 2008</li>
<li><em>Polar Rampage</em> - CyberPlanet, 2008</li>
<li><em>Valentines Day</em> - NorthPole Studio, 2008</li>
</ul>


<p>Released by other developers:</p>

<ul>
<li><em>Coral Savior</em> - NorthPole Studio; released as <em>Bermuda Triangle: Saving the Coral</em> by Storm City Games, in North America, 2010; and as <em>Bermuda Triangle</em> by Funbox Media, in Europe, 2011</li>
<li><em>Hoppie II</em> - CyberPlanet; released as <em>Hoppie</em>, by Maximum Family Games, in North America, 2011</li>
<li><em>Veggy World</em> - CyberPlanet; released by Maximum Family Games, in North America, 2011</li>
</ul>


<p>Possibly released:</p>

<p>These games had finalized cover art and announced release dates. The games in this category have been found in some online store catalogues, suggesting they may have either been released or at least had already been offered to stores.</p>

<ul>
<li><em>Jungle Gang: Perfect Plans</em> - Listed in an <a href="https://www.mcvuk.com/business/whats-new-october-17th-08">MCV article</a> as having been released October 17, 2008. Listed in a few online store catalogues as sold out.</li>
<li><em>Love Heart</em> - Reviewed by Polish site <a href="https://www.gry-online.pl/gry/love-heart/zb24cb">GRYOnline.pl</a>, who gave it a 2008 release date.</li>
</ul>


<p>Probably not released:</p>

<p>Included in release lists, but with no store pages to indicate they were ever actually released. Some of these games were given multiple release dates, probably because they were delayed and solicited multiple times.</p>

<ul>
<li><em>Dalmatians 4</em> - Listed in a <a href="http://playstationcollecting.com/forum/messageview.cfm?catid=76&amp;threadid=73644&amp;StartRow=26">PlayStation Collecting forums</a> catalogue as having been released on February 13, 2009.</li>
<li><em>Lion and the King 3</em> - Listed in a <a href="http://playstationcollecting.com/forum/messageview.cfm?catid=76&amp;threadid=73644&amp;StartRow=26">PlayStation Collecting forums</a> catalogue as having been released on both October 24, 2008 and February 13, 2009.</li>
<li><em>Monster Egg II</em> - Listed in a <a href="http://playstationcollecting.com/forum/messageview.cfm?catid=76&amp;threadid=73644&amp;StartRow=26">PlayStation Collecting forums</a> catalogue as having been released on both November 28, 2008 and March 13, 2009.</li>
<li><em>Rat-A-Box</em> - Listed in an <a href="https://www.mcvuk.com/business/whats-new-october-17th-08">MCV article</a> as having been released October 17, 2008, but no store catalogue entries.</li>
</ul>


<p>Definitely not released:</p>

<ul>
<li><em>Cinderella&rsquo;s Fairy Tale</em> - Final cover art, but never included in any release lists.</li>
<li><em>Greatest Flood</em> - No cover art or homepage.</li>
<li><em>Iron Chef II</em> - Final cover art, but never included in any release lists.</li>
<li><em>Monster Dessert</em> - No cover art or homepage.</li>
<li><em>Princess Snow White</em> - No cover art or homepage.</li>
<li><em>War in Heaven</em> - Final cover art, but never included in any release lists.</li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2018/10/18/recover-from-filevault-doom/">Recover From FileVault Doom</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2018-10-18T19:19:04-03:00'><span class='date'><span class='date-month'>Oct</span> <span class='date-day'>18</span><span class='date-suffix'>th</span>, <span class='date-year'>2018</span></span> <span class='time'>7:19 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Just upgraded to Mojave? Getting the 🚫 of doom when you try to boot your Mac? Worried you&rsquo;ve lost all your data? <strong>Don&rsquo;t panic!</strong> Your Mac is recoverable, and this guide will help you get your drive back in shape.</p>

<p>This bug is caused by a new limitation introduced for FileVault encryption. As mentioned in the <a href="https://developer.apple.com/documentation/macos_release_notes/macos_mojave_10_14_release_notes">release notes</a>, any APFS volume encrypted using Mojave&rsquo;s implementation of FileVault becomes invisible to earlier versions of macOS until the encryption or decryption process completes. By itself, this is mostly harmless. However, this is rendered much worse by a bug<sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup> that causes the Mojave installer to incorrectly trigger reencryption of an already-encrypted FileVault volume during the install process. Because full drive encryption cannot complete in a timely manner, the Mojave installer times out before encryption completes. The result is a macOS 10.13 (or older) install with a macOS 10.14 FileVault volume that hasn&rsquo;t yet finished encrypting. This volume can&rsquo;t be read by the startup manager, and so becomes unbootable.</p>

<p>In order to fix this issue, we&rsquo;ll need to let your drive finish encrypting. This guide will walk you through the process. Before we get started, make sure you have the right supplies on hand. You&rsquo;ll need a USB key with a capacity of at least 8GB and access to a working Mac.</p>

<h3>1. Create a USB Mojave installer</h3>

<p>Download the Mojave installer application on your working Mac using the App Store. Don&rsquo;t worry, you won&rsquo;t be using that to install - just to create a USB installer for your broken Mac. Then follow <a href="https://support.apple.com/en-us/HT201372">these instructions from Apple</a>. This will erase your USB key and turn it into a bootable USB install drive.</p>

<h3>2. Boot into the USB installer</h3>

<p>Turn off the Mac that you&rsquo;re upgrading to Mojave and insert the USB drive you just created. Turn the Mac back on, and immediately hold the option key until the Startup Manager appears. Select the drive you created.</p>

<h3>3. Enter Recovery Mode</h3>

<p>The installer should provide an option to enter Recovery Mode. This is a different version of Recovery Mode than the one that&rsquo;s builtin to your Mac, and it will be able to see your hard drive.</p>

<h3>4. Unlock and mount your hard drive</h3>

<p>From the Utilities menu bar at the top of the screen, select Terminal. From the terminal prompt, type <code>diskutil apfs list</code>. In the output, you should see one volume whose FileVault status is listed as <code>FileVault: in progress</code> (or something similar). If it&rsquo;s already listed as &ldquo;unlocked&rdquo;, then you&rsquo;re good - proceed to step 5.</p>

<p>Unlock this drive by running <code>diskutil apfs unlockVolume DISK</code>, where <code>DISK</code> is the identifier listed after <code>APFS Volume Disk</code> for the volume you identified in the previous paragraph. For example, you might type <code>diskutil apfs unlockVolume disk1s1</code>. This command will ask you for a password; enter either your personal log in password, or a FileVault recovery key.</p>

<p>Once you&rsquo;ve completed this step, exit Terminal. You should be returned to the Recovery Mode main menu.</p>

<h3>5. Create a new APFS volume</h3>

<p>Open Disk Utility from the Recovery Mode main menu. Select your main hard drive, right-click it, and choose &ldquo;Add APFS Volume&rdquo;. Don&rsquo;t worry, this isn&rsquo;t repartitioning your drive - this bootable volume will live on the same volume as your main volume, and you will be able to delete it later. Name it &ldquo;Temporary&rdquo;, then click &ldquo;Add&rdquo;.</p>

<p><img src="/blog/images/mojave/1_volume.png" width="264" title="Creating a volume" ></p>

<p><img src="/blog/images/mojave/2_volume.png" width="442" title="Volume options" ></p>

<p>Once you&rsquo;ve completed this step, exit Disk Utility. You should be returned to the Recovery Mode main menu. Return to the main Mojave installer menu.</p>

<h3>6. Install Mojave on the new volume</h3>

<p>Choose to install Mojave on the volume named &ldquo;Temporary&rdquo; that you created in the previous step. This will be a temporary fresh install, so don&rsquo;t worry too much about it - go ahead and keep all the options at their defaults.</p>

<h3>7. Allow drive encryption to finish</h3>

<p>Once your install has finished and you&rsquo;ve logged in, open Disk Utility. Unlock your normal hard drive by clicking on it and clicking the &ldquo;mount&rdquo; button in the toolbar. You will be asked for a password; like in the previous step in the terminal, you will need to provide either your login password (from your old Mac install), or your recovery key.</p>

<p>At this point, drive encryption will start back up again. You will need to wait for that to finish; this could take a few hours. If you want to check on the progress, you can open a terminal and look at the output of <code>diskutil apfs list</code>; encryption is finished when you run that command and see the status read <code>FileVault: Yes</code>.</p>

<h3>8. Upgrade your main drive to Mojave</h3>

<p>Now you&rsquo;re finally (finally!) ready to let the Mojave install complete. Open up your USB drive in the Finder and run the macOS installer app. This time, instead of picking the temporary volume, pick your original Mac volume. Let the installer complete. This time, your Mac should boot up like normal. You&rsquo;re saved!</p>

<h3>9. Clean up</h3>

<p>Now that your main Mac volume is bootable again, you can get rid of the temporary volume we created in the previous step. To do that, open Disk Utility and right-click the volume named &ldquo;Temporary&rdquo;. Click &ldquo;Delete APFS Volume&rdquo;, then confirm by clicking &ldquo;Delete&rdquo; again.</p>

<p><img src="/blog/images/mojave/3_volume.png" width="205" title="Deleting the temporary volume" ></p>

<h3>You&rsquo;re done!</h3>

<p>With any luck, you should be all set at this point. Feel free to reach out to me if you&rsquo;re still having trouble! Big thanks to <a href="https://twitter.com/mikeymikey">@mikeymikey</a> for the suggestion of using a second APFS volume to install the temporary macOS 10.14. Thanks also to my manager, who allowed me to use my internal blog post as the basis for this post.</p>
<div class="footnotes">
<hr/>
<ol>
<li id="fn:1">
<p>I wish I could provide more detail about this bug, but as far as I know no details have been published. I&rsquo;ve filed a radar but haven&rsquo;t received a response. All I know is that this occurs, seemingly at random, to a small percentage of people who try to upgrade from macOS 10.13.6 to macOS 10.14 when FileVault is already enabled.<a href="#fnref:1" rev="footnote">&#8617;</a></p></li>
</ol>
</div>

</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/posts/2">&larr; Older</a>
    
    <a href="/blog/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/blog/2024/03/01/that-time-i-accidentally-deleted-a-game-from-mame/">That Time I Accidentally Deleted a Game From MAME</a>
      </li>
    
      <li class="post">
        <a href="/blog/blog/2023/12/10/fixing-classical-cats-or/">Fixing Classical Cats; or, How I Got Tricked by 28-year-old Defensive Programming</a>
      </li>
    
      <li class="post">
        <a href="/blog/blog/2023/10/25/cargo-dist-system-dependencies-are-hard-so-we-made-them-easier/">Cargo-dist: System Dependencies Are Hard (So We Made Them Easier)</a>
      </li>
    
      <li class="post">
        <a href="/blog/blog/2023/05/29/untangling-another-lingo-parser-edge-case/">Untangling Another Lingo Parser Edge Case</a>
      </li>
    
      <li class="post">
        <a href="/blog/blog/2022/10/27/how-i-dumped-an-arcade-game-for-mame/">How I Dumped an Arcade Game for MAME</a>
      </li>
    
  </ul>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2024 - Misty De Meo -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
