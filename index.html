
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>The Future Is Now</title>
  <meta name="author" content="Misty De Meo">

  
  <meta name="description" content="Everyone had their weird pandemic hobby, right? Well, mine is that I bought an arcade video game. Not the whole cabinet - just a board, to hook up to &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://mistys-internet.website/blog">
  <link href="/blog/favicon.png" rel="icon">
  <link href="/blog/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/blog/atom.xml" rel="alternate" title="The Future Is Now" type="application/atom+xml">
  <script src="/blog/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/blog/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/blog/">The Future Is Now</a></h1>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/blog/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:mistys-internet.website/blog" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/blog/">Blog</a></li>
  <li><a href="/blog/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2021/08/14/exploring-jvs/">Exploring JVS</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2021-08-14T13:54:08-07:00'><span class='date'><span class='date-month'>Aug</span> <span class='date-day'>14</span><span class='date-suffix'>th</span>, <span class='date-year'>2021</span></span> <span class='time'>1:54 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Everyone had their weird pandemic hobby, right? Well, mine is that I bought an arcade video game. Not the whole cabinet - just a board, to hook up to a TV and a game controller. If I can&rsquo;t go to the arcade, at least I can bring a favourite game home, right?</p>

<p>As you might imagine, an arcade board isn&rsquo;t just plug and play; you can&rsquo;t just plug in a USB gamepad and call it a day. Finding out how to actually use it took some research. I looked up the different methods, and found I had more or less two options: a more expensive one involving repurposed arcade hardware, and an open-source one using off-the-shelf parts. While I was figuring out if the more expensive options were worth it, I decided I&rsquo;d try out the open source one, <a href="https://github.com/openjvs/openjvs">OpenJVS</a>. I started out as just a user, but ended up getting involved in development. Over the past few months, I&rsquo;ve contributed a bunch of new features and bugfixes. In the process I learned a lot about the specification&hellip; and quashed my fair share of weird bugs.</p>

<h2>So what is JVS anyway?</h2>

<p>Imagine this: you&rsquo;re an arcade machine manufacturer, and you need to make it easy for a machine operator to swap a new board into one of their cabinets. How do you make sure they don&rsquo;t have to run dozens of wires to get the controls hooked up? Video is easy; you can just use VGA, DVI, or HDMI. Power is easy too. What else is left? Well, there&rsquo;s many different kinds of input so players can actually play the game; coin inputs and money bookkeeping; smart cards to communicate information to a game; in other words, all kinds of input from the player.</p>

<p>The solution? JAMMA Video Standard, or JVS, the standard used by most arcade games since the late 90s.<sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup> It&rsquo;s a serial protocol that makes arcade hardware close to plug and play: connect a single cable from your cabinet&rsquo;s I/O board to your new arcade board, and you get all of your controls and coin slots connected at once.</p>

<p>If you want to use a JVS game at home, you could always put something together using an official I/O board, but - as it happens, the JVS spec is available<sup id="fnref:2"><a href="#fn:2" rel="footnote">2</a></sup>. There&rsquo;s nothing stopping you from making your own I/O board, and it turns out a few different people have. There are a few different open source options intended to work in a few different ways. I use OpenJVS, written by Bobby Dilley, which transforms a Raspberry Pi running Linux into a JVS I/O board.</p>

<h2>How does JVS work?</h2>

<p>So that&rsquo;s JVS, but how does it work? I won&rsquo;t go into deep detail, but here&rsquo;s the 10,000 meter view.</p>

<p>JVS defines communication between an I/O board and a video game board. It uses the <a href="https://en.wikipedia.org/wiki/RS-485">RS-485</a> serial standard to communicate data, meaning that it&rsquo;s possible to use a standard USB RS-485 device to send and receive commands.<sup id="fnref:3"><a href="#fn:3" rel="footnote">3</a></sup> The I/O board handles tracking the state of all of the cabinet&rsquo;s inputs, and it&rsquo;s also responsible for all the coin management: it has its own count of how much money players have spent, and the game just reads that number instead of keeping track of it itself.</p>

<p>The game board communicates with the I/O board by sending commands, then receiving packets of information in return. The game board tells the I/O board how many bytes of data to expect, then sends one or more messages as a set of raw bytes. The I/O board reads those bytes, interprets them, then sends a set of responses for each command.</p>

<p>Open source JVS implementations don&rsquo;t just emulate the things a player would normally touch in the arcade, either. They also simulate features like the service and test buttons, which are tucked away inside a cabinet where only arcade employees can normally use them. The service button allows access to the operator menu, where employees can change hardware and software settings, while the test button does exactly what it sounds like. Arcade players will never get to use these, but for home players it&rsquo;s useful to be able to do things like change how many coins a play costs, turn on free play, or change the game language. OpenJVS supports both of these, and they seemed to work when I tested them. The test button did cause OpenJVS to log a message about an &ldquo;unsupported command&rdquo;, which seemed suspicious, but Bobby and I suspected this was just the board playing fast and loose with the spec so we ignored it. (This will come up again later.)</p>

<p>OpenJVS was already basically complete and implemented all of the common parts of the protocol, so I started out as just a user. As I ran into a few bugs, I started contributing bugfixes and then implementations of more parts of the protocol.</p>

<h2>Let&rsquo;s talk money</h2>

<p>I mentioned coin management earlier. Obviously, in arcades, games are pay-to-play. Most game boards have a free play option so you can play as much as you want without paying, and a lot of home players will just switch their boards into the free play mode. There&rsquo;s nothing stopping you from emulating a coin slot though. OpenJVS lets you map a button on your controller to inserting a coin for something closer to the authentic arcade feeling. It seems like this might not be a common usecase, but the option is always there.</p>

<p><img src="/blog/images/jvs/coins-253.png" title="Screenshot of the arcade board's coin counter with 253 coins" ></p>

<p>Before long, I noticed a really strange bug. I&rsquo;d be playing games, and then notice that somehow I had over 200 credits in the machine. I definitely wasn&rsquo;t mashing the coin button that much, so I knew something had to be wrong. After some experimentation, I eventually figured out it only happened if you did a few specific things in exactly the right order:</p>

<ul>
<li>Insert one or more coins</li>
<li>Enter the service menu and then the input test menu</li>
<li>Exit the service menu</li>
</ul>


<p>At this point, I realized something suspicious was happening. I was always getting 200+ coins&hellip; but it was more specific than that. I was ending up with exactly 256 minus the number of coins I had when entering the service menu. For example, if I started with 3 coins, I&rsquo;d always have 253 coins after leaving the service menu. That was a pretty good sign I was seeing something in particular: integer underflow.</p>

<p><img src="/blog/images/jvs/io_test.png" title="Screenshot of the IO test from the service menu" ></p>

<p>Experienced programmers, feel free to skip this paragraph. But for those who aren&rsquo;t familiar: languages like C, which OpenJVS is written in, feature something called integer overflow and underflow. Number types have a maximum size which affects how many numbers it can represent. A 16-bit (or 2-byte) integer that can store only positive numbers, for example, can only represent numbers between 0 and 65535. Picture, for a moment, what happens if you ask a program to subtract 1 from a 16-bit integer that&rsquo;s already at 0, or add 1 to a number that&rsquo;s already at 65535. In C, and many other languages, it will underflow or underflow: subtract 1 from 0, and you get 65535; add 1 to 65535, and you get 0.</p>

<p>Having figured out that I was probably seeing underflow, I took a look at the protocol. Since the JVS I/O board keeps track of the money balance, the protocol provides commands for dealing with that and it seemed like the most likely place I&rsquo;d find the bug. When I dug into OpenJVS&rsquo;s implementation of the &ldquo;decrease number of coins&rdquo; command, it wasn&rsquo;t too hard to find the culprit. It was right here:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cm">/* Prevent underflow of coins */</span>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="n">coin_decrement</span> <span class="o">&gt;</span> <span class="n">jvsIO</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">coinCount</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span class='line'>    <span class="n">coin_decrement</span> <span class="o">=</span> <span class="n">jvsIO</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">coinCount</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'><span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">jvsIO</span><span class="o">-&gt;</span><span class="n">capabilities</span><span class="p">.</span><span class="n">coins</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span><span class='line'>    <span class="n">jvsIO</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">coinCount</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="n">coin_decrement</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>When OpenJVS received the command to decrement the number of coins by a certain amount, it tried to prevent underflows. Unfortunately, the underflow protection itself was buggy: it checked the number of coins in the first coin slot, but then decremented the number of coins in <em>every</em> slot. If slot 2 has fewer coins than slot 1, then slot 2 will end up underflowing by whatever the difference is. I still wasn&rsquo;t sure why it was trying to remove <em>256</em> coins, which seemed weird. I figured it must just be trying to clear the slot of all coins and trusting the I/O board to prevent underflows, and moved on.</p>

<p>With that bug fixed, I decided to keep working at improving coin support. While I was working on that command, I noticed that OpenJVS was ignoring a similar command. While the board usually only needs to send commands to reduce the number of coins in the balance, like when the player starts a game, it can also send a command to increase the number of coins. I&rsquo;d noticed that my game board was trying to send that command, but OpenJVS had only implemented a placeholder that logged the request and then moved on without doing anything. The quickest way to figure out what was going on was just to implement the command myself. The actual command in the spec is pretty simple:</p>

<table>
<thead>
<tr>
<th> Purpose </th>
<th> Sample </th>
</tr>
</thead>
<tbody>
<tr>
<td> Command code (always 35) </td>
<td> <code>0x35</code> </td>
</tr>
<tr>
<td> Coin slot index </td>
<td> <code>0x01</code> </td>
</tr>
<tr>
<td> Amount (first half) </td>
<td> <code>0x00</code> </td>
</tr>
<tr>
<td> Amount (second half) </td>
<td> <code>0x01</code> </td>
</tr>
</tbody>
</table>


<p>Easy enough: you can identify that it&rsquo;s the command to increase coins by the first byte, <code>35</code>, and then it tells you which coin slot to act on and how many coins to add to it. But when I was replacing the old placeholder command, I noticed something funny:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">case</span> <span class="nl">CMD_WRITE_COINS</span><span class="p">:</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">debug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;CMD_WRITE_COINS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">size</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
</span><span class='line'>    <span class="n">outputPacket</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">outputPacket</span><span class="p">.</span><span class="n">length</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">REPORT_SUCCESS</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="k">break</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>The placeholder command just reported success without doing anything, then jumped ahead in the stream by the command&rsquo;s length. But it jumped ahead <em>3</em> bytes, and according to the spec this command should be <em>4</em> bytes long. I tested OpenJVS with the command fully implemented, and noticed two things: pressing the test button now inserted 256 coins into the second coin slot, instead of doing nothing; and the &ldquo;unsupported command&rdquo; error I used to see went away. Why? When the buggy placeholder skipped ahead by three bytes, that left one byte in the buffer for OpenJVS to find and mistake for being a command. That byte, <code>0x01</code>, was actually the last byte of the &ldquo;insert coin&rdquo; command that was being sent when the test button was activated. I hadn&rsquo;t even set out to fix the &ldquo;unsupported command&rdquo; bug, but I fixed it anyway.</p>

<p>At this point I&rsquo;d fixed all the bugs I set out to, but I was still seeing something that just didn&rsquo;t feel right. When exiting the service menu, the game board now withdrew coins from the balance; when pressing the test button, the board now added coins. But the number of coins looked wrong: it was happening in increments of 256, instead of 1, and even for test commands that seemed unlikely. So I took another look at the spec, and realized the answer had been staring me in the face the entire time. Let&rsquo;s take another look at the last part of that table from earlier:</p>

<table>
<thead>
<tr>
<th> Purpose </th>
<th> Sample </th>
</tr>
</thead>
<tbody>
<tr>
<td> Amount (first half) </td>
<td> <code>0x00</code> </td>
</tr>
<tr>
<td> Amount (second half) </td>
<td> <code>0x01</code> </td>
</tr>
</tbody>
</table>


<p>The number of coins to add or remove is a two-byte, or 16-bit, value. Since JVS is communicating through single bytes, any multi-byte values have to be split up into single bytes for transmission. The spec helpfully tells us how to decode that: the numbers are stored in the big-endian, or most-significant byte first, format. But taking a look at OpenJVS&rsquo;s code shows that anywhere it was decoding these values, it was decoding them in little-endian format - in other words, it was reading the bytes backwards. What&rsquo;s 256 in little-endian format? It&rsquo;s the bytes &ldquo;0&rdquo; and &ldquo;1&rdquo;, in that order. What&rsquo;s 1 in big-endian format? It&rsquo;s those same two bytes in that same order. In other words, the game board hadn&rsquo;t been trying to add or subtract 256 coins all this time: it was just trying to add and remove single coins.</p>

<p>Putting it all together, what exactly was happening when I saw coins being added and removed? It actually turns out to be pretty simple. Pressing the test button inserts a coin in the second coin slot. When the operator menu is activated, it can be used to test the coin counter. When the operator leaves the menu, the unit sends commands to remove all of the coins that were added by the test button; this should leave it with the same number of coins as it had when they started. The strange behaviour was a combination of all the bugs working together: the test button didn&rsquo;t do anything because the command wasn&rsquo;t implemented, and the buggy bounds checking and incomplete &ldquo;remove coins&rdquo; command meant it could underflow and leave the player with hundreds of coins.</p>

<p>I originally set out to fix some pretty simple bugs, but every new bug I uncovered revealed a new one. The experience was quite a fun one. I can&rsquo;t say I ever thought I&rsquo;d be writing software for arcade machines, but not only did I fix my own problems, but I had the chance to learn more about how things work in a domain I might never otherwise have gotten the chance to touch.</p>
<div class="footnotes">
<hr/>
<ol>
<li id="fn:1">
<p>This was actually the second JAMMA standard, following a simpler standard that was used internationally between 1985 and the late 90s.<a href="#fnref:1" rev="footnote">&#8617;</a></p></li>
<li id="fn:2">
<p>Including an excellent <a href="http://daifukkat.su/files/jvs_wip.pdf">English translation</a> by Alex Marshall!<a href="#fnref:2" rev="footnote">&#8617;</a></p></li>
<li id="fn:3">
<p>Mostly. JVS actually introduces an extra wire, known as the sync line, but I&rsquo;m going to ignore that here to keep the explanation simple.<a href="#fnref:3" rev="footnote">&#8617;</a></p></li>
</ol>
</div>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2020/11/23/bundle-install-with-homebrew-magic-using-brew-bundle-exec/">Bundle Install With Homebrew Magic Using Brew Bundle Exec</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2020-11-23T20:30:00-08:00'><span class='date'><span class='date-month'>Nov</span> <span class='date-day'>23</span><span class='date-suffix'>rd</span>, <span class='date-year'>2020</span></span> <span class='time'>8:30 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Has this ever happened to you? You&rsquo;re writing a project in Ruby, JavaScript, Go, etc., and you have to build a dependency that uses a system library. So you <code>bundle install</code> and then, a few minutes later, your terminal spits up an ugly set of C compiler errors you don&rsquo;t know how to deal with. After dealing with this enough times I decided to do something about it.</p>

<p><a href="https://brew.sh">Homebrew</a> already has a great tool in its arsenal for dealing with these problems. Homebrew needs to be able to build software reliably and robustly, after all - even if the user&rsquo;s system has weird software installed on it or strange misconfigurations. The <a href="https://docs.brew.sh/Formula-Cookbook#superenv-notes">&ldquo;superenv&rdquo; build environment</a> features intelligent automatic setup of build-related environment variables and <code>PATH</code>s based on just the requested dependencies, which filters out unrequested software and prevents a lot of common build failures that come from interfering software. It also uses shims for many common build tools to enforce just the right arguments passing through to the real tools.</p>

<p>So I thought to myself - we solved that problem for Homebrew builds already, right? Wouldn&rsquo;t it be nice if I could just reuse that work for other things? So that&rsquo;s what I did. Homebrew already provides the <code>Brewfile</code> dependency declaration format and the <code>brew bundle</code> tool to library dependencies with Homebrew, and as a result there&rsquo;s already a great way to get the dependency information we&rsquo;d need to produce a reliable build environment. Since <code>brew bundle</code> is a Homebrew plugin, it has access to Homebrew&rsquo;s core code - including build environment setup. Putting these together, I wrote a feature called <code>brew bundle exec</code>. It takes the software you specify in your Brewfile and builds a dependency tree out of that, then sets up just the right build flags to let anything you want use them.</p>

<p>For example, say I want to <code>gem install mysql2</code>. Often, you get something like this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ gem install mysql2
</span><span class='line'>Building native extensions. This could take a while...
</span><span class='line'># several dozen lines later...
</span><span class='line'>linking shared-object mysql2/mysql2.bundle
</span><span class='line'>ld: library not found for -lssl
</span><span class='line'>clang: error: linker command failed with exit code 1 (use -v to see invocation)
</span><span class='line'>make: *** [mysql2.bundle] Error 1</span></code></pre></td></tr></table></div></figure>


<p>Ew, right? Let&rsquo;s make that better.</p>

<p>By creating a <code>Brewfile</code> with the line <code>brew "mysql"</code>, we can specify that we want to build against a Homebrew-installed MySQL <em>and</em> all of its dependencies. Just by running our command prefixed with <code>brew bundle exec --</code>, for example, <code>brew bundle exec -- gem install mysql2</code>, we can run that command in a build environment that knows exactly how to use its dependencies. Suddenly, everything works&mdash;no messing around with flags, no special options passed to <code>gem install</code>, and no fragile <code>bundle config</code> trickery.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ brew bundle exec -- gem install mysql2
</span><span class='line'>Building native extensions. This could take a while...
</span><span class='line'>Successfully installed mysql2-0.5.3
</span><span class='line'>Parsing documentation for mysql2-0.5.3
</span><span class='line'>Installing ri documentation for mysql2-0.5.3
</span><span class='line'>Done installing documentation for mysql2 after 0 seconds
</span><span class='line'>1 gem installed</span></code></pre></td></tr></table></div></figure>


<p>What exactly does <code>brew bundle exec</code> set? There&rsquo;s a variety of flags set which are useful for a variety of different compilers and buildsystems.</p>

<ul>
<li><code>CC</code> and <code>CXX</code>, the compiler specification flags, point to Homebrew&rsquo;s compiler shims which help ensure that the right flags are passed to the real compiler being used.</li>
<li><code>CFLAGS</code>, <code>CXXFLAGS</code>, and <code>CPPFLAGS</code> ensure that C and C++ compilers know about the header and library lookup paths for all of the <code>Brewfile</code> dependencies.</li>
<li><code>PATH</code> ensures that all of the executables installed by <code>Brewfile</code> dependencies will be found first, before any tools of the same name that may be installed elsewhere on your system.</li>
<li><code>PKG_CONFIG_LIBDIR</code> and <code>PKG_CONFIG_LIBDIR</code> ensure that the <code>pkg-config</code> tool finds <code>Brewfile</code> dependencies.</li>
<li>Buildsystem-specific flags, such as <code>CMAKE_PREFIX_PATH</code>, ensure that buildsystems can make use of the <code>Brewfile</code> dependencies.</li>
</ul>


<p>So the next time you&rsquo;re bashing your head against build failures in your project, give <code>brew bundle exec</code> a try. It might just solve your problems for you!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2019/02/20/the-hunt-for-the-lost-phoenix-games/">The Hunt for the Lost Phoenix Games</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2019-02-20T20:22:52-08:00'><span class='date'><span class='date-month'>Feb</span> <span class='date-day'>20</span><span class='date-suffix'>th</span>, <span class='date-year'>2019</span></span> <span class='time'>8:22 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Among trashgame fans, Phoenix Games are one of the most infamous game publishers of all time. They&rsquo;re famous for making games of the lowest possible quality for the lowest possible price; their most infamous &ldquo;games&rdquo; <a href="https://youtu.be/j4sMwSWoSJY">were just poorly-animated movies on a PS2 disc</a>. They&rsquo;re the kind of fascinating bad you just can&rsquo;t help but love for their own sake.</p>

<p>In their last year of life, Phoenix started publishing Nintendo DS games. They had an aggressive release schedule; in 2008 they announced plans to release 20 games inside of a year, most of which never came out. <em>Which</em> games did or didn&rsquo;t come out is still hard to figure out. Many online release lists take Phoenix Games&rsquo;s estimated release dates at face value, including many games that probably never came out. I&rsquo;ve put together a list of what I&rsquo;ve been able to confirm in the hopes that anyone with more information can help out.</p>

<p>Out of the 20 games Phoenix announced, only five definitely came out under Phoenix themselves. There are confirmed physical copies of these games and ROM dumps on the internet. Three more were licensed to other publishers after Phoenix&rsquo;s bankruptcy. The other twelve are less certain; I&rsquo;ve divided these into three categories with explanations below. Phoenix declared bankruptcy in early 2009, and I haven&rsquo;t been able to confirm that any games were released after the end of 2008. If you have any information, please contact me via email or <a href="https://twitter.com/mistydemeo">on Twitter</a>!</p>

<p>Definitely released:</p>

<ul>
<li><em>12</em> - NorthPole Studio, 2008</li>
<li><em>Adventures of Pinocchio</em> - Unknown, 2008</li>
<li><em>Peter Pan&rsquo;s Playground</em> - Unknown, 2008</li>
<li><em>Polar Rampage</em> - CyberPlanet, 2008</li>
<li><em>Valentines Day</em> - NorthPole Studio, 2008</li>
</ul>


<p>Released by other developers:</p>

<ul>
<li><em>Coral Savior</em> - NorthPole Studio; released as <em>Bermuda Triangle: Saving the Coral</em> by Storm City Games, in North America, 2010; and as <em>Bermuda Triangle</em> by Funbox Media, in Europe, 2011</li>
<li><em>Hoppie II</em> - CyberPlanet; released as <em>Hoppie</em>, by Maximum Family Games, in North America, 2011</li>
<li><em>Veggy World</em> - CyberPlanet; released by Maximum Family Games, in North America, 2011</li>
</ul>


<p>Possibly released:</p>

<p>These games had finalized cover art and announced release dates. The games in this category have been found in some online store catalogues, suggesting they may have either been released or at least had already been offered to stores.</p>

<ul>
<li><em>Jungle Gang: Perfect Plans</em> - Listed in an <a href="https://www.mcvuk.com/business/whats-new-october-17th-08">MCV article</a> as having been released October 17, 2008. Listed in a few online store catalogues as sold out.</li>
<li><em>Love Heart</em> - Reviewed by Polish site <a href="https://www.gry-online.pl/gry/love-heart/zb24cb">GRYOnline.pl</a>, who gave it a 2008 release date.</li>
</ul>


<p>Probably not released:</p>

<p>Included in release lists, but with no store pages to indicate they were ever actually released. Some of these games were given multiple release dates, probably because they were delayed and solicited multiple times.</p>

<ul>
<li><em>Dalmatians 4</em> - Listed in a <a href="http://playstationcollecting.com/forum/messageview.cfm?catid=76&amp;threadid=73644&amp;StartRow=26">PlayStation Collecting forums</a> catalogue as having been released on February 13, 2009.</li>
<li><em>Lion and the King 3</em> - Listed in a <a href="http://playstationcollecting.com/forum/messageview.cfm?catid=76&amp;threadid=73644&amp;StartRow=26">PlayStation Collecting forums</a> catalogue as having been released on both October 24, 2008 and February 13, 2009.</li>
<li><em>Monster Egg II</em> - Listed in a <a href="http://playstationcollecting.com/forum/messageview.cfm?catid=76&amp;threadid=73644&amp;StartRow=26">PlayStation Collecting forums</a> catalogue as having been released on both November 28, 2008 and March 13, 2009.</li>
<li><em>Rat-A-Box</em> - Listed in an <a href="https://www.mcvuk.com/business/whats-new-october-17th-08">MCV article</a> as having been released October 17, 2008, but no store catalogue entries.</li>
</ul>


<p>Definitely not released:</p>

<ul>
<li><em>Cinderella&rsquo;s Fairy Tale</em> - Final cover art, but never included in any release lists.</li>
<li><em>Greatest Flood</em> - No cover art or homepage.</li>
<li><em>Iron Chef II</em> - Final cover art, but never included in any release lists.</li>
<li><em>Monster Dessert</em> - No cover art or homepage.</li>
<li><em>Princess Snow White</em> - No cover art or homepage.</li>
<li><em>War in Heaven</em> - Final cover art, but never included in any release lists.</li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2018/10/18/recover-from-filevault-doom/">Recover From FileVault Doom</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2018-10-18T19:19:04-03:00'><span class='date'><span class='date-month'>Oct</span> <span class='date-day'>18</span><span class='date-suffix'>th</span>, <span class='date-year'>2018</span></span> <span class='time'>7:19 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Just upgraded to Mojave? Getting the ðŸš« of doom when you try to boot your Mac? Worried you&rsquo;ve lost all your data? <strong>Don&rsquo;t panic!</strong> Your Mac is recoverable, and this guide will help you get your drive back in shape.</p>

<p>This bug is caused by a new limitation introduced for FileVault encryption. As mentioned in the <a href="https://developer.apple.com/documentation/macos_release_notes/macos_mojave_10_14_release_notes">release notes</a>, any APFS volume encrypted using Mojave&rsquo;s implementation of FileVault becomes invisible to earlier versions of macOS until the encryption or decryption process completes. By itself, this is mostly harmless. However, this is rendered much worse by a bug<sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup> that causes the Mojave installer to incorrectly trigger reencryption of an already-encrypted FileVault volume during the install process. Because full drive encryption cannot complete in a timely manner, the Mojave installer times out before encryption completes. The result is a macOS 10.13 (or older) install with a macOS 10.14 FileVault volume that hasn&rsquo;t yet finished encrypting. This volume can&rsquo;t be read by the startup manager, and so becomes unbootable.</p>

<p>In order to fix this issue, we&rsquo;ll need to let your drive finish encrypting. This guide will walk you through the process. Before we get started, make sure you have the right supplies on hand. You&rsquo;ll need a USB key with a capacity of at least 8GB and access to a working Mac.</p>

<h3>1. Create a USB Mojave installer</h3>

<p>Download the Mojave installer application on your working Mac using the App Store. Don&rsquo;t worry, you won&rsquo;t be using that to install - just to create a USB installer for your broken Mac. Then follow <a href="https://support.apple.com/en-us/HT201372">these instructions from Apple</a>. This will erase your USB key and turn it into a bootable USB install drive.</p>

<h3>2. Boot into the USB installer</h3>

<p>Turn off the Mac that you&rsquo;re upgrading to Mojave and insert the USB drive you just created. Turn the Mac back on, and immediately hold the option key until the Startup Manager appears. Select the drive you created.</p>

<h3>3. Enter Recovery Mode</h3>

<p>The installer should provide an option to enter Recovery Mode. This is a different version of Recovery Mode than the one that&rsquo;s builtin to your Mac, and it will be able to see your hard drive.</p>

<h3>4. Unlock and mount your hard drive</h3>

<p>From the Utilities menu bar at the top of the screen, select Terminal. From the terminal prompt, type <code>diskutil apfs list</code>. In the output, you should see one volume whose FileVault status is listed as <code>FileVault: in progress</code> (or something similar). If it&rsquo;s already listed as &ldquo;unlocked&rdquo;, then you&rsquo;re good - proceed to step 5.</p>

<p>Unlock this drive by running <code>diskutil apfs unlockVolume DISK</code>, where <code>DISK</code> is the identifier listed after <code>APFS Volume Disk</code> for the volume you identified in the previous paragraph. For example, you might type <code>diskutil apfs unlockVolume disk1s1</code>. This command will ask you for a password; enter either your personal log in password, or a FileVault recovery key.</p>

<p>Once you&rsquo;ve completed this step, exit Terminal. You should be returned to the Recovery Mode main menu.</p>

<h3>5. Create a new APFS volume</h3>

<p>Open Disk Utility from the Recovery Mode main menu. Select your main hard drive, right-click it, and choose &ldquo;Add APFS Volume&rdquo;. Don&rsquo;t worry, this isn&rsquo;t repartitioning your drive - this bootable volume will live on the same volume as your main volume, and you will be able to delete it later. Name it &ldquo;Temporary&rdquo;, then click &ldquo;Add&rdquo;.</p>

<p><img src="/blog/images/mojave/1_volume.png" width="264" title="Creating a volume" ></p>

<p><img src="/blog/images/mojave/2_volume.png" width="442" title="Volume options" ></p>

<p>Once you&rsquo;ve completed this step, exit Disk Utility. You should be returned to the Recovery Mode main menu. Return to the main Mojave installer menu.</p>

<h3>6. Install Mojave on the new volume</h3>

<p>Choose to install Mojave on the volume named &ldquo;Temporary&rdquo; that you created in the previous step. This will be a temporary fresh install, so don&rsquo;t worry too much about it - go ahead and keep all the options at their defaults.</p>

<h3>7. Allow drive encryption to finish</h3>

<p>Once your install has finished and you&rsquo;ve logged in, open Disk Utility. Unlock your normal hard drive by clicking on it and clicking the &ldquo;mount&rdquo; button in the toolbar. You will be asked for a password; like in the previous step in the terminal, you will need to provide either your login password (from your old Mac install), or your recovery key.</p>

<p>At this point, drive encryption will start back up again. You will need to wait for that to finish; this could take a few hours. If you want to check on the progress, you can open a terminal and look at the output of <code>diskutil apfs list</code>; encryption is finished when you run that command and see the status read <code>FileVault: Yes</code>.</p>

<h3>8. Upgrade your main drive to Mojave</h3>

<p>Now you&rsquo;re finally (finally!) ready to let the Mojave install complete. Open up your USB drive in the Finder and run the macOS installer app. This time, instead of picking the temporary volume, pick your original Mac volume. Let the installer complete. This time, your Mac should boot up like normal. You&rsquo;re saved!</p>

<h3>9. Clean up</h3>

<p>Now that your main Mac volume is bootable again, you can get rid of the temporary volume we created in the previous step. To do that, open Disk Utility and right-click the volume named &ldquo;Temporary&rdquo;. Click &ldquo;Delete APFS Volume&rdquo;, then confirm by clicking &ldquo;Delete&rdquo; again.</p>

<p><img src="/blog/images/mojave/3_volume.png" width="205" title="Deleting the temporary volume" ></p>

<h3>You&rsquo;re done!</h3>

<p>With any luck, you should be all set at this point. Feel free to reach out to me if you&rsquo;re still having trouble! Big thanks to <a href="https://twitter.com/mikeymikey">@mikeymikey</a> for the suggestion of using a second APFS volume to install the temporary macOS 10.14. Thanks also to my manager, who allowed me to use my internal blog post as the basis for this post.</p>
<div class="footnotes">
<hr/>
<ol>
<li id="fn:1">
<p>I wish I could provide more detail about this bug, but as far as I know no details have been published. I&rsquo;ve filed a radar but haven&rsquo;t received a response. All I know is that this occurs, seemingly at random, to a small percentage of people who try to upgrade from macOS 10.13.6 to macOS 10.14 when FileVault is already enabled.<a href="#fnref:1" rev="footnote">&#8617;</a></p></li>
</ol>
</div>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2017/02/19/review-undertale-vinyl-soundtrack/">Review: Undertale Vinyl Soundtrack</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2017-02-19T13:05:40+11:00'><span class='date'><span class='date-month'>Feb</span> <span class='date-day'>19</span><span class='date-suffix'>th</span>, <span class='date-year'>2017</span></span> <span class='time'>1:05 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I got my copy of the Undertale vinyl soundtrack in the mail the other day. While I&rsquo;ve seen a lot of excitement for it, I haven&rsquo;t seen many people talk about what it&rsquo;s like, so I decided to write up my impressions.</p>

<p><img src="/blog/images/undertale/front.jpg" title="Front cover" >
First, to start with the good <a href="news:">news:</a> the art design is beautiful, and gorgeously printed. The red-on-black front cover is stylish, and the mostly-new pixel artwork is very well-done. The gatefold opens to a house party scene with a ton of the game&rsquo;s NPCs, which is adorable and fits the mood of the game really well too. Most of the printing is matte, with a few details in glossy ink that really stands out&mdash;the Undertale logo on the cover, and the coloured lights in the party scene.</p>

<p><img class="right" src="/blog/images/undertale/poke.jpg" width="150" title="Sleeve pokes out awkwardly" >
Unfortunately the quality of the sleeve itself is subpar. The cardboard feels thin and flimsy compared to other double-albums I own; it lacks weight. The gatefold hinge is also poorly-folded, and doesn&rsquo;t stay closed on its own when the records are in; it flops open awkwardly. The records also don&rsquo;t slide comfortably into the sleeve when the gatefold is closed, which makes putting records back after a play more awkward than it has to be. (See right: the record is inserted as far as it gets when the gatefold is closed. The black thing poking out is the inner record sleeve.) If you open the sleeve to insert the records all the way, then they can&rsquo;t be removed while the gatefold is closed, which is even more awkward. The overall feeling is surprisingly cheap for a $35 album.</p>

<p>The records themselves are also mixed quality. The transparent red and blue coloured vinyl is classy, and the simple label design is attractive as well. It&rsquo;s a minor detail, but the inner record sleeves are very attractive and easy to get the discs in and out of.</p>

<p><img class="left" src="/blog/images/undertale/scratch.jpg" width="150" title="Close up of scratched record" >
Unfortunately, my copy shipped with large scratches on sides A and B. (See the photo on the left&mdash;the scratches are very visible at full size.) Both discs were also covered in dust fresh out of the package. Everything I&rsquo;ve seen suggests this isn&rsquo;t an isolated issue&mdash;I know other people whose iam8bit records shipped with scratches before the first play, and from scanning their twitter feed, it looks like this is a common complaint with other customers. Needless to say, this is a huge issue, and I&rsquo;m shocked it&rsquo;s as common a problem as it is with them.</p>

<p>Given those defects, I was surprised when the discs sounded great. The mastering quality is very good, and leaves very little to complain about if you&rsquo;re lucky enough to get undamaged discs. I did notice a mastering error that clips off the first note of Snowy on side one, but that was the only discernible error.</p>

<p>Given just how huge the Undertale soundtrack is, the entire thing was not going to fit on two discs. The vinyl release curates a selection of tracks to fit the available running time. They generally made a good set of calls, hitting all the major notes and popular moments, though by necessity your favourite deep cut is probably missing. Given the time constraints, I don&rsquo;t see much to complain about in the selection. Pushing the soundtrack to three discs would probably have been a good call, even if that would have pushed up the price.</p>

<p>Despite the good sound quality, it doesn&rsquo;t feel like iam8bit actually has the experience it takes to release a premium package like Undertale was meant to be. It&rsquo;s pretty clear they have big ambitions, and I hope they learn from their mistakes so they get to the point that their quality lives up, but they&rsquo;re not there yet. The stuff they&rsquo;re good at&mdash;art and graphic design&mdash;is offset by poor physical design and unreliable QC. I can&rsquo;t really recommend this as-is, especially with the high chance of getting a dud.</p>

<p><img src="/blog/images/undertale/dogsong.jpg" title="Dogsong sleeve" ></p>

<p>Aside from the main album, preorders came with a special dogsong single. This one-sided 7" single has an extended version of dogsong, and is pressed on transparent vinyl with an image of the annoying dog on the other side. It&rsquo;s very cute, and for what it is it&rsquo;s well-produced and pretty-looking.</p>

<p><img src="/blog/images/undertale/dogsong_disc.jpg" title="Dogsong disc" ></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2016/01/26/elegance/">Elegance</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-01-26T20:37:58-08:00'><span class='date'><span class='date-month'>Jan</span> <span class='date-day'>26</span><span class='date-suffix'>th</span>, <span class='date-year'>2016</span></span> <span class='time'>8:37 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>A few months ago, I wrote <a href="https://github.com/mistydemeo/lucia">decoders</a> for the PCM formats used by the Sega CD and Sega Saturn versions of the game Lunar: Eternal Blue<sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup>.
I wanted to write up a few notes on the format of the Sega CD version&rsquo;s uncompressed PCM format, and some interesting lessons I learned from it.</p>

<p>All files in this format run at a sample rate of 16282Hz. This unusual number is based on the base clock of the PCM chip. Similarly, the reason that samples are 8-bit signed instead of 16-bit is because this is the Sega CD PCM chip&rsquo;s <a href="http://www.retrodev.com/RF5C68A.pdf">native format</a>.</p>

<p>Each file is divided into a set of fixed-size frames; the header constitutes the first frame, and every group of samples constitutes the subsequent frames.
These frames are set to a size of 2048 bytes&mdash;chosen because this is the exact size of a Mode 1 CD-ROM sector, and hence the most convenient chunk of data which can be read from a disc when streaming.
This is also why the header takes up 2048 bytes, when the actual data stored within it uses fewer than 16 bytes.</p>

<p>Each frame of content contains 1024 samples.
Because each sample takes up one byte in the original format, this means only half of a frame is used for content.
The actual content is interleaved with 0 bytes.
Despite seeming a pointless, inefficient use of space, this does serve a purpose by <a href="https://gist.github.com/pbarfuss/cde669526ffc21dbd759">allowing for oversampling</a>. The PCM chip&rsquo;s <a href="http://www.retrodev.com/RF5C68A.pdf">datasheet</a> lists a maximum frequency of 19800Hz, but this trick allows for pseudo-32564Hz playback.</p>

<p>The format used in Lunar: Eternal Blue supports stereo playback, though only two songs are actually encoded in stereo<sup id="fnref:2"><a href="#fn:2" rel="footnote">2</a></sup>.
Songs encoded in stereo interleave their content not every sample, as in most PCM formats, but every frame; one 2048-byte frame will contain 1024 left samples, the next frame will contain the matching 1024 right samples, and so forth.
This was likely chosen because the PCM chip expects samples for only one output channel at a time, and doesn&rsquo;t itself implement stereo support.</p>

<p>The loop format used is highly idiosyncratic.
Loop starts are measured in bytes from the beginning of the header; that is, a position to seek to from the start of actual content.
The loop end time, however, uses a different unit; loop end is measured in terms of the <em>sample</em> at which the loop ends, not the byte.
Because one sample is stored for every two bytes, and because left/right samples in a stereo pair are counted numerically as the same sample, this means that this count differs from the byte position at the end of the song by a factor of either 2 or 4.
This is a quirk of how the PCM playback routine works; it&rsquo;s more efficient to keep track of the number of samples played instead of the bytes played, and therefore storing the data in that format means that no extra math has to be performed to determine if the end of a loop has been reached.
Similarly, the treatment of left/right samples as being the same sample is likely an artifact of what was the simplest way for the PCM playback code to handle this condition.</p>

<p>Looking at these PCM files gave me a new appreciation for design, and helped me appreciate more how important it is to understand the reason behind design decisions.
In a lot of ways this format feels like it should be &ldquo;bad&rdquo; design: it&rsquo;s strange, it&rsquo;s idiosyncratic, it&rsquo;s internally inconsistent.
But every single detail is carefully chosen; everything serves a purpose.
Each of these idiosyncrasies was carefully chosen to solve a particular problem, or to ensure peak performance in a particular bottleneck.
Given the restrictions of a 16-bit game console, all of these choices were necessary to be able to support constantly streaming audio like this in the first place.
Aligning every single detail of a format or API with the job which needs to be done is its own kind of elegance&mdash;a kind of elegance I understand a little better now.</p>
<div class="footnotes">
<hr/>
<ol>
<li id="fn:1">
<p>I referenced a couple of open-source decoders for the Sega CD version&rsquo;s format when writing my own (<a href="https://bitbucket.org/kode54/foo_lunar2">foo_lunar2</a> by kode54, and <a href="http://hcs64.com/vgmstream.html">vgmstream</a>), along with some notes given to me by <a href="https://kode54.net">kode54</a>.<a href="#fnref:1" rev="footnote">&#8617;</a></p></li>
<li id="fn:2">
<p>The Pentagulia theme, and the sunken tower.<a href="#fnref:2" rev="footnote">&#8617;</a></p></li>
</ol>
</div>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2015/12/03/flat-whites-in-vancouver/">Flat Whites in Vancouver</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-12-03T22:07:24-08:00'><span class='date'><span class='date-month'>Dec</span> <span class='date-day'>3</span><span class='date-suffix'>rd</span>, <span class='date-year'>2015</span></span> <span class='time'>10:07 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This post is completely off-topic.
Please indulge me.</p>

<p>I recently spent three lovely weeks in Melbourne, Australia.
I&rsquo;m a big coffee fan, and Melbourne is one of the <a href="http://www.bbc.com/travel/story/20140421-living-in-the-worlds-top-coffee-cities">best cities for coffee in the world</a>, so I spent a lot of time in cafes acquainting myself with the native coffee&mdash;specifically the flat white.
Now that I&rsquo;m back in Vancouver, I find myself craving flat whites nostalgically; sipping a flat white in a nice place reminds me of the wonderful time I spent there.
(That nostalgia may have something to do with spending so many of those days out with a <a href="http://twitter.com/ticky">particular girl</a>.)
Finding a good flat white locally is hard though, and while there isn&rsquo;t a really authentic one anywhere in the city there are a few good places I keep going back to.</p>

<p>There are three things that define a good flat white: milk volume, milk texture, and espresso.
The right combination isn&rsquo;t always easy to find on this side of the Pacific.</p>

<h3>Milk</h3>

<h4>Volume</h4>

<p>In my experience in Melbourne, most flat whites are served in roughly 190mL (6.5oz) cups; this is smaller than the average North American small latte (235mL, 8oz), and larger than the New Zealand flat white (160mL, 5.5oz).
The relatively lower milk volume helps more of the espresso taste come through, which I find very nice.</p>

<p>Some Canadian coffeeshops I&rsquo;ve been to will serve their flat whites in much smaller cups&mdash;smaller than both North American lattes and Australian flat whites, presumably intended to be closer to the size of a New Zealand flat white.
Or perhaps they&rsquo;ve simply heard that flat whites are served smaller and, having only too-small and too-large cups to choose from, they chose too-small.</p>

<p>Purely as a personal preference, I&rsquo;ll take a bit too much milk over a bit too little, though 190mL as I had in Melbourne feels just right.</p>

<h4>Foam</h4>

<p>Flat whites are made using microfoam, a very fine, smoothly-textured, velvety foamed milk that gives the coffee the perfect texture.
A good flat white also retains the crema from the espresso, merging the milk with the crema at the surface of the drink.</p>

<h3>The espresso</h3>

<p>Given the lower milk volume, it&rsquo;s important for the coffee to not be overpowering.
An espresso that&rsquo;s too earthy or too bitter can ruin the drink for me; I like the flavour to be strong but not overly sharp.
According to Wikipedia the kiwi flat white is usually served using a ristretto shot, and I find that can help cut the bitterness of certain beans; however I don&rsquo;t feel like it&rsquo;s a requirement for a good one.
That said, a few of the Vancouver shops I&rsquo;ve been to served me overly earthy, bitter flat whites that didn&rsquo;t work for me.
I make my own flat whites at home using ristretto shots.</p>

<h3>The rankings</h3>

<ol>
<li><p><a href="https://www.facebook.com/oldcrowcoffeeco">Old Crow</a> (New Westminster)</p>

<p> <blockquote class="instagram-media" data-instgrm-version="6" style=" background:#FFF; border:0; border-radius:3px; box-shadow:0 0 1px 0 rgba(0,0,0,0.5),0 1px 10px 0 rgba(0,0,0,0.15); margin: 1px; max-width:658px; padding:0; width:99.375%; width:-webkit-calc(100% - 2px); width:calc(100% - 2px);"><div style="padding:8px;"> <div style=" background:#F8F8F8; line-height:0; margin-top:40px; padding:50.0% 0; text-align:center; width:100%;"> <div style=" background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACwAAAAsCAMAAAApWqozAAAAGFBMVEUiIiI9PT0eHh4gIB4hIBkcHBwcHBwcHBydr+JQAAAACHRSTlMABA4YHyQsM5jtaMwAAADfSURBVDjL7ZVBEgMhCAQBAf//42xcNbpAqakcM0ftUmFAAIBE81IqBJdS3lS6zs3bIpB9WED3YYXFPmHRfT8sgyrCP1x8uEUxLMzNWElFOYCV6mHWWwMzdPEKHlhLw7NWJqkHc4uIZphavDzA2JPzUDsBZziNae2S6owH8xPmX8G7zzgKEOPUoYHvGz1TBCxMkd3kwNVbU0gKHkx+iZILf77IofhrY1nYFnB/lQPb79drWOyJVa/DAvg9B/rLB4cC+Nqgdz/TvBbBnr6GBReqn/nRmDgaQEej7WhonozjF+Y2I/fZou/qAAAAAElFTkSuQmCC); display:block; height:44px; margin:0 auto -44px; position:relative; top:-22px; width:44px;"></div></div><p style=" color:#c9c8cd; font-family:Arial,sans-serif; font-size:14px; line-height:17px; margin-bottom:0; margin-top:8px; overflow:hidden; padding:8px 0 7px; text-align:center; text-overflow:ellipsis; white-space:nowrap;"><a href="https://www.instagram.com/p/-HxFq2n6-j/" style=" color:#c9c8cd; font-family:Arial,sans-serif; font-size:14px; font-style:normal; font-weight:normal; line-height:17px; text-decoration:none;" target="_blank">A photo posted by @mistydemeo</a> on <time style=" font-family:Arial,sans-serif; font-size:14px; line-height:17px;" datetime="2015-11-15T21:57:05+00:00">Nov 15, 2015 at 1:57pm PST</time></p></div></blockquote> <script async defer src="//platform.instagram.com/en_US/embeds.js"></script></p>

<p> Old Crow serves their flat white in an 8oz cup, though they&rsquo;ll also do it in a 5oz glass on request.
 (I find it works better in the 8oz cup, personally.)
 They steam the milk very nicely, producing a good microfoam.
 Old Crow uses <a href="http://bowsandarrowscoffee.com">Bows X Arrows</a>&rsquo;s <a href="http://bowsandarrowscoffee.com/collections/coffees/products/st-66-espresso">St. 66</a> beans, which is one of my favourite espresso roasts&mdash;pleasant, low bitterness, wonderful flavour with good acidity.
 At my request they started making flat whites using ristretto shots, which works beautifully with these beans.
 The result is a velvety, smooth coffee with a lovely natural sweetness.
 If they had 190mL cups to serve this in instead of 8oz, this could easily be mistaken for a Melbournian flat white.</p></li>
<li><p><a href="http://continental-coffee.ca">Continental Coffee</a> (Commercial Drive)</p>

<p> <blockquote class="instagram-media" data-instgrm-version="6" style=" background:#FFF; border:0; border-radius:3px; box-shadow:0 0 1px 0 rgba(0,0,0,0.5),0 1px 10px 0 rgba(0,0,0,0.15); margin: 1px; max-width:658px; padding:0; width:99.375%; width:-webkit-calc(100% - 2px); width:calc(100% - 2px);"><div style="padding:8px;"> <div style=" background:#F8F8F8; line-height:0; margin-top:40px; padding:50.0% 0; text-align:center; width:100%;"> <div style=" background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACwAAAAsCAMAAAApWqozAAAAGFBMVEUiIiI9PT0eHh4gIB4hIBkcHBwcHBwcHBydr+JQAAAACHRSTlMABA4YHyQsM5jtaMwAAADfSURBVDjL7ZVBEgMhCAQBAf//42xcNbpAqakcM0ftUmFAAIBE81IqBJdS3lS6zs3bIpB9WED3YYXFPmHRfT8sgyrCP1x8uEUxLMzNWElFOYCV6mHWWwMzdPEKHlhLw7NWJqkHc4uIZphavDzA2JPzUDsBZziNae2S6owH8xPmX8G7zzgKEOPUoYHvGz1TBCxMkd3kwNVbU0gKHkx+iZILf77IofhrY1nYFnB/lQPb79drWOyJVa/DAvg9B/rLB4cC+Nqgdz/TvBbBnr6GBReqn/nRmDgaQEej7WhonozjF+Y2I/fZou/qAAAAAElFTkSuQmCC); display:block; height:44px; margin:0 auto -44px; position:relative; top:-22px; width:44px;"></div></div><p style=" color:#c9c8cd; font-family:Arial,sans-serif; font-size:14px; line-height:17px; margin-bottom:0; margin-top:8px; overflow:hidden; padding:8px 0 7px; text-align:center; text-overflow:ellipsis; white-space:nowrap;"><a href="https://www.instagram.com/p/-Uu1-7H64b/" style=" color:#c9c8cd; font-family:Arial,sans-serif; font-size:14px; font-style:normal; font-weight:normal; line-height:17px; text-decoration:none;" target="_blank">A photo posted by @mistydemeo</a> on <time style=" font-family:Arial,sans-serif; font-size:14px; line-height:17px;" datetime="2015-11-20T22:47:35+00:00">Nov 20, 2015 at 2:47pm PST</time></p></div></blockquote> <script async defer src="//platform.instagram.com/en_US/embeds.js"></script></p>

<p> Continental also produces a very nice flat white.
 Served in an 8oz cup, it&rsquo;s served with decently-foamed milk and an excellent ristretto shot.
 The foam on the milk as a bit thick compared to Old Crow and Prado, but it was delicious.</p></li>
<li><p><a href="https://www.facebook.com/PradoCafe">Prado</a> (Commercial Drive)</p>

<p> <blockquote class="instagram-media" data-instgrm-version="5" style=" background:#FFF; border:0; border-radius:3px; box-shadow:0 0 1px 0 rgba(0,0,0,0.5),0 1px 10px 0 rgba(0,0,0,0.15); margin: 1px; max-width:658px; padding:0; width:99.375%; width:-webkit-calc(100% - 2px); width:calc(100% - 2px);"><div style="padding:8px;"> <div style=" background:#F8F8F8; line-height:0; margin-top:40px; padding:50.0% 0; text-align:center; width:100%;"> <div style=" background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACwAAAAsCAMAAAApWqozAAAAGFBMVEUiIiI9PT0eHh4gIB4hIBkcHBwcHBwcHBydr+JQAAAACHRSTlMABA4YHyQsM5jtaMwAAADfSURBVDjL7ZVBEgMhCAQBAf//42xcNbpAqakcM0ftUmFAAIBE81IqBJdS3lS6zs3bIpB9WED3YYXFPmHRfT8sgyrCP1x8uEUxLMzNWElFOYCV6mHWWwMzdPEKHlhLw7NWJqkHc4uIZphavDzA2JPzUDsBZziNae2S6owH8xPmX8G7zzgKEOPUoYHvGz1TBCxMkd3kwNVbU0gKHkx+iZILf77IofhrY1nYFnB/lQPb79drWOyJVa/DAvg9B/rLB4cC+Nqgdz/TvBbBnr6GBReqn/nRmDgaQEej7WhonozjF+Y2I/fZou/qAAAAAElFTkSuQmCC); display:block; height:44px; margin:0 auto -44px; position:relative; top:-22px; width:44px;"></div></div><p style=" color:#c9c8cd; font-family:Arial,sans-serif; font-size:14px; line-height:17px; margin-bottom:0; margin-top:8px; overflow:hidden; padding:8px 0 7px; text-align:center; text-overflow:ellipsis; white-space:nowrap;"><a href="https://instagram.com/p/-CGHgNH64F/" style=" color:#c9c8cd; font-family:Arial,sans-serif; font-size:14px; font-style:normal; font-weight:normal; line-height:17px; text-decoration:none;" target="_blank">A photo posted by @mistydemeo</a> on <time style=" font-family:Arial,sans-serif; font-size:14px; line-height:17px;" datetime="2015-11-13T17:05:23+00:00">Nov 13, 2015 at 9:05am PST</time></p></div></blockquote> <script async defer src="//platform.instagram.com/en_US/embeds.js"></script></p>

<p> Just down the street from Continental, Prado also produces a nice flat white.
 The milk is textured beautifully, a bit better than Continental&rsquo;s, though I found the coffee a bit too sharp in comparison.</p></li>
<li><p><a href="http://www.milanocoffee.ca">Milano</a> (Gastown)</p>

<p> <blockquote class="instagram-media" data-instgrm-version="5" style=" background:#FFF; border:0; border-radius:3px; box-shadow:0 0 1px 0 rgba(0,0,0,0.5),0 1px 10px 0 rgba(0,0,0,0.15); margin: 1px; max-width:658px; padding:0; width:99.375%; width:-webkit-calc(100% - 2px); width:calc(100% - 2px);"><div style="padding:8px;"> <div style=" background:#F8F8F8; line-height:0; margin-top:40px; padding:50.0% 0; text-align:center; width:100%;"> <div style=" background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACwAAAAsCAMAAAApWqozAAAAGFBMVEUiIiI9PT0eHh4gIB4hIBkcHBwcHBwcHBydr+JQAAAACHRSTlMABA4YHyQsM5jtaMwAAADfSURBVDjL7ZVBEgMhCAQBAf//42xcNbpAqakcM0ftUmFAAIBE81IqBJdS3lS6zs3bIpB9WED3YYXFPmHRfT8sgyrCP1x8uEUxLMzNWElFOYCV6mHWWwMzdPEKHlhLw7NWJqkHc4uIZphavDzA2JPzUDsBZziNae2S6owH8xPmX8G7zzgKEOPUoYHvGz1TBCxMkd3kwNVbU0gKHkx+iZILf77IofhrY1nYFnB/lQPb79drWOyJVa/DAvg9B/rLB4cC+Nqgdz/TvBbBnr6GBReqn/nRmDgaQEej7WhonozjF+Y2I/fZou/qAAAAAElFTkSuQmCC); display:block; height:44px; margin:0 auto -44px; position:relative; top:-22px; width:44px;"></div></div><p style=" color:#c9c8cd; font-family:Arial,sans-serif; font-size:14px; line-height:17px; margin-bottom:0; margin-top:8px; overflow:hidden; padding:8px 0 7px; text-align:center; text-overflow:ellipsis; white-space:nowrap;"><a href="https://instagram.com/p/9hXb1HH6w_/" style=" color:#c9c8cd; font-family:Arial,sans-serif; font-size:14px; font-style:normal; font-weight:normal; line-height:17px; text-decoration:none;" target="_blank">A photo posted by @mistydemeo</a> on <time style=" font-family:Arial,sans-serif; font-size:14px; line-height:17px;" datetime="2015-11-01T00:01:47+00:00">Oct 31, 2015 at 5:01pm PDT</time></p></div></blockquote> <script async defer src="//platform.instagram.com/en_US/embeds.js"></script></p>

<p> Milano made their flat white with an very earthy coffee, which overpowered everything else for me&mdash;even given the higher milk volume (8oz).
 This wasn&rsquo;t a bad drink, but it wasn&rsquo;t great.
 Next time I&rsquo;d try ordering with a different espresso and see if that&rsquo;s any better, or ask them to do a ristretto shot.</p></li>
<li><p><a href="http://www.nelsontheseagull.com">Nelson the Seagull</a> (Gastown)</p>

<p> <blockquote class="instagram-media" data-instgrm-version="5" style=" background:#FFF; border:0; border-radius:3px; box-shadow:0 0 1px 0 rgba(0,0,0,0.5),0 1px 10px 0 rgba(0,0,0,0.15); margin: 1px; max-width:658px; padding:0; width:99.375%; width:-webkit-calc(100% - 2px); width:calc(100% - 2px);"><div style="padding:8px;"> <div style=" background:#F8F8F8; line-height:0; margin-top:40px; padding:50.0% 0; text-align:center; width:100%;"> <div style=" background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACwAAAAsCAMAAAApWqozAAAAGFBMVEUiIiI9PT0eHh4gIB4hIBkcHBwcHBwcHBydr+JQAAAACHRSTlMABA4YHyQsM5jtaMwAAADfSURBVDjL7ZVBEgMhCAQBAf//42xcNbpAqakcM0ftUmFAAIBE81IqBJdS3lS6zs3bIpB9WED3YYXFPmHRfT8sgyrCP1x8uEUxLMzNWElFOYCV6mHWWwMzdPEKHlhLw7NWJqkHc4uIZphavDzA2JPzUDsBZziNae2S6owH8xPmX8G7zzgKEOPUoYHvGz1TBCxMkd3kwNVbU0gKHkx+iZILf77IofhrY1nYFnB/lQPb79drWOyJVa/DAvg9B/rLB4cC+Nqgdz/TvBbBnr6GBReqn/nRmDgaQEej7WhonozjF+Y2I/fZou/qAAAAAElFTkSuQmCC); display:block; height:44px; margin:0 auto -44px; position:relative; top:-22px; width:44px;"></div></div><p style=" color:#c9c8cd; font-family:Arial,sans-serif; font-size:14px; line-height:17px; margin-bottom:0; margin-top:8px; overflow:hidden; padding:8px 0 7px; text-align:center; text-overflow:ellipsis; white-space:nowrap;"><a href="https://instagram.com/p/9hK9QXH6yr/" style=" color:#c9c8cd; font-family:Arial,sans-serif; font-size:14px; font-style:normal; font-weight:normal; line-height:17px; text-decoration:none;" target="_blank">A photo posted by @mistydemeo</a> on <time style=" font-family:Arial,sans-serif; font-size:14px; line-height:17px;" datetime="2015-10-31T22:12:45+00:00">Oct 31, 2015 at 3:12pm PDT</time></p></div></blockquote> <script async defer src="//platform.instagram.com/en_US/embeds.js"></script></p>

<p> Nelson&rsquo;s flat white suffers from basically the same problem as Milano&rsquo;s, though it&rsquo;s magnified by being served in a smaller cup.
 I also tried this a second time using their house almond milk; it has too much of a flavour of its own and ended up competing with the coffee.</p></li>
<li><p><a href="http://revolvercoffee.ca/home/">Revolver</a> (Gastown)</p>

<p> <blockquote class="instagram-media" data-instgrm-version="5" style=" background:#FFF; border:0; border-radius:3px; box-shadow:0 0 1px 0 rgba(0,0,0,0.5),0 1px 10px 0 rgba(0,0,0,0.15); margin: 1px; max-width:658px; padding:0; width:99.375%; width:-webkit-calc(100% - 2px); width:calc(100% - 2px);"><div style="padding:8px;"> <div style=" background:#F8F8F8; line-height:0; margin-top:40px; padding:50.0% 0; text-align:center; width:100%;"> <div style=" background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACwAAAAsCAMAAAApWqozAAAAGFBMVEUiIiI9PT0eHh4gIB4hIBkcHBwcHBwcHBydr+JQAAAACHRSTlMABA4YHyQsM5jtaMwAAADfSURBVDjL7ZVBEgMhCAQBAf//42xcNbpAqakcM0ftUmFAAIBE81IqBJdS3lS6zs3bIpB9WED3YYXFPmHRfT8sgyrCP1x8uEUxLMzNWElFOYCV6mHWWwMzdPEKHlhLw7NWJqkHc4uIZphavDzA2JPzUDsBZziNae2S6owH8xPmX8G7zzgKEOPUoYHvGz1TBCxMkd3kwNVbU0gKHkx+iZILf77IofhrY1nYFnB/lQPb79drWOyJVa/DAvg9B/rLB4cC+Nqgdz/TvBbBnr6GBReqn/nRmDgaQEej7WhonozjF+Y2I/fZou/qAAAAAElFTkSuQmCC); display:block; height:44px; margin:0 auto -44px; position:relative; top:-22px; width:44px;"></div></div><p style=" color:#c9c8cd; font-family:Arial,sans-serif; font-size:14px; line-height:17px; margin-bottom:0; margin-top:8px; overflow:hidden; padding:8px 0 7px; text-align:center; text-overflow:ellipsis; white-space:nowrap;"><a href="https://instagram.com/p/99X_q-n6ye/" style=" color:#c9c8cd; font-family:Arial,sans-serif; font-size:14px; font-style:normal; font-weight:normal; line-height:17px; text-decoration:none;" target="_blank">A photo posted by @mistydemeo</a> on <time style=" font-family:Arial,sans-serif; font-size:14px; line-height:17px;" datetime="2015-11-11T21:05:24+00:00">Nov 11, 2015 at 1:05pm PST</time></p></div></blockquote> <script async defer src="//platform.instagram.com/en_US/embeds.js"></script></p>

<p> Revolver serves their flat white in a small 5oz (150mL) glass, which from what I&rsquo;ve read is presumably closer to the kiwi style.
 The milk is steamed well, and the espresso is excellent&mdash;not that I&rsquo;d expect anything less from Revolver.</p>

<p> This doesn&rsquo;t resemble anything I had in straya, but it is tasty.
 I&rsquo;m only rating this low for failing to rekindle my nostalgia; it&rsquo;s delicious taken on its own.</p></li>
<li><p><a href="http://www.delanyscoffee.com">Delany&rsquo;s</a> (West End)</p>

<p> <blockquote class="instagram-media" data-instgrm-version="6" style=" background:#FFF; border:0; border-radius:3px; box-shadow:0 0 1px 0 rgba(0,0,0,0.5),0 1px 10px 0 rgba(0,0,0,0.15); margin: 1px; max-width:658px; padding:0; width:99.375%; width:-webkit-calc(100% - 2px); width:calc(100% - 2px);"><div style="padding:8px;"> <div style=" background:#F8F8F8; line-height:0; margin-top:40px; padding:50.0% 0; text-align:center; width:100%;"> <div style=" background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACwAAAAsCAMAAAApWqozAAAAGFBMVEUiIiI9PT0eHh4gIB4hIBkcHBwcHBwcHBydr+JQAAAACHRSTlMABA4YHyQsM5jtaMwAAADfSURBVDjL7ZVBEgMhCAQBAf//42xcNbpAqakcM0ftUmFAAIBE81IqBJdS3lS6zs3bIpB9WED3YYXFPmHRfT8sgyrCP1x8uEUxLMzNWElFOYCV6mHWWwMzdPEKHlhLw7NWJqkHc4uIZphavDzA2JPzUDsBZziNae2S6owH8xPmX8G7zzgKEOPUoYHvGz1TBCxMkd3kwNVbU0gKHkx+iZILf77IofhrY1nYFnB/lQPb79drWOyJVa/DAvg9B/rLB4cC+Nqgdz/TvBbBnr6GBReqn/nRmDgaQEej7WhonozjF+Y2I/fZou/qAAAAAElFTkSuQmCC); display:block; height:44px; margin:0 auto -44px; position:relative; top:-22px; width:44px;"></div></div><p style=" color:#c9c8cd; font-family:Arial,sans-serif; font-size:14px; line-height:17px; margin-bottom:0; margin-top:8px; overflow:hidden; padding:8px 0 7px; text-align:center; text-overflow:ellipsis; white-space:nowrap;"><a href="https://www.instagram.com/p/-FUphqn6-C/" style=" color:#c9c8cd; font-family:Arial,sans-serif; font-size:14px; font-style:normal; font-weight:normal; line-height:17px; text-decoration:none;" target="_blank">A photo posted by @mistydemeo</a> on <time style=" font-family:Arial,sans-serif; font-size:14px; line-height:17px;" datetime="2015-11-14T23:10:05+00:00">Nov 14, 2015 at 3:10pm PST</time></p></div></blockquote> <script async defer src="//platform.instagram.com/en_US/embeds.js"></script></p>

<p> Delany&rsquo;s smallest size is a 12oz (355mL)&mdash;nearly twice the size of an Australian flat white.
 The huge quantity of milk makes it hard to think of this as being a flat white at all.</p></li>
<li><p><a href="http://www.bumpngrindcafe.com">Bump N Grind</a></p>

<p> <blockquote class="instagram-media" data-instgrm-version="5" style=" background:#FFF; border:0; border-radius:3px; box-shadow:0 0 1px 0 rgba(0,0,0,0.5),0 1px 10px 0 rgba(0,0,0,0.15); margin: 1px; max-width:658px; padding:0; width:99.375%; width:-webkit-calc(100% - 2px); width:calc(100% - 2px);"><div style="padding:8px;"> <div style=" background:#F8F8F8; line-height:0; margin-top:40px; padding:50.0% 0; text-align:center; width:100%;"> <div style=" background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACwAAAAsCAMAAAApWqozAAAAGFBMVEUiIiI9PT0eHh4gIB4hIBkcHBwcHBwcHBydr+JQAAAACHRSTlMABA4YHyQsM5jtaMwAAADfSURBVDjL7ZVBEgMhCAQBAf//42xcNbpAqakcM0ftUmFAAIBE81IqBJdS3lS6zs3bIpB9WED3YYXFPmHRfT8sgyrCP1x8uEUxLMzNWElFOYCV6mHWWwMzdPEKHlhLw7NWJqkHc4uIZphavDzA2JPzUDsBZziNae2S6owH8xPmX8G7zzgKEOPUoYHvGz1TBCxMkd3kwNVbU0gKHkx+iZILf77IofhrY1nYFnB/lQPb79drWOyJVa/DAvg9B/rLB4cC+Nqgdz/TvBbBnr6GBReqn/nRmDgaQEej7WhonozjF+Y2I/fZou/qAAAAAElFTkSuQmCC); display:block; height:44px; margin:0 auto -44px; position:relative; top:-22px; width:44px;"></div></div><p style=" color:#c9c8cd; font-family:Arial,sans-serif; font-size:14px; line-height:17px; margin-bottom:0; margin-top:8px; overflow:hidden; padding:8px 0 7px; text-align:center; text-overflow:ellipsis; white-space:nowrap;"><a href="https://instagram.com/p/-Che_YH68q/" style=" color:#c9c8cd; font-family:Arial,sans-serif; font-size:14px; font-style:normal; font-weight:normal; line-height:17px; text-decoration:none;" target="_blank">A photo posted by @mistydemeo</a> on <time style=" font-family:Arial,sans-serif; font-size:14px; line-height:17px;" datetime="2015-11-13T21:04:32+00:00">Nov 13, 2015 at 1:04pm PST</time></p></div></blockquote> <script async defer src="//platform.instagram.com/en_US/embeds.js"></script></p>

<p> Bump N Grind is one of my favourite shops so I had high hopes, but I was very disappointed in their flat white.</p>

<p> Like Revolver, their flat white runs noticeably smaller than an Australian flat white; Bump N Grind serves theirs in a cappucino cup.
 The coffee is nice, but the milk was steamed poorly and the foam at the surface was far too thick&mdash;not as thick as a cappucino, but this&rsquo;d be on the thick side for a latte, much less a flat white.
 The result was okay, but I wouldn&rsquo;t call it a flat white at all.
 It&rsquo;s basically a cappucino with less foam.</p></li>
</ol>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2015/06/21/release-asuka-120-percent-limit-over-english-translation/">Release: Asuka 120% Limit Over English Translation</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-06-21T21:36:00-07:00'><span class='date'><span class='date-month'>Jun</span> <span class='date-day'>21</span><span class='date-suffix'>st</span>, <span class='date-year'>2015</span></span> <span class='time'>9:36 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Asuka 120% Limited was a 1997 fighting game for the Sega Saturn, the final<sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup> game in a long-running series. The Asuka 120% games were always underdog favourites of mine; despite looking like throwaway anime fan-pandering, they were surprisingly deep, innovative games with unique mechanics that paved the way for later, more famous games like Guilty Gear and X-Men vs Street Fighter.</p>

<p><img class="right" src="/blog/images/asuka/cover.gif" title="Asuka 120% Limit Over cover art" >
In 1999, an unofficial mod titled <a href="http://www5.ocn.ne.jp/~afc/limitover/index.html">Asuka 120% Limit Over</a> was released. <a href="http://asuka-120.wikia.com/wiki/Asuka_120%25_Limited_BURNING_Fest.">Rumoured</a> to have been made by the original developers, Limit Over is a surprisingly polished update with many refinements and new gameplay mechanics. It went ignored by the English internet for many years, until the patch was discovered in 2007 by <a href="http://forums.lostlevels.org/viewtopic.php?t=1233">Lost Levels forum posters</a>; it&rsquo;s now also circulating as a prepatched ISO.</p>

<p>Even though there isn&rsquo;t much text, Limit Over is hard to play without knowing Japanese, so I&rsquo;ve prepared a translation patch.</p>

<h2>The patch</h2>

<p><img src="/blog/images/asuka/kiyoko_vs_cathy.png" title="Kiyoko vs Cathy screenshot" >
<img src="/blog/images/asuka/nana_vs_tamaki.png" title="Nana vs Tamaki screenshot" ></p>

<p><a href="/blog/data/asuka_120_lo_english_10.zip">Asuka 120% Limit Over English patch, version 1.0</a></p>

<p>This patch is compatible with the final release of Limit Over for the Saturn<sup id="fnref:2"><a href="#fn:2" rel="footnote">2</a></sup>. In order to use it, you need to have already built or obtained a disc image of Limit Over. The patch includes two options: a <a href="http://web.archive.org/web/20061016073657/http://www.paradogs.com/pdx_ppf2.htm">PPF</a> disc image patch, or individual patches for each file on the disc that was changed. Detailed installation instructions are included in the ZIP file.</p>

<p>For more on what&rsquo;s been translated, and how it was done, read on.</p>

<h2>Graphics</h2>

<p>Limit Over contains very little text, almost all of it in English. Unfortunately, though, one critical thing is in Japanese: the character names. Since the barebones menus have no graphics, not even character portraits, it&rsquo;s very difficult to actually play without knowing Japanese. Have any idea who you&rsquo;re picking in the screenshot below? I don&rsquo;t&hellip;</p>

<p><img src="/blog/images/asuka/Japanesecharacterselect.png" title="Japanese character select screen" ></p>

<p>A few other minor bits of text are stored in Japanese: the &ldquo;N characters beaten&rdquo; text in ranking and deathmatch modes, and the round start and round end graphics. Their meaning is obvious without being able to read them, however, so I decided to leave them alone.</p>

<h3>Finding the tiles</h3>

<p>Like most games of this era, Asuka 120%&rsquo;s graphics are stored as sets of fixed-size tiles with a set, non-true colour palette. Since these are generally stored as raw pixel data without any form of header, it can be tricky to figure out where the tiles are and how they&rsquo;re stored; fortunately, however, there are many good <a href="http://www.romhacking.net/?page=utilities&amp;category=10&amp;platform=&amp;game=&amp;author=&amp;os=&amp;level=&amp;perpage=20&amp;title=&amp;desc=&amp;utilsearch=Go">tile editors</a> available that simplify the task.</p>

<p><img src="/blog/images/asuka/CrystalTile.png" title="Crystal Tile 2" ></p>

<p>I used a free Windows tile editor called <a href="http://www.romhacking.net/utilities/818/">Crystal Tile 2</a>, pictured above, which has some very useful features, including presets for a large number of common tile formats, support for arbitrary tile size, and the ability to import and export tiles to PNG. <img class="right" src="/blog/images/asuka/Debug.png" width="200" title="Yabause debug output" > Via trial and error, and with help from information gleaned via the <a href="http://yabause.org/">Yabause</a> emulator&rsquo;s debug mode, pictured right, I was able to locate three copies of the character name tiles in the TTLDAT.SSP<sup id="fnref:3"><a href="#fn:3" rel="footnote">3</a></sup>, V_GAGE.SSP and VS_SPR.SSP files. The latter two files are used to store the in-battle user interface and the menus, respectively.</p>

<p><img class="left" src="/blog/images/asuka/AsukaJapanesename.png" title="Asuka Japanese name tile" ></p>

<p>Each character name is a 4 bits per pixel 72x24<sup id="fnref:4"><a href="#fn:4" rel="footnote">4</a></sup> tile and, fortunately, Crystal Tile&rsquo;s &ldquo;N64/MD 4bpp&rdquo; preset supports them perfectly. After configuring the palette in Crystal Tile I exported every name to a set of 13 PNG files, like the tile to the left.</p>

<h3>Editing</h3>

<p>I redrew the text using a highly-edited version of a font lovingly stolen from the Neo-Geo game <a href="http://www.neogeosoft.com/?section=view&amp;game=pnyaa">Pochi &amp; Nyaa</a>. Compared to other fonts I looked at, it had the advantage of being both attractive and variable-width&mdash;which is important since the English names (which take up at least twice as many characters as the original Japanese) were very hard to fit in a width of 72 pixels. I also expanded the size of the characters compared to the original.</p>

<p><img class="right" src="/blog/images/asuka/AsukaEnglishthin.png" title="Asuka name, with thin letters" >
<img class="right" src="/blog/images/asuka/AsukaEnglishthick.png" title="Asuka name, with thick letters" ></p>

<p>I briefly experimented with a thin variation of the character names for use in the game&rsquo;s menus, but abandoned it after determining legibility was poor; the menus are 480i, and the flicker inherent in an interlaced image on a CRT or a deinterlaced image rendered the thinner lines harder to read than necessary. To the right are the thick and thin variations of the main character&rsquo;s name.</p>

<h2>Text</h2>

<p>The rest of the game&rsquo;s menu text is stored as ASCII strings in the main executable, and is completely in English. I did, however, make several changes to the character names displayed during loading screens. The one American character&rsquo;s name, Cathy, was misromanized as &ldquo;Cachy&rdquo;. This is an easy mistake to make, since her name was rendered in Japanese as &ldquo;ãã‚ƒã—ã„&rdquo; (Kyashii)<sup id="fnref:5"><a href="#fn:5" rel="footnote">5</a></sup>. I also changed the romanization of several characters' names from <a href="https://en.wikipedia.org/wiki/Kunrei-shiki_romanization">Kunrei-shiki</a> (Sinobu, Tetuko, Genitiro) to the more familiar <a href="https://en.wikipedia.org/wiki/Hepburn_romanization">Hepburn</a> (Shinobu, Tetsuko, Genichirou).</p>

<h2>What&rsquo;s new in Limit Over?</h2>

<p>It&rsquo;s been many years since I&rsquo;ve played Limited, so this list is based on my imperfect memory.</p>

<ul>
<li>Every character has been rebalanced, and every single one of the core game mechanics has been refined.</li>
<li>Every character now has three strengths of normals and special moves instead of two.</li>
<li>A dodge button has been added, allowing characters to sidestep out of attacks.</li>
<li>Many characters have new special or super moves.</li>
</ul>

<div class="footnotes">
<hr/>
<ol>
<li id="fn:1">
<p>The original developer, Fill-in-Cafe, went bankrupt after Limited was released in 1997, but a mediocre sequel and PC port were released in 1999 by another company.<a href="#fnref:1" rev="footnote">&#8617;</a></p></li>
<li id="fn:2">
<p>The only version readily available on the internet is dated &ldquo;12/31&rdquo;; I&rsquo;ve heard there were earlier versions, but I&rsquo;ve never seen them.<a href="#fnref:2" rev="footnote">&#8617;</a></p></li>
<li id="fn:3">
<p>This file is probably unused in Limit Over, since there is no graphical title screen.<a href="#fnref:3" rev="footnote">&#8617;</a></p></li>
<li id="fn:4">
<p>Except the tile for Genichirou, which is so long it&rsquo;s allocated two tiles.<a href="#fnref:4" rev="footnote">&#8617;</a></p></li>
<li id="fn:5">
<p>Cathy&rsquo;s name is rendered in Hiragana despite being a foreign name; it would more normally be rendered as &ldquo;ã‚­ãƒ£ã‚·ãƒ¼&rdquo;.<a href="#fnref:5" rev="footnote">&#8617;</a></p></li>
</ol>
</div>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2015/05/16/attack-the-vector/">Attack the Vector</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-05-16T21:12:00-07:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>16</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>9:12 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>One downside of working with ancient OSs is coming across bugs that will never be fixed.</p>

<p>In the early days of Tigerbrew, I had just started experimenting with GCC 4.2 as a replacement for Xcode 2.5&rsquo;s GCC 4.0. Everything was going great until I built something that uses Cocoa, which blew up with this message:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>In file included from /System/Library/Frameworks/CoreServices.framework/Frameworks/CarbonCore.framework/Headers/DriverServices.h:32,
</span><span class='line'>                 from /System/Library/Frameworks/CoreServices.framework/Frameworks/CarbonCore.framework/Headers/CarbonCore.h:125,
</span><span class='line'>                 from /System/Library/Frameworks/CoreServices.framework/Headers/CoreServices.h:21,
</span><span class='line'>                 from test.c:2:
</span><span class='line'>/System/Library/Frameworks/CoreServices.framework/Frameworks/CarbonCore.framework/Headers/MachineExceptions.h:115: error: expected specifier-qualifier-list before â€˜vectorâ€™</span></code></pre></td></tr></table></div></figure>


<p>A syntax error coming not from within the package I was building, but from within&hellip; Carbon?</p>

<p>The error actually comes from the Vector128 union within MachineExceptions.h, located in CoreServices&rsquo;s CarbonCore framework. The very first section of this union had the offending code. Let&rsquo;s play spot the bug:</p>

<p>Here&rsquo;s what it looks like as of OS X 10.4.11:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">typedef</span> <span class="k">struct</span> <span class="n">FPUInformationPowerPC</span>    <span class="n">FPUInformationPowerPC</span><span class="p">;</span>
</span><span class='line'><span class="k">union</span> <span class="n">Vector128</span> <span class="p">{</span>
</span><span class='line'><span class="cp">#ifdef __VEC__</span>
</span><span class='line'> <span class="n">vector</span> <span class="kt">unsigned</span> <span class="kt">int</span>         <span class="n">v</span><span class="p">;</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>  <span class="kt">unsigned</span> <span class="kt">long</span>       <span class="n">l</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
</span><span class='line'>  <span class="kt">unsigned</span> <span class="kt">short</span>      <span class="n">s</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
</span><span class='line'>  <span class="kt">unsigned</span> <span class="kt">char</span>       <span class="n">c</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>And here it is in OS X 10.7.5<sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">typedef</span> <span class="k">struct</span> <span class="n">FPUInformationPowerPC</span>    <span class="n">FPUInformationPowerPC</span><span class="p">;</span>
</span><span class='line'><span class="k">union</span> <span class="n">Vector128</span> <span class="p">{</span>
</span><span class='line'><span class="cp">#ifdef __APPLE_ALTIVEC__</span>
</span><span class='line'>   <span class="n">vector</span> <span class="kt">unsigned</span> <span class="kt">int</span>         <span class="n">v</span><span class="p">;</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>  <span class="kt">unsigned</span> <span class="kt">long</span>       <span class="n">l</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
</span><span class='line'>  <span class="kt">unsigned</span> <span class="kt">short</span>      <span class="n">s</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
</span><span class='line'>  <span class="kt">unsigned</span> <span class="kt">char</span>       <span class="n">c</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>The bug comes from the use of the <code>vector</code> keyword. As pointed out in this <a href="https://trac.macports.org/ticket/34213#comment:7">MacPorts ticket</a>, the issue is with the <code>#ifdef</code> that checks for <code>__VEC__</code>. <code>__VEC__</code> is defined if AltiVec is on, <em>without necessarily</em> meaning that AltiVec syntactic extensions are enabled. The <code>vector</code> keyword is only available if either <code>altivec.h</code> is included, or the <code>-mpim-altivec</code> or <code>-faltivec</code> flags are passed. Since Tigerbrew always optimizes for the host CPU, G4 and G5 users were getting AltiVec enabled without forcing syntactic extensions. I fixed this in Tigerbrew this by always passing <code>-faltivec</code> on PowerPC systems when building any package, regardless of whether AltiVec is being used.</p>

<p>As to why Apple never caught this, GCC 4.0&rsquo;s behaviour seems to be different; it seems to enable AltiVec syntactic extensions whenever <code>-maltivec</code> is on. Apple did eventually fix the bug, as seen in the Lion header above. According to the MacPorts ticket linked previously, it was fixed in the CarbonCore header in 10.5 and in the 10.4u SDK packaged in Xcode 3 for Leopard. Since the 10.4u SDK fix was never backported to Tiger itself, Tiger users have to make do with the workaround.</p>
<div class="footnotes">
<hr/>
<ol>
<li id="fn:1">
<p>10.7 may be Intel-only, but the relevant code&rsquo;s still there. In fact, the same PowerPC unions and structs are still there as of 10.9.4.<a href="#fnref:1" rev="footnote">&#8617;</a></p></li>
</ol>
</div>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2015/05/02/reevaluate/">Reevaluate</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-05-02T10:41:08-07:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>2</span><span class='date-suffix'>nd</span>, <span class='date-year'>2015</span></span> <span class='time'>10:41 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>My least favourite backtrace is a backtrace that doesn&rsquo;t include my own code.</p>

<p>Tigerbrew on OS X 10.4 uses <a href="/blog/blog/2013/04/02/adventures-with-ruby-1-8-2/">Ruby 1.8.2</a>, which was shipped on Christmas Day, 2004, and it has more than its fair share of interesting bugs. In today&rsquo;s lesson we break Ruby&rsquo;s stdlib class OpenStruct.</p>

<p>OpenStruct is a simple data structure that provides a JavaScript object-like interface to Ruby hashes. It&rsquo;s essentially a hash that provides getter and setter methods for each defined attribute. For example:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">os</span> <span class="o">=</span> <span class="no">OpenStruct</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'><span class="n">os</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;value&#39;</span>
</span><span class='line'><span class="n">os</span><span class="o">.</span><span class="n">key</span> <span class="c1">#=&gt; &#39;value&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Homebrew uses OpenStruct instances in place of hashes in code which only performs reading and writing of attributes, without using any other hash features. For example, in the <a href="https://github.com/Homebrew/homebrew/blob/8b35d842ec1d5e54418024e8afa4fa4ba4302eeb/Library/Homebrew/cmd/deps.rb#L6-L12"><code>deps</code> command</a>, OpenStruct is used for read-only access to a set of attributes read from ARGV:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">mode</span> <span class="o">=</span> <span class="no">OpenStruct</span><span class="o">.</span><span class="n">new</span><span class="p">(</span>
</span><span class='line'>  <span class="ss">:installed?</span>  <span class="o">=&gt;</span> <span class="no">ARGV</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="s1">&#39;--installed&#39;</span><span class="p">),</span>
</span><span class='line'>  <span class="ss">:tree?</span>       <span class="o">=&gt;</span> <span class="no">ARGV</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="s1">&#39;--tree&#39;</span><span class="p">),</span>
</span><span class='line'>  <span class="ss">:all?</span>        <span class="o">=&gt;</span> <span class="no">ARGV</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="s1">&#39;--all&#39;</span><span class="p">),</span>
</span><span class='line'>  <span class="ss">:topo_order?</span> <span class="o">=&gt;</span> <span class="no">ARGV</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="s1">&#39;-n&#39;</span><span class="p">),</span>
</span><span class='line'>  <span class="ss">:union?</span>      <span class="o">=&gt;</span> <span class="no">ARGV</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="s1">&#39;--union&#39;</span><span class="p">)</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="n">mode</span><span class="o">.</span><span class="n">installed?</span> <span class="o">&amp;&amp;</span> <span class="n">mode</span><span class="o">.</span><span class="n">tree?</span>
</span><span class='line'>  <span class="c1"># ...</span>
</span></code></pre></td></tr></table></div></figure>


<p>The first time I ran <code>brew deps</code> in Tigerbrew, however, I was greeted with this lovely backtrace:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>SyntaxError: (eval):3:in `instance_eval&#39;: compile error
</span><span class='line'>(eval):3: syntax error
</span><span class='line'>        def topo_order?=(x); @table[:topo_order?] = x; end
</span><span class='line'>                       ^
</span><span class='line'>(eval):3: syntax error
</span><span class='line'>    from /usr/lib/ruby/1.8/ostruct.rb:72:in `instance_eval&#39;
</span><span class='line'>    from /usr/lib/ruby/1.8/ostruct.rb:72:in `instance_eval&#39;
</span><span class='line'>    from /usr/lib/ruby/1.8/ostruct.rb:72:in `new_ostruct_member&#39;
</span><span class='line'>    from /usr/lib/ruby/1.8/ostruct.rb:51:in `initialize&#39;
</span><span class='line'>    from /usr/lib/ruby/1.8/ostruct.rb:49:in `each&#39;
</span><span class='line'>    from /usr/lib/ruby/1.8/ostruct.rb:49:in `initialize&#39;
</span></code></pre></td></tr></table></div></figure>


<p>Given that the backtrace includes only stdlib code and nothing I wrote, I wasn&rsquo;t sure how to interpret this until I saw &ldquo;(eval)&rdquo;. It couldn&rsquo;t be, could it&hellip;? Of course it was.</p>

<p>Accessors for attribute of OpenStruct instances are methods, and they are defined by OpenStruct a) whenever a new attribute is assigned, and b) when OpenStruct is initialized with a hash. This is achieved using the method <code>OpenStruct#new_ostruct_member</code><sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup>, which was <a href="https://github.com/ruby/ruby/blob/eed0809a08bf5d2c28349b12c23a33101b7d648e/lib/ostruct.rb#L70-L77">defined like this</a> in Ruby 1.8.2:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">new_ostruct_member</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
</span><span class='line'>  <span class="k">unless</span> <span class="nb">self</span><span class="o">.</span><span class="n">respond_to?</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
</span><span class='line'>    <span class="nb">self</span><span class="o">.</span><span class="n">instance_eval</span> <span class="sx">%{</span>
</span><span class='line'><span class="sx">      def </span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="sx">; @table[:</span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="sx">]; end</span>
</span><span class='line'><span class="sx">      def </span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="sx">=(x); @table[:</span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="sx">] = x; end</span>
</span><span class='line'><span class="sx">    }</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Yes: OpenStruct dynamically defines method names by interpolating the name of the variable into a string and evaluating the string in the context of the object. Unsurprisingly, this is very fragile. In our example, the attributes being defined end with a question mark; <code>#installed?</code> is a valid method name in Ruby, but <code>#installed?=</code> is not, and so a SyntaxError exception is raised inside <code>eval</code>.</p>

<p>This was eventually fixed<sup id="fnref:2"><a href="#fn:2" rel="footnote">2</a></sup>; in <a href="https://github.com/ruby/ruby/blob/a9721a259665149b1b9ff0beabcf5f8dc0136120/lib/ostruct.rb#L166-L174">Ruby 2.2.2&rsquo;s definition</a>, the <code>#define_singleton_method</code> method is used instead; metaprogramming is not limited to the normal naming restrictions, so the unusual setters are defined properly<sup id="fnref:3"><a href="#fn:3" rel="footnote">3</a></sup>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">new_ostruct_member</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
</span><span class='line'>  <span class="nb">name</span> <span class="o">=</span> <span class="nb">name</span><span class="o">.</span><span class="n">to_sym</span>
</span><span class='line'>  <span class="k">unless</span> <span class="nb">respond_to?</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
</span><span class='line'>    <span class="n">define_singleton_method</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span> <span class="p">{</span> <span class="vi">@table</span><span class="o">[</span><span class="nb">name</span><span class="o">]</span> <span class="p">}</span>
</span><span class='line'>    <span class="n">define_singleton_method</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">=&quot;</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">x</span><span class="o">|</span> <span class="n">modifiable</span><span class="o">[</span><span class="nb">name</span><span class="o">]</span> <span class="o">=</span> <span class="n">x</span> <span class="p">}</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="nb">name</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Thankfully, the definiton of the method from modern versions of Ruby is fully compatible with Ruby 1.8.2, so Tigerbrew ships with <a href="https://github.com/mistydemeo/tigerbrew/blob/b63d347ab995697fb54bcaa5bfc75d1865d5e573/Library/Homebrew/extend/tiger.rb#L37-L56">a backported version of <code>OpenStruct#new_ostruct_member</code></a>.</p>
<div class="footnotes">
<hr/>
<ol>
<li id="fn:1">
<p>This sounds like it should be a private method, and is <a href="http://ruby-doc.org/stdlib-1.9.3/libdoc/ostruct/rdoc/OpenStruct.html#method-i-new_ostruct_member">documented</a> as being &ldquo;used  internally&rdquo;, but for some reason this was a public instance method right up until <a href="https://github.com/ruby/ruby/commit/2dafb0f47a7ae70362aea7649b635e97bb33dcf2">Ruby 2.0</a>.<a href="#fnref:1" rev="footnote">&#8617;</a></p></li>
<li id="fn:2">
<p><a href="https://github.com/ruby/ruby/commit/48653d5ef0ed47469d64170d70c8c2a9f21f159e">Close to a year</a> after Ruby 1.8.2 was released.<a href="#fnref:2" rev="footnote">&#8617;</a></p></li>
<li id="fn:3">
<p>These illegal method names can&rsquo;t be called using the normal syntax, but they can be called via metaprogramming using the <a href="http://ruby-doc.org/core-2.2.2/Object.html#method-i-send"><code>#send</code></a> instance method, e.g. <code>os.send "foo?=", "baz"</code><a href="#fnref:3" rev="footnote">&#8617;</a></p></li>
</ol>
</div>

</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/posts/2">&larr; Older</a>
    
    <a href="/blog/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/blog/2021/08/14/exploring-jvs/">Exploring JVS</a>
      </li>
    
      <li class="post">
        <a href="/blog/blog/2020/11/23/bundle-install-with-homebrew-magic-using-brew-bundle-exec/">Bundle Install With Homebrew Magic Using Brew Bundle Exec</a>
      </li>
    
      <li class="post">
        <a href="/blog/blog/2019/02/20/the-hunt-for-the-lost-phoenix-games/">The Hunt for the Lost Phoenix Games</a>
      </li>
    
      <li class="post">
        <a href="/blog/blog/2018/10/18/recover-from-filevault-doom/">Recover From FileVault Doom</a>
      </li>
    
      <li class="post">
        <a href="/blog/blog/2017/02/19/review-undertale-vinyl-soundtrack/">Review: Undertale Vinyl Soundtrack</a>
      </li>
    
  </ul>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2021 - Misty De Meo -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
