
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>The Future Is Now</title>
  <meta name="author" content="Misty De Meo">

  
  <meta name="description" content="Asuka 120% Limited was a 1997 fighting game for the Sega Saturn, the final1 game in a long-running series. The Asuka 120% games were always underdog &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://mistys-internet.website/blog">
  <link href="/blog/favicon.png" rel="icon">
  <link href="/blog/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/blog/atom.xml" rel="alternate" title="The Future Is Now" type="application/atom+xml">
  <script src="/blog/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/blog/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/blog/">The Future Is Now</a></h1>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/blog/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:mistys-internet.website/blog" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/blog/">Blog</a></li>
  <li><a href="/blog/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2015/06/21/release-asuka-120-percent-limit-over-english-translation/">Release: Asuka 120% Limit Over English Translation</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-06-21T21:36:00-07:00'><span class='date'><span class='date-month'>Jun</span> <span class='date-day'>21</span><span class='date-suffix'>st</span>, <span class='date-year'>2015</span></span> <span class='time'>9:36 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Asuka 120% Limited was a 1997 fighting game for the Sega Saturn, the final<sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup> game in a long-running series. The Asuka 120% games were always underdog favourites of mine; despite looking like throwaway anime fan-pandering, they were surprisingly deep, innovative games with unique mechanics that paved the way for later, more famous games like Guilty Gear and X-Men vs Street Fighter.</p>

<p><img class="right" src="/blog/images/asuka/cover.gif" title="Asuka 120% Limit Over cover art" >
In 1999, an unofficial mod titled <a href="http://www5.ocn.ne.jp/~afc/limitover/index.html">Asuka 120% Limit Over</a> was released. <a href="http://asuka-120.wikia.com/wiki/Asuka_120%25_Limited_BURNING_Fest.">Rumoured</a> to have been made by the original developers, Limit Over is a surprisingly polished update with many refinements and new gameplay mechanics. It went ignored by the English internet for many years, until the patch was discovered in 2007 by <a href="http://forums.lostlevels.org/viewtopic.php?t=1233">Lost Levels forum posters</a>; it&rsquo;s now also circulating as a prepatched ISO.</p>

<p>Even though there isn&rsquo;t much text, Limit Over is hard to play without knowing Japanese, so I&rsquo;ve prepared a translation patch.</p>

<h2>The patch</h2>

<p><img src="/blog/images/asuka/kiyoko_vs_cathy.png" title="Kiyoko vs Cathy screenshot" >
<img src="/blog/images/asuka/nana_vs_tamaki.png" title="Nana vs Tamaki screenshot" ></p>

<p><a href="/blog/data/asuka_120_lo_english_10.zip">Asuka 120% Limit Over English patch, version 1.0</a></p>

<p>This patch is compatible with the final release of Limit Over for the Saturn<sup id="fnref:2"><a href="#fn:2" rel="footnote">2</a></sup>. In order to use it, you need to have already built or obtained a disc image of Limit Over. The patch includes two options: a <a href="http://web.archive.org/web/20061016073657/http://www.paradogs.com/pdx_ppf2.htm">PPF</a> disc image patch, or individual patches for each file on the disc that was changed. Detailed installation instructions are included in the ZIP file.</p>

<p>For more on what&rsquo;s been translated, and how it was done, read on.</p>

<h2>Graphics</h2>

<p>Limit Over contains very little text, almost all of it in English. Unfortunately, though, one critical thing is in Japanese: the character names. Since the barebones menus have no graphics, not even character portraits, it&rsquo;s very difficult to actually play without knowing Japanese. Have any idea who you&rsquo;re picking in the screenshot below? I don&rsquo;t&hellip;</p>

<p><img src="/blog/images/asuka/Japanesecharacterselect.png" title="Japanese character select screen" ></p>

<p>A few other minor bits of text are stored in Japanese: the &ldquo;N characters beaten&rdquo; text in ranking and deathmatch modes, and the round start and round end graphics. Their meaning is obvious without being able to read them, however, so I decided to leave them alone.</p>

<h3>Finding the tiles</h3>

<p>Like most games of this era, Asuka 120%&rsquo;s graphics are stored as sets of fixed-size tiles with a set, non-true colour palette. Since these are generally stored as raw pixel data without any form of header, it can be tricky to figure out where the tiles are and how they&rsquo;re stored; fortunately, however, there are many good <a href="http://www.romhacking.net/?page=utilities&amp;category=10&amp;platform=&amp;game=&amp;author=&amp;os=&amp;level=&amp;perpage=20&amp;title=&amp;desc=&amp;utilsearch=Go">tile editors</a> available that simplify the task.</p>

<p><img src="/blog/images/asuka/CrystalTile.png" title="Crystal Tile 2" ></p>

<p>I used a free Windows tile editor called <a href="http://www.romhacking.net/utilities/818/">Crystal Tile 2</a>, pictured above, which has some very useful features, including presets for a large number of common tile formats, support for arbitrary tile size, and the ability to import and export tiles to PNG. <img class="right" src="/blog/images/asuka/Debug.png" width="200" title="Yabause debug output" > Via trial and error, and with help from information gleaned via the <a href="http://yabause.org/">Yabause</a> emulator&rsquo;s debug mode, pictured right, I was able to locate three copies of the character name tiles in the TTLDAT.SSP<sup id="fnref:3"><a href="#fn:3" rel="footnote">3</a></sup>, V_GAGE.SSP and VS_SPR.SSP files. The latter two files are used to store the in-battle user interface and the menus, respectively.</p>

<p><img class="left" src="/blog/images/asuka/AsukaJapanesename.png" title="Asuka Japanese name tile" ></p>

<p>Each character name is a 4 bits per pixel 72x24<sup id="fnref:4"><a href="#fn:4" rel="footnote">4</a></sup> tile and, fortunately, Crystal Tile&rsquo;s &ldquo;N64/MD 4bpp&rdquo; preset supports them perfectly. After configuring the palette in Crystal Tile I exported every name to a set of 13 PNG files, like the tile to the left.</p>

<h3>Editing</h3>

<p>I redrew the text using a highly-edited version of a font lovingly stolen from the Neo-Geo game <a href="http://www.neogeosoft.com/?section=view&amp;game=pnyaa">Pochi &amp; Nyaa</a>. Compared to other fonts I looked at, it had the advantage of being both attractive and variable-width&mdash;which is important since the English names (which take up at least twice as many characters as the original Japanese) were very hard to fit in a width of 72 pixels. I also expanded the size of the characters compared to the original.</p>

<p><img class="right" src="/blog/images/asuka/AsukaEnglishthin.png" title="Asuka name, with thin letters" >
<img class="right" src="/blog/images/asuka/AsukaEnglishthick.png" title="Asuka name, with thick letters" ></p>

<p>I briefly experimented with a thin variation of the character names for use in the game&rsquo;s menus, but abandoned it after determining legibility was poor; the menus are 480i, and the flicker inherent in an interlaced image on a CRT or a deinterlaced image rendered the thinner lines harder to read than necessary. To the right are the thick and thin variations of the main character&rsquo;s name.</p>

<h2>Text</h2>

<p>The rest of the game&rsquo;s menu text is stored as ASCII strings in the main executable, and is completely in English. I did, however, make several changes to the character names displayed during loading screens. The one American character&rsquo;s name, Cathy, was misromanized as &ldquo;Cachy&rdquo;. This is an easy mistake to make, since her name was rendered in Japanese as &ldquo;きゃしい&rdquo; (Kyashii)<sup id="fnref:5"><a href="#fn:5" rel="footnote">5</a></sup>. I also changed the romanization of several characters&#8217; names from <a href="https://en.wikipedia.org/wiki/Kunrei-shiki_romanization">Kunrei-shiki</a> (Sinobu, Tetuko, Genitiro) to the more familiar <a href="https://en.wikipedia.org/wiki/Hepburn_romanization">Hepburn</a> (Shinobu, Tetsuko, Genichirou).</p>

<h2>What&rsquo;s new in Limit Over?</h2>

<p>It&rsquo;s been many years since I&rsquo;ve played Limited, so this list is based on my imperfect memory.</p>

<ul>
<li>Every character has been rebalanced, and every single one of the core game mechanics has been refined.</li>
<li>Every character now has three strengths of normals and special moves instead of two.</li>
<li>A dodge button has been added, allowing characters to sidestep out of attacks.</li>
<li>Many characters have new special or super moves.</li>
</ul>

<div class="footnotes">
<hr/>
<ol>
<li id="fn:1">
<p>The original developer, Fill-in-Cafe, went bankrupt after Limited was released in 1997, but a mediocre sequel and PC port were released in 1999 by another company.<a href="#fnref:1" rev="footnote">&#8617;</a></p></li>
<li id="fn:2">
<p>The only version readily available on the internet is dated &ldquo;12/31&rdquo;; I&rsquo;ve heard there were earlier versions, but I&rsquo;ve never seen them.<a href="#fnref:2" rev="footnote">&#8617;</a></p></li>
<li id="fn:3">
<p>This file is probably unused in Limit Over, since there is no graphical title screen.<a href="#fnref:3" rev="footnote">&#8617;</a></p></li>
<li id="fn:4">
<p>Except the tile for Genichirou, which is so long it&rsquo;s allocated two tiles.<a href="#fnref:4" rev="footnote">&#8617;</a></p></li>
<li id="fn:5">
<p>Cathy&rsquo;s name is rendered in Hiragana despite being a foreign name; it would more normally be rendered as &ldquo;キャシー&rdquo;.<a href="#fnref:5" rev="footnote">&#8617;</a></p></li>
</ol>
</div>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2015/05/16/attack-the-vector/">Attack the Vector</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-05-16T21:12:00-07:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>16</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>9:12 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>One downside of working with ancient OSs is coming across bugs that will never be fixed.</p>

<p>In the early days of Tigerbrew, I had just started experimenting with GCC 4.2 as a replacement for Xcode 2.5&rsquo;s GCC 4.0. Everything was going great until I built something that uses Cocoa, which blew up with this message:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>In file included from /System/Library/Frameworks/CoreServices.framework/Frameworks/CarbonCore.framework/Headers/DriverServices.h:32,
</span><span class='line'>                 from /System/Library/Frameworks/CoreServices.framework/Frameworks/CarbonCore.framework/Headers/CarbonCore.h:125,
</span><span class='line'>                 from /System/Library/Frameworks/CoreServices.framework/Headers/CoreServices.h:21,
</span><span class='line'>                 from test.c:2:
</span><span class='line'>/System/Library/Frameworks/CoreServices.framework/Frameworks/CarbonCore.framework/Headers/MachineExceptions.h:115: error: expected specifier-qualifier-list before ‘vector’</span></code></pre></td></tr></table></div></figure>


<p>A syntax error coming not from within the package I was building, but from within&hellip; Carbon?</p>

<p>The error actually comes from the Vector128 union within MachineExceptions.h, located in CoreServices&rsquo;s CarbonCore framework. The very first section of this union had the offending code. Let&rsquo;s play spot the bug:</p>

<p>Here&rsquo;s what it looks like as of OS X 10.4.11:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">typedef</span> <span class="k">struct</span> <span class="n">FPUInformationPowerPC</span>    <span class="n">FPUInformationPowerPC</span><span class="p">;</span>
</span><span class='line'><span class="k">union</span> <span class="n">Vector128</span> <span class="p">{</span>
</span><span class='line'><span class="cp">#ifdef __VEC__</span>
</span><span class='line'> <span class="n">vector</span> <span class="kt">unsigned</span> <span class="kt">int</span>         <span class="n">v</span><span class="p">;</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>  <span class="kt">unsigned</span> <span class="kt">long</span>       <span class="n">l</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
</span><span class='line'>  <span class="kt">unsigned</span> <span class="kt">short</span>      <span class="n">s</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
</span><span class='line'>  <span class="kt">unsigned</span> <span class="kt">char</span>       <span class="n">c</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>And here it is in OS X 10.7.5<sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">typedef</span> <span class="k">struct</span> <span class="n">FPUInformationPowerPC</span>    <span class="n">FPUInformationPowerPC</span><span class="p">;</span>
</span><span class='line'><span class="k">union</span> <span class="n">Vector128</span> <span class="p">{</span>
</span><span class='line'><span class="cp">#ifdef __APPLE_ALTIVEC__</span>
</span><span class='line'>   <span class="n">vector</span> <span class="kt">unsigned</span> <span class="kt">int</span>         <span class="n">v</span><span class="p">;</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>  <span class="kt">unsigned</span> <span class="kt">long</span>       <span class="n">l</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
</span><span class='line'>  <span class="kt">unsigned</span> <span class="kt">short</span>      <span class="n">s</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
</span><span class='line'>  <span class="kt">unsigned</span> <span class="kt">char</span>       <span class="n">c</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>The bug comes from the use of the <code>vector</code> keyword. As pointed out in this <a href="https://trac.macports.org/ticket/34213#comment:7">MacPorts ticket</a>, the issue is with the <code>#ifdef</code> that checks for <code>__VEC__</code>. <code>__VEC__</code> is defined if AltiVec is on, <em>without necessarily</em> meaning that AltiVec syntactic extensions are enabled. The <code>vector</code> keyword is only available if either <code>altivec.h</code> is included, or the <code>-mpim-altivec</code> or <code>-faltivec</code> flags are passed. Since Tigerbrew always optimizes for the host CPU, G4 and G5 users were getting AltiVec enabled without forcing syntactic extensions. I fixed this in Tigerbrew this by always passing <code>-faltivec</code> on PowerPC systems when building any package, regardless of whether AltiVec is being used.</p>

<p>As to why Apple never caught this, GCC 4.0&rsquo;s behaviour seems to be different; it seems to enable AltiVec syntactic extensions whenever <code>-maltivec</code> is on. Apple did eventually fix the bug, as seen in the Lion header above. According to the MacPorts ticket linked previously, it was fixed in the CarbonCore header in 10.5 and in the 10.4u SDK packaged in Xcode 3 for Leopard. Since the 10.4u SDK fix was never backported to Tiger itself, Tiger users have to make do with the workaround.</p>
<div class="footnotes">
<hr/>
<ol>
<li id="fn:1">
<p>10.7 may be Intel-only, but the relevant code&rsquo;s still there. In fact, the same PowerPC unions and structs are still there as of 10.9.4.<a href="#fnref:1" rev="footnote">&#8617;</a></p></li>
</ol>
</div>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2015/05/02/reevaluate/">Reevaluate</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-05-02T10:41:08-07:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>2</span><span class='date-suffix'>nd</span>, <span class='date-year'>2015</span></span> <span class='time'>10:41 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>My least favourite backtrace is a backtrace that doesn&rsquo;t include my own code.</p>

<p>Tigerbrew on OS X 10.4 uses <a href="/blog/blog/2013/04/02/adventures-with-ruby-1-8-2/">Ruby 1.8.2</a>, which was shipped on Christmas Day, 2004, and it has more than its fair share of interesting bugs. In today&rsquo;s lesson we break Ruby&rsquo;s stdlib class OpenStruct.</p>

<p>OpenStruct is a simple data structure that provides a JavaScript object-like interface to Ruby hashes. It&rsquo;s essentially a hash that provides getter and setter methods for each defined attribute. For example:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">os</span> <span class="o">=</span> <span class="no">OpenStruct</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'><span class="n">os</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;value&#39;</span>
</span><span class='line'><span class="n">os</span><span class="o">.</span><span class="n">key</span> <span class="c1">#=&gt; &#39;value&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Homebrew uses OpenStruct instances in place of hashes in code which only performs reading and writing of attributes, without using any other hash features. For example, in the <a href="https://github.com/Homebrew/homebrew/blob/8b35d842ec1d5e54418024e8afa4fa4ba4302eeb/Library/Homebrew/cmd/deps.rb#L6-L12"><code>deps</code> command</a>, OpenStruct is used for read-only access to a set of attributes read from ARGV:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">mode</span> <span class="o">=</span> <span class="no">OpenStruct</span><span class="o">.</span><span class="n">new</span><span class="p">(</span>
</span><span class='line'>  <span class="ss">:installed?</span>  <span class="o">=&gt;</span> <span class="no">ARGV</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="s1">&#39;--installed&#39;</span><span class="p">),</span>
</span><span class='line'>  <span class="ss">:tree?</span>       <span class="o">=&gt;</span> <span class="no">ARGV</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="s1">&#39;--tree&#39;</span><span class="p">),</span>
</span><span class='line'>  <span class="ss">:all?</span>        <span class="o">=&gt;</span> <span class="no">ARGV</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="s1">&#39;--all&#39;</span><span class="p">),</span>
</span><span class='line'>  <span class="ss">:topo_order?</span> <span class="o">=&gt;</span> <span class="no">ARGV</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="s1">&#39;-n&#39;</span><span class="p">),</span>
</span><span class='line'>  <span class="ss">:union?</span>      <span class="o">=&gt;</span> <span class="no">ARGV</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="s1">&#39;--union&#39;</span><span class="p">)</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="n">mode</span><span class="o">.</span><span class="n">installed?</span> <span class="o">&amp;&amp;</span> <span class="n">mode</span><span class="o">.</span><span class="n">tree?</span>
</span><span class='line'>  <span class="c1"># ...</span>
</span></code></pre></td></tr></table></div></figure>


<p>The first time I ran <code>brew deps</code> in Tigerbrew, however, I was greeted with this lovely backtrace:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>SyntaxError: (eval):3:in `instance_eval&#39;: compile error
</span><span class='line'>(eval):3: syntax error
</span><span class='line'>        def topo_order?=(x); @table[:topo_order?] = x; end
</span><span class='line'>                       ^
</span><span class='line'>(eval):3: syntax error
</span><span class='line'>    from /usr/lib/ruby/1.8/ostruct.rb:72:in `instance_eval&#39;
</span><span class='line'>    from /usr/lib/ruby/1.8/ostruct.rb:72:in `instance_eval&#39;
</span><span class='line'>    from /usr/lib/ruby/1.8/ostruct.rb:72:in `new_ostruct_member&#39;
</span><span class='line'>    from /usr/lib/ruby/1.8/ostruct.rb:51:in `initialize&#39;
</span><span class='line'>    from /usr/lib/ruby/1.8/ostruct.rb:49:in `each&#39;
</span><span class='line'>    from /usr/lib/ruby/1.8/ostruct.rb:49:in `initialize&#39;
</span></code></pre></td></tr></table></div></figure>


<p>Given that the backtrace includes only stdlib code and nothing I wrote, I wasn&rsquo;t sure how to interpret this until I saw &ldquo;(eval)&rdquo;. It couldn&rsquo;t be, could it&hellip;? Of course it was.</p>

<p>Accessors for attribute of OpenStruct instances are methods, and they are defined by OpenStruct a) whenever a new attribute is assigned, and b) when OpenStruct is initialized with a hash. This is achieved using the method <code>OpenStruct#new_ostruct_member</code><sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup>, which was <a href="https://github.com/ruby/ruby/blob/eed0809a08bf5d2c28349b12c23a33101b7d648e/lib/ostruct.rb#L70-L77">defined like this</a> in Ruby 1.8.2:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">new_ostruct_member</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
</span><span class='line'>  <span class="k">unless</span> <span class="nb">self</span><span class="o">.</span><span class="n">respond_to?</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
</span><span class='line'>    <span class="nb">self</span><span class="o">.</span><span class="n">instance_eval</span> <span class="sx">%{</span>
</span><span class='line'><span class="sx">      def </span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="sx">; @table[:</span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="sx">]; end</span>
</span><span class='line'><span class="sx">      def </span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="sx">=(x); @table[:</span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="sx">] = x; end</span>
</span><span class='line'><span class="sx">    }</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Yes: OpenStruct dynamically defines method names by interpolating the name of the variable into a string and evaluating the string in the context of the object. Unsurprisingly, this is very fragile. In our example, the attributes being defined end with a question mark; <code>#installed?</code> is a valid method name in Ruby, but <code>#installed?=</code> is not, and so a SyntaxError exception is raised inside <code>eval</code>.</p>

<p>This was eventually fixed<sup id="fnref:2"><a href="#fn:2" rel="footnote">2</a></sup>; in <a href="https://github.com/ruby/ruby/blob/a9721a259665149b1b9ff0beabcf5f8dc0136120/lib/ostruct.rb#L166-L174">Ruby 2.2.2&rsquo;s definition</a>, the <code>#define_singleton_method</code> method is used instead; metaprogramming is not limited to the normal naming restrictions, so the unusual setters are defined properly<sup id="fnref:3"><a href="#fn:3" rel="footnote">3</a></sup>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">new_ostruct_member</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
</span><span class='line'>  <span class="nb">name</span> <span class="o">=</span> <span class="nb">name</span><span class="o">.</span><span class="n">to_sym</span>
</span><span class='line'>  <span class="k">unless</span> <span class="nb">respond_to?</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
</span><span class='line'>    <span class="n">define_singleton_method</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span> <span class="p">{</span> <span class="vi">@table</span><span class="o">[</span><span class="nb">name</span><span class="o">]</span> <span class="p">}</span>
</span><span class='line'>    <span class="n">define_singleton_method</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">=&quot;</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">x</span><span class="o">|</span> <span class="n">modifiable</span><span class="o">[</span><span class="nb">name</span><span class="o">]</span> <span class="o">=</span> <span class="n">x</span> <span class="p">}</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="nb">name</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Thankfully, the definiton of the method from modern versions of Ruby is fully compatible with Ruby 1.8.2, so Tigerbrew ships with <a href="https://github.com/mistydemeo/tigerbrew/blob/b63d347ab995697fb54bcaa5bfc75d1865d5e573/Library/Homebrew/extend/tiger.rb#L37-L56">a backported version of <code>OpenStruct#new_ostruct_member</code></a>.</p>
<div class="footnotes">
<hr/>
<ol>
<li id="fn:1">
<p>This sounds like it should be a private method, and is <a href="http://ruby-doc.org/stdlib-1.9.3/libdoc/ostruct/rdoc/OpenStruct.html#method-i-new_ostruct_member">documented</a> as being &ldquo;used  internally&rdquo;, but for some reason this was a public instance method right up until <a href="https://github.com/ruby/ruby/commit/2dafb0f47a7ae70362aea7649b635e97bb33dcf2">Ruby 2.0</a>.<a href="#fnref:1" rev="footnote">&#8617;</a></p></li>
<li id="fn:2">
<p><a href="https://github.com/ruby/ruby/commit/48653d5ef0ed47469d64170d70c8c2a9f21f159e">Close to a year</a> after Ruby 1.8.2 was released.<a href="#fnref:2" rev="footnote">&#8617;</a></p></li>
<li id="fn:3">
<p>These illegal method names can&rsquo;t be called using the normal syntax, but they can be called via metaprogramming using the <a href="http://ruby-doc.org/core-2.2.2/Object.html#method-i-send"><code>#send</code></a> instance method, e.g. <code>os.send "foo?=", "baz"</code><a href="#fnref:3" rev="footnote">&#8617;</a></p></li>
</ol>
</div>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2015/01/02/widescreen-gaming-in-the-90s/">Widescreen Gaming in the 90s</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-01-02T14:02:49-08:00'><span class='date'><span class='date-month'>Jan</span> <span class='date-day'>2</span><span class='date-suffix'>nd</span>, <span class='date-year'>2015</span></span> <span class='time'>2:02 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Most people got their first taste of widescreen gaming with the Wii, Xbox 360, and PS3, but not a lot of people know that companies were experimenting with widescreen all the way back in the fifth console generation (PS1, Saturn, N64). A tiny number of games have full widescreen support, which looks great on modern widescreen TVs.</p>

<h2>Anamorphic widescreen</h2>

<p>(Skip to the next section if you just care about pretty pictures!)</p>

<p>Since there isn&rsquo;t a widescreen resolution in the SDTV standards, all widescreen games used a technique called <a href="https://en.wikipedia.org/wiki/Anamorphic_widescreen">anamorphic widescreen</a><sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup>. In anamorphic widescreen, the game squeezes down a 16:9 scene into 4:3; the TV then stretches the 4:3 image back out to 16:9 for display. For example, take a look at this image from Christmas Nights:</p>

<p><img src="/blog/images/widescreen/Nights_3_wide_unscaled.png"></p>

<p>You can see that the proportions on everything are too thin&mdash;it&rsquo;s very noticeable on Claris. Here&rsquo;s what it looks like stretched out:</p>

<p><img src="/blog/images/widescreen/Nights_2_wide.png"></p>

<p>This shows you a lot more of the game world than you&rsquo;d get in the standard 4:3 mode, but you can see that all of the 2D elements in the scene are displayed with the wrong aspect ratio. This lack of aspect ratio correction for 2D elements is common to most widescreen games of that era. In Nights, for example, you can see that the interface elements and all 2D in-game elements (the tree, the stars in the upper left corner) are displayed at the wrong aspect ratio when playing in widescreen. This hurts some games more than others.<sup id="fnref:2"><a href="#fn:2" rel="footnote">2</a></sup></p>

<h2>Examples</h2>

<h3>Christmas Nights</h3>

<p>Both Christmas Nights and Nights support native widescreen. This is probably one of the most famous widescreen games of the era.</p>

<p><img src="/blog/images/widescreen/Nights_1_narrow.png"></p>

<p><img src="/blog/images/widescreen/Nights_2_wide.png"></p>

<p>Nights benefits enormously from a wider field of view, even though it uses a lot of sprites. Being able to see more of where you&rsquo;re going makes for a much better game.</p>

<h3>Panzer Dragoon Zwei</h3>

<p><img src="/blog/images/widescreen/Panzer_1_narrow.png"></p>

<p><img src="/blog/images/widescreen/Panzer_2_wide.png"></p>

<p>Like Nights, Panzer Zwei has a similar field of view in either mode, with more content displayed on the sides.</p>

<h3>Baroque</h3>

<p>This is an obscure game, but Baroque&rsquo;s spare, gritty low-poly nightmarish landscapes are some of the most beautiful and haunting I&rsquo;ve ever seen. It reminds me a lot of <a href="http://cicadamarionette.com/">Lilith</a>&rsquo;s dreamscapes, like <a href="http://lilithzone.itch.io/oneiric-gardens">Oneiric Gardens</a> and <a href="http://cicadamarionette.com/Games/CryptWorlds/Main.html">Crypt Worlds</a>.</p>

<p><img src="/blog/images/widescreen/Baroque_1_narrow.png"></p>

<p><img src="/blog/images/widescreen/Baroque_2_wide.png"></p>

<p>Baroque makes heavy use of sprites; all of the game&rsquo;s NPCs and enemies are sprites in a 3D space. Unfortunately, that makes it look worse in widescreen than the other games I&rsquo;ve written about.</p>

<h3>Virtua Fighter (32X)</h3>

<p><img src="/blog/images/widescreen/Virtua_1_narrow.png"></p>

<p><img src="/blog/images/widescreen/Virtua_2_wide.png"></p>

<p>This game&rsquo;s almost entirely 3D, so it scales very well; the only major 2D element is the 2D background.</p>

<h2>More</h2>

<p>A more complete list of widescreen games of this generation is available on the <a href="http://www.sega-16.com/forum/showthread.php?25942-5th-Generation-Games-List-Playing-in-Widescreen">Sega-16 forums</a>.</p>
<div class="footnotes">
<hr/>
<ol>
<li id="fn:1">
<p>This is the same technique used by widescreen DVDs and Wii games.<a href="#fnref:1" rev="footnote">&#8617;</a></p></li>
<li id="fn:2">
<p>I&rsquo;ve focused on Sega games for this post; I haven&rsquo;t checked to see whether PS1 or N64 games have the same aspect ratio issues with sprites.<a href="#fnref:2" rev="footnote">&#8617;</a></p></li>
</ol>
</div>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2014/12/05/homebrew-gcc-changes-coming/">Homebrew GCC Changes Coming</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-12-05T18:57:06-08:00'><span class='date'><span class='date-month'>Dec</span> <span class='date-day'>5</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>6:57 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Big GCC changes are a-coming to <a href="http://brew.sh">Homebrew</a>, which will make building your own software against Homebrew-provided GCCs much more reliable. There&rsquo;s going to be a transition period, though, and any software built against GCC will need to be rebuilt against the new package to work. We&rsquo;ll be pushing the changes on <strong>December 12th, 2014</strong>, and this post is here to help you get ready for it!</p>

<p>(This only affects software built using Homebrew&rsquo;s GCC. Any software built using Clang, which is the compiler that Apple ships, will be unaffected. If you don&rsquo;t know what this means: you&rsquo;re probably fine.)</p>

<h2>The problem</h2>

<p>Since Apple provides many of the same libraries as GCC, Homebrew installs GCC to a nonstandard location in order to avoid shadowing those libraries. Homebrew currently installs GCC using the <code>--enable-version-specific-runtime-libs</code> option to sandbox its libraries and headers, which installs libraries into versioned locations like so:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/usr/local/lib/gcc/x86_64-apple-darwin13.4.0/4.9.2/libgfortran.3.dylib</span></code></pre></td></tr></table></div></figure>


<p>Since the full version of GCC is embedded&mdash;including the minor version&mdash;along with the OS version, every minor release is installed to a new location; this breaks any software which has dynamically linked against a previous GCC version&rsquo;s copies of these libraries.</p>

<h2>What&rsquo;s changing</h2>

<p>The new GCC package we are shipping will install GCC libraries to a path containing only the series version of GCC. For example, libgfortran will now be installed to:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/usr/local/lib/gcc/4.9/libgfortran.3.dylib</span></code></pre></td></tr></table></div></figure>


<p>This has several advantages:</p>

<ul>
<li>New releases of GCC 4.9 will be installed to the same path, so software built using GCC 4.9.2 will work with software built using GCC 4.9.3.</li>
<li>The same changes will be applied to the <code>gcc49</code> formula in the <a href="https://github.com/Homebrew/homebrew-versions/">homebrew/versions</a> repository, allowing <code>gcc49</code> to provide the 4.9 libraries when <code>gcc</code> is eventually upgraded to 5.0.</li>
</ul>


<h2>What you need to do</h2>

<h3>If you&rsquo;re a user</h3>

<p>If you have built any software using the Homebrew-installed GCC, you will need to reinstall that software once the package is updated on the 12th.</p>

<h3>If you provide binary packages built using the Homebrew-installed GCC</h3>

<p>If you provide binary packages that were built using the Homebrew-installed GCC, you should rebuild them using the <a href="https://github.com/Homebrew/homebrew/pull/34303">new formula</a> and have them ready for your users on the 12th.</p>

<h3>If you maintain Homebrew formulae that use GCC/GFortran</h3>

<p>If you maintain Homebrew formulae that build using GCC or GFortran, you should consider <a href="https://github.com/Homebrew/homebrew/blob/master/share/doc/homebrew/Formula-Cookbook.md#formulae-revisions">bumping their revisions</a> on the 12th to ensure that users rebuild them against the new GCC package.</p>

<h2>The tl;dr version</h2>

<p>On December 12, 2014, we will push a new GCC package that changes the install location of libraries. Any software you&rsquo;ve built using the old package (for instance, C++ or Fortran software) will no longer work and will need to be reinstalled. If you build packages for distribution using Homebrew&rsquo;s GCC package, make sure you&rsquo;ve built new versions using our new package and have them ready to distribute at that date.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2014/09/10/thank-you/">Thank You, Ada</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-09-10T08:46:54-07:00'><span class='date'><span class='date-month'>Sep</span> <span class='date-day'>10</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>8:46 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://www.ibiblio.org/bess/">Bess Sadler</a>, <a href="http://andromedayelton.com/">Andromeda Yelton</a>, <a href="http://chrisbourg.wordpress.com/">Chris Bourg</a> and <a href="http://matienzo.org/">Mark Matienzo</a> have stepped forward to pledge to <a href="https://adainitiative.org/donate/?campaign=libraries">match up to $5120 of donations</a> to the <a href="http://adainitiative.org/">Ada Initiative</a>, a non-profit organization that supports the participation of women in open source and culture. I completely support this very generous act; the Ada Initiative does <a href="http://adainitiative.org/what-we-do/">incredibly important</a> work, and I&rsquo;m extremely proud of my friends and of the library community for supporting them.</p>

<p>I&rsquo;ve <a href="http://modelviewculture.com/pieces/there-and-back-again">written before</a> about how I stopped pursuing a career in tech in my late teens. I saw few female (or trans) role models in the tech industry; at a time when my self-image and self-identity was its most fragile, I pivoted away from something I saw as too masculine, without room for me. The Ada Initiative&rsquo;s conferences and advocacy work have done a lot to help make the open tech world a more welcoming space.</p>

<p>There are a lot of reasons why women don&rsquo;t enter, or don&rsquo;t stay, in the tech industry. The last few weeks, when <a href="http://www.theguardian.com/technology/2014/sep/01/how-to-attack-a-woman-who-works-in-video-games">harassment campaigns</a> have <a href="http://www.themarysue.com/gamergate-harms-women/">targeted women to drive them out of the video game industry</a>, have made me reflect on how important it is to work to make online communities and conferences safe spaces.</p>

<p>The Ada Initiative&rsquo;s <a href="http://adainitiative.org/what-we-do/conference-policies/">conference policy advocacy work</a> and their <a href="http://geekfeminism.wikia.com/wiki/Conference_anti-harassment">example anti-harassment policy</a> have been instrumental in helping many organizations and projects adopt their own policies. Both the <a href="https://github.com/code4lib/antiharassment-policy">Code4lib anti-harassment policy</a> and the <a href="https://github.com/Homebrew/homebrew/blob/master/CODEOFCONDUCT.md">Homebrew code of conduct</a>, for example, were inspired by and partially based on the Ada Initiative&rsquo;s work. Seeing organizations adopt these policies has done a lot to make me feel comfortable, and given me confidence that both preventing and dealing with these forms of harassment is something that they see as important. My hope is that future generations of women will feel comfortable entering and interacting in these spaces in ways that others may not have in the past.</p>

<p>In just a few years, the Ada Initiative has helped make sure that these policies are becoming the norm and not the exception for conferences and online communities. I&rsquo;m so grateful we have their advocacy; please consider <a href="https://supportada.org/?campaign=libraries">donating</a> to help them do even more great things.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2014/09/10/mind-the-dust/">Mind the Dust</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-09-10T08:42:12-07:00'><span class='date'><span class='date-month'>Sep</span> <span class='date-day'>10</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>8:42 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Please excuse the sparseness! I&rsquo;m in the process of migrating from Wordpress to Octopress; I haven&rsquo;t had time to change the default team or migrate over my older posts.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2013/10/19/no-cpp-precomp-the-compiler-flag-that-time-forgot/">-no-cpp-precomp: The Compiler Flag That Time Forgot</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2013-10-19T22:58:00-07:00'><span class='date'><span class='date-month'>Oct</span> <span class='date-day'>19</span><span class='date-suffix'>th</span>, <span class='date-year'>2013</span></span> <span class='time'>10:58 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I’m often surprised how long software can keep trying to use compatibility features ages after their best-by date.</p>

<p>Now that GCC 4.8 builds on Tiger<sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup>, I’ve been testing as much software with it as I can. When building ncurses using GCC 4.8.1, though, I came across a strange error message:</p>

<blockquote><p>gcc-4.8: error: unrecognized command line option &lsquo;-no-cpp-precomp&rsquo;</p></blockquote>

<p>It built fine with the gcc-4.0 that came with the OS. GCC rarely removes support for flags like this, so I assumed it must be an Apple-only flag. Unfortunately, it wasn’t listed in the manpage at all, and the internet was no help either – the search results were full of users confused about the same build failures, or trying to figure out what it does. All I could find was <a href="http://trac.wxwidgets.org/ticket/14029">confirmation</a> that it’s an obsolete Apple-only flag.</p>

<p>Not finding anything, I decided to find out straight from the horse’s mouth and try source-diving. Luckily Apple publishes the source code for all obsolete versions of their tools at their <a href="http://opensource.apple.com/">Apple Open Source</a> site.</p>

<p>Recent versions of Apple GCC don’t include the flag anywhere in their source. The only place it’s still referenced is in a few configure scripts and changelogs, such as these:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="c"># The spiffy cpp-precomp chokes on some legitimate constructs in GCC</span>
</span><span class='line'><span class="c"># sources; use -no-cpp-precomp to get to GNU cpp.</span>
</span><span class='line'><span class="c"># Apple&#39;s GCC has bugs in designated initializer handling, so disable</span>
</span><span class='line'><span class="c"># that too.</span>
</span><span class='line'><span class="nv">stage1_cflags</span><span class="o">=</span><span class="s2">&quot;-g -no-cpp-precomp -DHAVE_DESIGNATED_INITIALIZERS=0&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>In several releases prior to that, for instance <a href="http://opensource.apple.com/source/gcc/gcc-5493/gcc/gcc.c">gcc-5493</a>, the flag is explicitly mentioned as being retained for compatibility and is a no-op:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>/* APPLE LOCAL cpp-precomp compatibility */
</span><span class='line'>%<span class="o">{</span>precomp:%ecpp-precomp not supported<span class="o">}</span>%<span class="o">{</span>no-cpp-precomp:<span class="o">}</span>%<span class="o">{</span>Wno-precomp:<span class="o">}</span><span class="se">\</span>
</span></code></pre></td></tr></table></div></figure>


<p>The last time it was actually documented was in <a href="http://opensource.apple.com/source/gcc/gcc-1765/gcc/doc/install.texi">gcc-1765</a>&rsquo;s install.texi, shipped as a part of the WWDC 2004 Developer Preview of Xcode, which also provides a hint as to what the flag actually did:</p>

<blockquote><p>It’s a good idea to use the GNU preprocessor instead of Apple’s @file{cpp-precomp} during the first stage of bootstrapping; this is automatic when doing @samp{make bootstrap}, but to do it from the toplevel objdir you will need to say @samp{make CC=’cc -no-cpp-precomp’ bootstrap}.</p></blockquote>

<p>So this partially answers our question: Apple shipped an alternate preprocessor, and -no-cpp-precomp triggers the use of the GCC cpp instead. I can only assume this was a leftover that had yet to be excised, because the flag itself was still a no-op at that time. To actually find a version where the flag does something, we have to go all the way back to the December 2002 developer tools, whose <a href="http://opensource.apple.com/source/gcc/gcc-937.2/gcc/gcc.c">gcc-937.2</a> actually has code that uses the flag. This particular build of GCC is Apple’s version of gcc-2.95, and it appears to be the very last where it had any effect. Interestingly, the #ifdef that guards this particular block of code is “#ifdef NEXT_CPP_PRECOMP” – suggesting that this dates back to NeXT, rather than Apple.</p>

<p>To actually find out what this means, O’Reilly’s <a href="http://shop.oreilly.com/product/9780596003562.do">Mac OS X for Unix Geeks</a>, from September 2002, has a nice explanation in chapter 5:</p>

<blockquote><p>Precompiled header files are binary files that have been generated from ordinary C header files and that have been preprocessed and parsed using cpp-precomp. When such a precompiled header is created, both macros and declarations present in the corresponding ordinary header file are sorted, resulting in a faster compile time, a reduced symbol table size, and consequently, faster lookup. Precompiled header files are given a .p extension and are produced from ordinary header files that end with a .h extension.</p></blockquote>

<p>Chapter 4 also provides a nice explanation of why -no-cpp-precomp was desirable:</p>

<blockquote><p>cpp-precomp is faster than cpp. However, some code may not compile with cpp-precomp. In that case, you should invoke cpp by instructing cc not to use cpp-precomp.</p></blockquote>

<p>So there we have it – -no-cpp-precomp became somewhat widely used in Unix software as a compatibility measure to prevent Apple’s cpp-precomp feature from breaking their headers, and has stuck around more than a decade since the last time it’s actually done anything.</p>
<div class="footnotes">
<hr/>
<ol>
<li id="fn:1">
<p>More on that in a future blog post.<a href="#fnref:1" rev="footnote">&#8617;</a></p></li>
</ol>
</div>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2013/04/09/software-archaeology-apples-cctools/">Software Archaeology: Apple’s Cctools</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2013-04-09T20:08:00-07:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>9</span><span class='date-suffix'>th</span>, <span class='date-year'>2013</span></span> <span class='time'>8:08 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>One of the things I’ve been working on in Tigerbrew is backporting modern Apple build tools. The latest official versions, bundled with Xcode 2.5, are simply too old to be able to build some software. (For example, the latest GCC version available is 4.0.)</p>

<p>In the process, I’ve found some pretty fascinating bits of history littered through the code and makefiles for Apple’s build tools. Here are some findings from Apple’s cctools<sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup> package:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='make'><span class='line'><span class="c"># MacOS X (the default)</span>
</span><span class='line'><span class="c">#  RC_OS is set to macos (the top level makefile does this)</span>
</span><span class='line'><span class="c">#  RC_CFLAGS needs -D\__KODIAK__ when RC_RELEASE is Kodiak (Public Beta),</span>
</span><span class='line'><span class="c">#      to get the Public Beta directory layout.</span>
</span><span class='line'><span class="c">#  RC_CFLAGS needs -D\__GONZO_BUNSEN_BEAKER__ when RC_RELEASE is Gonzo, </span>
</span><span class='line'><span class="c">#      Bunsen or Beaker to get the old directory layout. </span>
</span><span class='line'><span class="c">#  The code is #ifdef&#39;ed with \__Mach30__ is picked up from &lt;mach/mach.h&gt; </span>
</span><span class='line'><span class="c"># Rhapsody </span>
</span><span class='line'><span class="c">#  RC_OS is set to teflon </span>
</span><span class='line'><span class="c">#  RC_CFLAGS needs the additional flag -D__HERA__ </span>
</span><span class='line'><span class="c"># Openstep</span>
</span><span class='line'><span class="c">#  RC_OS is set to nextstep </span>
</span><span class='line'><span class="c">#  RC_CFLAGS needs the additional flag -D__OPENSTEP__ </span>
</span></code></pre></td></tr></table></div></figure>


<p>This comment from near the top of cctools’s Makefile lists some of the valid build targets, which includes:</p>

<ul>
<li>Kodiak, which was the Mac OS X public beta from September, 2000</li>
<li>Gonzo (Developer Preview 4), Bunsen (Developer Preview 3), and Beaker (PR2)</li>
<li>Rhapsody (internal name for the OS X project as a whole), Hera (Mac OS X Server 1.0, released 1999), and teflon (unknown to me)</li>
<li>OPENSTEP, NeXT’s implementation of their own OpenStep API</li>
</ul>


<p>From further down in the same Makefile:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='make'><span class='line'><span class="cp">ifeq &quot;macos&quot; &quot;$(RC_OS)&quot;</span>
</span><span class='line'>  TRIE :<span class="o">=</span> <span class="k">$(</span>shell <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$(RC_MAJOR_RELEASE_TRAIN)&quot;</span> <span class="o">=</span> <span class="s2">&quot;Tiger&quot;</span> <span class="o">]</span> <span class="o">||</span> <span class="se">\</span>
</span><span class='line'>             <span class="o">[</span> <span class="s2">&quot;$(RC_MAJOR_RELEASE_TRAIN)&quot;</span> <span class="o">=</span> <span class="s2">&quot;Leopard&quot;</span> <span class="o">]</span> <span class="o">||</span> <span class="se">\</span>
</span><span class='line'>             <span class="o">[</span> <span class="s2">&quot;$(RC_RELEASE)&quot;</span> <span class="o">=</span> <span class="s2">&quot;Puma&quot;</span>      <span class="o">]</span>  <span class="o">||</span> <span class="se">\</span>
</span><span class='line'>             <span class="o">[</span> <span class="s2">&quot;$(RC_RELEASE)&quot;</span> <span class="o">=</span> <span class="s2">&quot;Jaguar&quot;</span>    <span class="o">]</span>  <span class="o">||</span> <span class="se">\</span>
</span><span class='line'>             <span class="o">[</span> <span class="s2">&quot;$(RC_RELEASE)&quot;</span> <span class="o">=</span> <span class="s2">&quot;Panther&quot;</span>   <span class="o">]</span>  <span class="o">||</span> <span class="se">\</span>
</span><span class='line'>             <span class="o">[</span> <span class="s2">&quot;$(RC_RELEASE)&quot;</span> <span class="o">=</span> <span class="s2">&quot;MuonPrime&quot;</span> <span class="o">]</span>  <span class="o">||</span> <span class="se">\</span>
</span><span class='line'>             <span class="o">[</span> <span class="s2">&quot;$(RC_RELEASE)&quot;</span> <span class="o">=</span> <span class="s2">&quot;MuonSeed&quot;</span>  <span class="o">]</span>  <span class="o">||</span> <span class="se">\</span>
</span><span class='line'>             <span class="o">[</span> <span class="s2">&quot;$(RC_RELEASE)&quot;</span> <span class="o">=</span> <span class="s2">&quot;SUPanWheat&quot;</span> <span class="o">]</span> <span class="o">||</span> <span class="se">\</span>
</span><span class='line'>             <span class="o">[</span> <span class="s2">&quot;$(RC_RELEASE)&quot;</span> <span class="o">=</span> <span class="s2">&quot;Tiger&quot;</span> <span class="o">]</span>      <span class="o">||</span> <span class="se">\</span>
</span><span class='line'>             <span class="o">[</span> <span class="s2">&quot;$(RC_RELEASE)&quot;</span> <span class="o">=</span> <span class="s2">&quot;SUTiSoho&quot;</span> <span class="o">]</span>   <span class="o">||</span> <span class="se">\</span>
</span><span class='line'>             <span class="o">[</span> <span class="s2">&quot;$(RC_RELEASE)&quot;</span> <span class="o">=</span> <span class="s2">&quot;Leopard&quot;</span> <span class="o">]</span>    <span class="o">||</span> <span class="se">\</span>
</span><span class='line'>             <span class="o">[</span> <span class="s2">&quot;$(RC_RELEASE)&quot;</span> <span class="o">=</span> <span class="s2">&quot;Vail&quot;</span> <span class="o">]</span>       <span class="o">||</span> <span class="se">\</span>
</span><span class='line'>             <span class="o">[</span> <span class="s2">&quot;$(RC_RELEASE)&quot;</span> <span class="o">=</span> <span class="s2">&quot;SugarBowl&quot;</span> <span class="o">]</span>  <span class="o">||</span> <span class="se">\</span>
</span><span class='line'>             <span class="o">[</span> <span class="s2">&quot;$(RC_RELEASE)&quot;</span> <span class="o">=</span> <span class="s2">&quot;BigBear&quot;</span> <span class="o">]</span>    <span class="o">||</span> <span class="se">\</span>
</span><span class='line'>             <span class="o">[</span> <span class="s2">&quot;$(RC_RELEASE)&quot;</span> <span class="o">=</span> <span class="s2">&quot;Homewood&quot;</span> <span class="o">]</span>   <span class="o">||</span> <span class="se">\</span>
</span><span class='line'>             <span class="o">[</span> <span class="s2">&quot;$(RC_RELEASE)&quot;</span> <span class="o">=</span> <span class="s2">&quot;Kirkwood&quot;</span> <span class="o">]</span>   <span class="o">||</span> <span class="se">\</span>
</span><span class='line'>             <span class="o">[</span> <span class="s2">&quot;$(RC_RELEASE)&quot;</span> <span class="o">=</span> <span class="s2">&quot;Northstar&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span> <span class="se">\</span>
</span><span class='line'>                <span class="nb">echo</span> <span class="s2">&quot;&quot;</span> <span class="p">;</span> <span class="se">\ </span>
</span></code></pre></td></tr></table></div></figure>


<p>A lot of familiar cats here, along with a couple of early iOS versions (SugarBowl, BigBear) and a lot of names I’m not familiar with. (Please leave a comment if you have any insight!) As far as I know “Vail” was the Mac LC III from 1993 with no NeXT connection, but I’m sure it must be referring to something else.</p>

<p>From elsewhere in the tree, there’s code to support various CPU architectures. Aside from the usual suspects (PPC, i386), there are some other interesting finds:</p>

<ul>
<li>HP/PA, aka PA-RISC, a CPU family from HP; some versions of NeXTSTEP were shipped for this</li>
<li>i860, an Intel CPU used in the NeXTdimension graphics board for NeXT’s computers</li>
<li>M680000, the classic Motorola CPU family, used in the original NeXT computers</li>
<li>M880000, a Motorola CPU family; NeXT considered using this in their original hardware but never shipped a product using it</li>
<li>SPARC, a CPU family from Sun; some versions of NeXTSTEP were shipped for this</li>
</ul>


<p>I find it fascinating that, even now, cctools still carries the (presumably unmaintained) code for all of these architectures Apple no longer uses.</p>
<div class="footnotes">
<hr/>
<ol>
<li id="fn:1">
<p>Apple’s equivalent of binutils.<a href="#fnref:1" rev="footnote">&#8617;</a></p></li>
</ol>
</div>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2013/04/04/tigers-which-is-terrible/">Tiger’s `which` Is Terrible; or, Necessity Is the Mother of Invention</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2013-04-04T07:11:00-07:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>4</span><span class='date-suffix'>th</span>, <span class='date-year'>2013</span></span> <span class='time'>7:11 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>One of the most useful things about running software in unusual configurations is that sometimes it exposes unexpected flaws you never knew you had.</p>

<p>The <code>which</code> utility is one of those commandline niceties you never really think about until it’s not there anymore. While sometimes implemented as a shell builtin<sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup>, it’s also frequently shipped as a standalone utility. Apple’s modern version, which is part of the shell_utils package and crystallized around Snow Leopard, works like this:</p>

<ul>
<li>If the specified tool is found on the path, prints the path to the first version found (e.g., the one the shell would execute), and exits 0.</li>
<li>If the specified tool isn’t found, prints a newline and exits 1.</li>
</ul>


<p>This version of the tool is really useful in shell scripts to determine a) if a program is present, and b) where it’s located, and until fairly recently Homebrew used it extensively. Unfortunately, early on in my work on Tigerbrew, I discovered that Tiger’s version was… deficient. It works like this:</p>

<ul>
<li>If the specified tool is found on the path, prints the path to the first version found, and exits 0.</li>
<li>If the specified tool isn’t found, prints a verbose message to stdout, and exits 0.</li>
</ul>


<p>The lack of a meaningful exit status and the error message on stdout are both pretty poor behaviour for a CLI app, and broke Homebrew’s assumptions about how it should work.</p>

<p>To work around this, I replaced Homebrew’s wrapper function with a two-line native Ruby method for Tigerbrew, like so:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">which</span> <span class="n">cmd</span>
</span><span class='line'>  <span class="n">dir</span> <span class="o">=</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;PATH&#39;</span><span class="o">].</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">find</span> <span class="p">{</span><span class="o">|</span><span class="nb">p</span><span class="o">|</span> <span class="no">File</span><span class="o">.</span><span class="n">executable?</span> <span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">p</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)}</span>
</span><span class='line'>  <span class="no">Pathname</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span> <span class="n">cmd</span><span class="p">))</span> <span class="k">unless</span> <span class="n">dir</span><span class="o">.</span><span class="n">nil?</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>As it turns out, not only does it work better on Tiger, but this method is actually faster<sup id="fnref:2"><a href="#fn:2" rel="footnote">2</a></sup> than shelling out like Homebrew did; process spawning is relatively expensive. As a result, I ended up using the new helper in Homebrew even though it wasn’t strictly necessary.</p>

<p>(And as for the commandline utility, Tigerbrew has a formula for the <a href="https://github.com/mistydemeo/tigerbrew/blob/master/Library/Formula/shell_cmds.rb">shell_cmds</a> collection of utilities.)</p>
<div class="footnotes">
<hr/>
<ol>
<li id="fn:1">
<p>zsh does; bash doesn’t.<a href="#fnref:1" rev="footnote">&#8617;</a></p></li>
<li id="fn:2">
<p>On the millisecond scale, at least.<a href="#fnref:2" rev="footnote">&#8617;</a></p></li>
</ol>
</div>

</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/posts/2">&larr; Older</a>
    
    <a href="/blog/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/blog/2015/06/21/release-asuka-120-percent-limit-over-english-translation/">Release: Asuka 120% Limit Over English Translation</a>
      </li>
    
      <li class="post">
        <a href="/blog/blog/2015/05/16/attack-the-vector/">Attack the Vector</a>
      </li>
    
      <li class="post">
        <a href="/blog/blog/2015/05/02/reevaluate/">Reevaluate</a>
      </li>
    
      <li class="post">
        <a href="/blog/blog/2015/01/02/widescreen-gaming-in-the-90s/">Widescreen Gaming in the 90s</a>
      </li>
    
      <li class="post">
        <a href="/blog/blog/2014/12/05/homebrew-gcc-changes-coming/">Homebrew GCC Changes Coming</a>
      </li>
    
  </ul>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - Misty De Meo -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
